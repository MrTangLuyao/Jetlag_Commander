<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JETLAG COMMANDER // V6.3</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/luxon/3.4.4/luxon.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');

    body {
      font-family: 'JetBrains Mono', monospace;
      background-color: #020617;
      color: #e2e8f0;
    }

    .radio-hidden {
      position: absolute;
      opacity: 0;
      width: 0;
      height: 0;
    }

    .strategy-card {
      cursor: pointer;
      background-color: #0f172a;
      border: 1px solid #334155;
      padding: 1.5rem;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      transition: all 0.2s ease-in-out;
      position: relative;
    }

    .strategy-card:hover {
      background-color: #1e293b;
      border-color: #475569;
    }

    .radio-hidden:checked+.strategy-card {
      background-color: #064e3b;
      border-color: #10b981;
      box-shadow: 0 0 0 1px #10b981 inset;
    }

    .radio-hidden:checked+.strategy-card::after {
      content: 'SELECTED';
      position: absolute;
      top: 0;
      right: 0;
      background: #10b981;
      color: #000;
      font-size: 0.7rem;
      font-weight: bold;
      padding: 2px 6px;
    }

    .hard-card {
      background-color: #0f172a;
      border: 1px solid #334155;
      border-radius: 0;
    }

    .sleep-border {
      border-left: 4px solid #3b82f6;
    }

    .wake-border {
      border-left: 4px solid #f97316;
    }

    .input-group {
      display: flex;
      border: 1px solid #334155;
      background: #020617;
    }

    .input-group input {
      flex: 1;
      background: transparent;
      color: #f8fafc;
      border: none;
      padding: 14px;
      font-family: inherit;
      font-size: 0.9rem;
    }

    .input-group select {
      width: 140px;
      background: #1e293b;
      color: #94a3b8;
      border: none;
      border-left: 1px solid #334155;
      padding-left: 10px;
      font-size: 0.75rem;
    }
  </style>
</head>

<body class="min-h-screen p-4 md:p-8 flex justify-center items-start">

  <div class="w-full max-w-5xl space-y-8">

    <div class="border-b border-slate-800 pb-6 flex justify-between items-start">
      <div>
        <h1 class="text-3xl font-bold text-emerald-500 tracking-tighter uppercase">Jetlag_Commander <span
            class="text-slate-600 text-sm ml-2">V6.3</span></h1>
        <p class="text-xs text-slate-500 mt-2">CIRCADIAN RHYTHM OVERRIDE PROTOCOL</p>
      </div>
      <button id="langBtn" onclick="toggleLanguage()"
        class="text-xs border border-slate-700 rounded px-3 py-1 text-slate-500 hover:text-emerald-500 hover:border-emerald-500 transition-colors font-bold tracking-wider">
        EN / ä¸­
      </button>
    </div>

    <div class="space-y-8">

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="space-y-2">
          <label class="text-xs font-bold text-slate-500 uppercase" data-i18n="step1">Step 1: ä¸Šä¸€æ¬¡å…¥ç¡ (Start)</label>
          <div class="input-group">
            <input type="datetime-local" id="sleepTime">
            <select id="sleepZone"></select>
          </div>
        </div>
        <div class="space-y-2">
          <label class="text-xs font-bold text-slate-500 uppercase" data-i18n="step2">Step 2: ä¸Šä¸€æ¬¡å”¤é†’ (End)</label>
          <div class="input-group">
            <input type="datetime-local" id="wakeTime">
            <select id="wakeZone"></select>
          </div>
        </div>
      </div>

      <div class="space-y-2">
        <label class="text-xs font-bold text-emerald-600 uppercase" data-i18n="step3">Step 3: ç›®æ ‡æ—¶åŒº (Target)</label>
        <select id="targetZone"
          class="w-full bg-slate-900 border border-emerald-900 text-emerald-500 p-4 text-sm focus:outline-none focus:border-emerald-500"></select>
      </div>

      <div class="space-y-2 pt-4 border-t border-slate-800">
        <label class="text-xs font-bold text-white uppercase mb-2 block" data-i18n="step4">Step 4: é€‰æ‹©ç®—æ³•æ¨¡å‹
          (Algorithm)</label>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

          <label>
            <input type="radio" name="strategy" value="aggressive" class="radio-hidden" onchange="toggleCustom()">
            <div class="strategy-card">
              <div>
                <div class="text-red-400 font-bold text-sm mb-1" data-i18n="strat_agg_title">âš¡ï¸ æš´åŠ›æŠ˜ä¸­ (Single Day)</div>
                <div class="text-xs text-slate-400" data-i18n="strat_agg_desc">å•æ¬¡å¼ºåŠ›å¤ä½ã€‚å–â€œç”Ÿç†æƒ¯æ€§â€ä¸â€œç›®æ ‡æ—¶é—´â€çš„å‡ ä½•ä¸­å¿ƒç‚¹ã€‚ä¸ç»™èº«ä½“ç•™é€€è·¯ã€‚
                </div>
              </div>
            </div>
          </label>

          <label>
            <input type="radio" name="strategy" value="smart_even" class="radio-hidden" checked
              onchange="toggleCustom()">
            <div class="strategy-card">
              <div>
                <div class="text-blue-400 font-bold text-sm mb-1" data-i18n="strat_even_title">âš–ï¸ æ™ºèƒ½å‡åˆ† (Linear)</div>
                <div class="text-xs text-slate-400" data-i18n="strat_even_desc">ä¼ ç»Ÿç¨³å¥æ–¹æ¡ˆã€‚å°†æ€»æ—¶å·®å¹³å‡åˆ†é…ã€‚æ¯å¤©ç§»åŠ¨å›ºå®šæ­¥é•¿ (å¦‚ 2h/å¤©)ã€‚</div>
              </div>
            </div>
          </label>

          <label>
            <input type="radio" name="strategy" value="smart_fold" class="radio-hidden" onchange="toggleCustom()">
            <div class="strategy-card">
              <div>
                <div class="text-emerald-400 font-bold text-sm mb-1" data-i18n="strat_fold_title">ğŸ§¬ æ™ºèƒ½æŠ˜ä¸­ (Max 4 Days)
                </div>
                <div class="text-xs text-slate-400" data-i18n="strat_fold_desc">é«˜æ•ˆæ”¶æ•›ã€‚æ¯å¤©æ¶ˆé™¤ 50% æ—¶å·®ã€‚å¼ºåˆ¶åœ¨ç¬¬4å¤©å†…å®Œæˆï¼Œè‹¥æœªè¾¾æ ‡åˆ™è§¦å‘å¼ºåˆ¶å¸é™„ã€‚
                </div>
              </div>
            </div>
          </label>

          <label>
            <input type="radio" name="strategy" value="custom" class="radio-hidden" onchange="toggleCustom()">
            <div class="strategy-card">
              <div>
                <div class="text-slate-300 font-bold text-sm mb-1" data-i18n="strat_custom_title">ğŸ›  è‡ªå®šä¹‰å‘¨æœŸ (Custom)
                </div>
                <div class="text-xs text-slate-400" data-i18n="strat_custom_desc">æ‰‹åŠ¨æŒ‡å®šå¤©æ•°ã€‚</div>
              </div>
              <div id="customInput" class="hidden mt-3 pt-3 border-t border-slate-700">
                <input type="number" id="customDays" value="4"
                  class="w-20 bg-black border border-slate-600 p-1 text-center text-xs text-white" min="2" max="10">
                <span class="text-xs text-slate-500 ml-2">Days</span>
              </div>
            </div>
          </label>
        </div>
      </div>

      <button onclick="execute()"
        class="w-full bg-emerald-700 hover:bg-emerald-600 text-white font-bold py-5 text-sm uppercase tracking-widest transition-colors shadow-[0_0_20px_rgba(16,185,129,0.2)]"
        data-i18n="btn_execute">
        ç”Ÿæˆå¼ºåˆ¶æŒ‡ä»¤ (EXECUTE)
      </button>
    </div>

    <div id="resultArea" class="hidden space-y-6 pt-6 border-t border-slate-800">
      <div class="flex justify-between items-end border-b border-slate-800 pb-2">
        <h2 class="text-emerald-500 font-bold text-sm uppercase tracking-widest">Mission Protocol</h2>
        <span id="offsetBadge"
          class="text-xs bg-slate-900 text-slate-400 px-2 py-1 font-mono border border-slate-700">OFFSET: --</span>
      </div>

      <div id="timeline" class="space-y-4"></div>
    </div>
  </div>

  <script>
    const DateTime = luxon.DateTime;

    const translations = {
      zh: {
        step1: "Step 1: ä¸Šä¸€æ¬¡å…¥ç¡ (Start)",
        step2: "Step 2: ä¸Šä¸€æ¬¡å”¤é†’ (End)",
        step3: "Step 3: ç›®æ ‡æ—¶åŒº (Target)",
        step4: "Step 4: é€‰æ‹©ç®—æ³•æ¨¡å‹ (Algorithm)",
        strat_agg_title: "âš¡ï¸ æš´åŠ›æŠ˜ä¸­ (Single Day)",
        strat_agg_desc: "å•æ¬¡å¼ºåŠ›å¤ä½ã€‚å–â€œç”Ÿç†æƒ¯æ€§â€ä¸â€œç›®æ ‡æ—¶é—´â€çš„å‡ ä½•ä¸­å¿ƒç‚¹ã€‚ä¸ç»™èº«ä½“ç•™é€€è·¯ã€‚",
        strat_even_title: "âš–ï¸ æ™ºèƒ½å‡åˆ† (Linear)",
        strat_even_desc: "ä¼ ç»Ÿç¨³å¥æ–¹æ¡ˆã€‚å°†æ€»æ—¶å·®å¹³å‡åˆ†é…ã€‚æ¯å¤©ç§»åŠ¨å›ºå®šæ­¥é•¿ (å¦‚ 2h/å¤©)ã€‚",
        strat_fold_title: "ğŸ§¬ æ™ºèƒ½æŠ˜ä¸­ (Max 4 Days)",
        strat_fold_desc: "é«˜æ•ˆæ”¶æ•›ã€‚æ¯å¤©æ¶ˆé™¤ 50% æ—¶å·®ã€‚å¼ºåˆ¶åœ¨ç¬¬4å¤©å†…å®Œæˆï¼Œè‹¥æœªè¾¾æ ‡åˆ™è§¦å‘å¼ºåˆ¶å¸é™„ã€‚",
        strat_custom_title: "ğŸ›  è‡ªå®šä¹‰å‘¨æœŸ (Custom)",
        strat_custom_desc: "æ‰‹åŠ¨æŒ‡å®šå¤©æ•°ã€‚",
        btn_execute: "ç”Ÿæˆå¼ºåˆ¶æŒ‡ä»¤ (EXECUTE)",
        hard_reset: "HARD RESET",
        desc_agg: "å¼ºåˆ¶æŠ˜ä¸­ï¼šå–ç”Ÿç†æƒ¯æ€§ä¸ç›®æ ‡æ—¶é—´çš„å‡ ä½•ä¸­å¿ƒç‚¹ã€‚",
        day_prefix: "DAY",
        desc_even: "çº¿æ€§å‡åˆ†ï¼šæ¯æ—¥è°ƒæ•´",
        desc_fold_success: "âœ… åŒºé—´è¾¾æ ‡ (20:00-23:00)ã€‚æå‰å®Œæˆã€‚",
        desc_fold_adjust: "ğŸ”„ æŠ˜ä¸­æ”¶æ•›ï¼šç›¸ä½è°ƒæ•´",
        desc_fold_force: "âš ï¸ ç¬¬4å¤©å¼ºåˆ¶æ‰§è¡Œï¼šç³»ç»Ÿæ¥ç®¡ï¼Œé”å®šæœ€ç»ˆä½œæ¯ã€‚",
        label_sleep: "Sleep At (å…¥ç¡)",
        label_wake: "Wake At (å”¤é†’)"
      },
      en: {
        step1: "Step 1: Last Sleep (Start)",
        step2: "Step 2: Last Wake (End)",
        step3: "Step 3: Target Zone (Target)",
        step4: "Step 4: Select Algorithm (Algorithm)",
        strat_agg_title: "âš¡ï¸ Aggressive Fold (Single Day)",
        strat_agg_desc: "Single-day hard reset. Targets geometric midpoint of 'sleep inertia' and 'target time'. No retreat.",
        strat_even_title: "âš–ï¸ Smart Linear",
        strat_even_desc: "Conservative approach. Distributes total offset evenly. Fixed daily shift (e.g., 2h/day).",
        strat_fold_title: "ğŸ§¬ Smart Fold (Max 4 Days)",
        strat_fold_desc: "Efficient convergence. Eliminates 50% offset daily. Force complete by Day 4, snaps to schedule if target not met.",
        strat_custom_title: "ğŸ›  Custom Cycle (Custom)",
        strat_custom_desc: "Manually specify duration.",
        btn_execute: "GENERATE COMMAND (EXECUTE)",
        hard_reset: "HARD RESET",
        desc_agg: "Forced Fold: Geometric midpoint of inertia and target.",
        day_prefix: "DAY",
        desc_even: "Linear Even: Daily shift",
        desc_fold_success: "âœ… Target Met (20:00-23:00). Completed early.",
        desc_fold_adjust: "ğŸ”„ Fold Convergence: Phase shift",
        desc_fold_force: "âš ï¸ Day 4 Override: System takeover, final schedule locked.",
        label_sleep: "Sleep At",
        label_wake: "Wake At"
      }
    };

    let currentLang = 'zh';

    function initLanguage() {
      const browserLang = navigator.language || navigator.userLanguage;
      if (browserLang.startsWith('zh')) {
        currentLang = 'zh';
      } else {
        currentLang = 'en';
      }
      applyLanguage();
    }

    function toggleLanguage() {
      currentLang = currentLang === 'zh' ? 'en' : 'zh';
      applyLanguage();
    }

    function applyLanguage() {
      const t = translations[currentLang];

      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (t[key]) {
          if (key.includes('desc')) {
            let formattedText = t[key].replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            el.innerHTML = formattedText;
          } else {
            el.innerText = t[key];
          }
        }
      });

      const btn = document.getElementById('langBtn');
      btn.innerText = currentLang === 'zh' ? 'EN / ä¸­' : 'CN / EN';

      if (!document.getElementById('resultArea').classList.contains('hidden')) {
        execute();
      }
    }

    const commonTimezones = [
      "Asia/Shanghai", "Asia/Tokyo", "Asia/Singapore", "Asia/Dubai",
      "Australia/Melbourne", "Australia/Sydney",
      "Europe/London", "Europe/Paris", "Europe/Berlin",
      "America/New_York", "America/Los_Angeles"
    ];

    const populate = (id, def) => {
      const el = document.getElementById(id);
      commonTimezones.sort().forEach(tz => el.add(new Option(tz, tz)));
      const userZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
      if (!commonTimezones.includes(userZone)) el.add(new Option(userZone, userZone));
      el.value = def || userZone;
    };

    populate('sleepZone', Intl.DateTimeFormat().resolvedOptions().timeZone);
    populate('wakeZone', Intl.DateTimeFormat().resolvedOptions().timeZone);
    populate('targetZone', "Asia/Shanghai");

    const now = DateTime.now();
    document.getElementById('sleepTime').value = now.minus({ hours: 8 }).toFormat("yyyy-MM-dd'T'HH:mm");
    document.getElementById('wakeTime').value = now.toFormat("yyyy-MM-dd'T'HH:mm");

    initLanguage();

    function toggleCustom() {
      const mode = document.querySelector('input[name="strategy"]:checked').value;
      document.getElementById('customInput').classList.toggle('hidden', mode !== 'custom');
    }

    function execute() {
      const t = translations[currentLang];

      const sTime = document.getElementById('sleepTime').value;
      const sZone = document.getElementById('sleepZone').value;
      const wTime = document.getElementById('wakeTime').value;
      const wZone = document.getElementById('wakeZone').value;
      const tZone = document.getElementById('targetZone').value;
      const strategy = document.querySelector('input[name="strategy"]:checked').value;

      if (!sTime || !wTime) return alert("System Error: Check inputs.");

      const lastSleep = DateTime.fromISO(sTime, { zone: sZone });
      const lastWake = DateTime.fromISO(wTime, { zone: wZone });

      const wakeInTarget = lastWake.setZone(tZone);
      let idealWake = wakeInTarget.set({ hour: 7, minute: 0, second: 0 });

      let diff = idealWake.diff(wakeInTarget, 'hours').hours;
      if (diff > 12) diff -= 24; else if (diff < -12) diff += 24;

      let plan = [];

      if (strategy === 'aggressive') {
        const naturalBedtime = wakeInTarget.plus({ hours: 16 });
        let targetBedtime = naturalBedtime.set({ hour: 23, minute: 0 });

        if (targetBedtime.diff(naturalBedtime, 'hours').hours > 12) targetBedtime = targetBedtime.minus({ days: 1 });
        else if (targetBedtime.diff(naturalBedtime, 'hours').hours < -12) targetBedtime = targetBedtime.plus({ days: 1 });

        const diffMillis = targetBedtime.diff(naturalBedtime).toMillis();
        const midpointBedtime = naturalBedtime.plus({ milliseconds: diffMillis * 0.5 });

        plan.push({
          day: t.hard_reset,
          sleepTime: midpointBedtime,
          wakeTime: midpointBedtime.plus({ hours: 8 }),
          desc: t.desc_agg
        });
      }

      else if (strategy === 'smart_even' || strategy === 'custom') {
        let days = 3;
        if (strategy === 'custom') days = parseInt(document.getElementById('customDays').value);
        const step = diff / days;

        for (let i = 1; i <= days; i++) {
          let dayWake = wakeInTarget.plus({ hours: 24 * i + (step * i) });
          let daySleep = dayWake.minus({ hours: 8 });
          plan.push({
            day: `${t.day_prefix} ${i}/${days}`,
            sleepTime: daySleep,
            wakeTime: dayWake,
            desc: `${t.desc_even} ${step.toFixed(1)}h`
          });
        }
      }

      else if (strategy === 'smart_fold') {
        let currentVirtualWake = wakeInTarget;
        const maxDays = 4;
        let isComplete = false;

        for (let i = 1; i <= maxDays; i++) {
          let currentIdeal = currentVirtualWake.set({ hour: 7, minute: 0 });
          let phaseDiff = currentIdeal.diff(currentVirtualWake, 'hours').hours;
          if (phaseDiff > 12) phaseDiff -= 24; else if (phaseDiff < -12) phaseDiff += 24;

          let move = phaseDiff * 0.5;
          let nextWake = currentVirtualWake.plus({ hours: 24 + move });
          let nextSleep = nextWake.minus({ hours: 8 });

          let sleepHour = nextSleep.hour;
          let success = (sleepHour >= 20 && sleepHour < 23);
          let desc = `${t.desc_fold_adjust} ${move.toFixed(1)}h (50%)`;

          if (i === maxDays && !success) {
            let snappedSleep = nextSleep.set({ minute: 0 });
            if (sleepHour < 20 && sleepHour > 6) {
              snappedSleep = snappedSleep.set({ hour: 20 });
            } else {
              snappedSleep = snappedSleep.set({ hour: 23 });
            }
            nextSleep = snappedSleep;
            nextWake = nextSleep.plus({ hours: 8 });
            success = true;
            desc = t.desc_fold_force;
          } else if (success) {
            desc = t.desc_fold_success;
          }

          plan.push({
            day: `${t.day_prefix} ${i}`,
            sleepTime: nextSleep,
            wakeTime: nextWake,
            desc: desc
          });

          if (success) break;
          currentVirtualWake = nextWake;
        }
      }

      const container = document.getElementById('timeline');
      container.innerHTML = "";
      document.getElementById('resultArea').classList.remove('hidden');
      document.getElementById('offsetBadge').innerText = `OFFSET: ${diff.toFixed(1)}H`;

      plan.forEach(item => {
        const row = document.createElement('div');
        row.className = "hard-card p-6";

        row.innerHTML = `
                    <div class="flex justify-between items-center mb-6 border-b border-slate-800 pb-2">
                        <span class="text-xs font-bold text-slate-400 bg-slate-950 border border-slate-800 px-2 py-1">${item.day}</span>
                        <span class="text-xs text-emerald-500 font-mono">${item.desc}</span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="sleep-border bg-slate-950 p-4 pl-5">
                            <p class="text-xs text-blue-500 font-bold mb-2 uppercase tracking-wider">${t.label_sleep}</p>
                            <p class="text-3xl font-bold text-white font-mono">${item.sleepTime.toFormat('HH:mm')}</p>
                            <p class="text-xs text-slate-500 mt-1">${item.sleepTime.toFormat('MM-dd (cccc)')}</p>
                        </div>
                        <div class="wake-border bg-slate-950 p-4 pl-5">
                            <p class="text-xs text-orange-500 font-bold mb-2 uppercase tracking-wider">${t.label_wake}</p>
                            <p class="text-3xl font-bold text-white font-mono">${item.wakeTime.toFormat('HH:mm')}</p>
                            <p class="text-xs text-slate-500 mt-1">${item.wakeTime.toFormat('MM-dd (cccc)')}</p>
                        </div>
                    </div>
                `;
        container.appendChild(row);
      });
    }
  </script>
</body>

</html>