<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>JETLAG COMMANDER // v11.6.0 // OFFLINE_EDITION</title>
  <script src="lib/tailwindcss.js"></script>
  <script src="lib/luxon.min.js"></script>
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']]
      },
      startup: {
        typeset: false
      }
    };
  </script>
  <script id="MathJax-script" async src="lib/mathjax/tex-mml-chtml.js"></script>

  <style>
    /* -----------------------
       FONT & RESET
       ----------------------- */
    @font-face {
      font-family: 'JetBrains Mono';
      src: url('lib/JetBrainsMono-Bold.woff2') format('woff2');
      font-weight: normal;
      font-style: normal;
    }

    body {
      font-family: 'JetBrains Mono', "Microsoft YaHei", "PingFang SC", "Helvetica Neue", Helvetica, Arial, sans-serif;
      background-color: #020617;
      color: #e2e8f0;
      overflow-x: hidden;
      -webkit-tap-highlight-color: transparent;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      font-weight: 400;
    }

    input,
    select,
    button {
      outline: none;
    }

    /* -----------------------
       ANIMATIONS
       ----------------------- */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes cyberPulseBlue {
      0% {
        box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4);
      }

      70% {
        box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
      }

      100% {
        box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
      }
    }

    @keyframes cyberPulseYellow {
      0% {
        box-shadow: 0 0 0 0 rgba(250, 204, 21, 0.5);
      }

      70% {
        box-shadow: 0 0 0 15px rgba(250, 204, 21, 0);
      }

      100% {
        box-shadow: 0 0 0 0 rgba(250, 204, 21, 0);
      }
    }

    .strategy-card,
    .input-stack,
    .dir-btn,
    .q-btn {
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .strategy-card:active,
    .input-stack:active,
    .dir-btn:active,
    .q-btn:active {
      transform: scale(0.98);
    }

    /* -----------------------
       INPUT SYSTEM
       ----------------------- */
    .input-stack {
      position: relative;
      flex: 1;
      height: 50px;
      background: #1e293b;
      border: 1px solid #334155;
      cursor: pointer;
    }

    body.mode-overlay .input-stack .display-layer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #f8fafc;
      font-weight: bold;
      text-transform: uppercase;
      font-size: 1rem;
      pointer-events: none;
      z-index: 1;
    }

    body.mode-overlay .input-stack .hybrid-input {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      z-index: 10;
      cursor: pointer;
      border: none;
    }

    body.mode-compat .input-stack .display-layer {
      display: none !important;
    }

    body.mode-compat .input-stack .hybrid-input {
      position: relative;
      width: 100%;
      height: 100%;
      opacity: 1 !important;
      background: #1e293b;
      color: white;
      border: none;
      text-align: center;
      font-family: inherit;
      font-weight: bold;
      font-size: 1rem;
      cursor: text;
      color-scheme: dark;
    }

    .compat-active {
      border-color: #facc15 !important;
      color: #facc15 !important;
      background: rgba(250, 204, 21, 0.1) !important;
    }

    /* -----------------------
       LAYOUT & UI
       ----------------------- */
    .view-section {
      display: none;
      opacity: 0;
    }

    .view-section.active {
      display: block;
      animation: fadeInUp 0.5s cubic-bezier(0.22, 1, 0.36, 1) forwards;
    }

    .split-input-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
      background: #020617;
      border: 1px solid #334155;
      padding: 12px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .row-main {
      display: flex;
      gap: 8px;
      width: 100%;
    }

    .row-zone {
      width: 100%;
    }

    .zone-select {
      width: 100%;
      height: 40px;
      background: #0f172a;
      border: 1px solid #334155;
      color: #94a3b8;
      font-size: 0.8rem;
      padding: 0 12px;
      text-align: center;
      border-radius: 0;
    }

    .zone-select:focus {
      border-color: #3b82f6;
    }

    .ampm-toggle {
      background: #0f172a;
      border: 1px solid #334155;
      color: #64748b;
      cursor: pointer;
      font-weight: bold;
      width: 60px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      flex: none;
    }

    .ampm-toggle.am-active {
      background: #facc15;
      color: #000;
      border-color: #facc15;
    }

    .ampm-toggle.pm-active {
      background: #3b82f6;
      color: #fff;
      border-color: #3b82f6;
    }

    .header-btn {
      text-transform: uppercase;
      font-size: 10px;
      border: 1px solid #334155;
      background: #0f172a;
      border-radius: 4px;
      padding: 4px 8px;
      color: #94a3b8;
      font-weight: bold;
      letter-spacing: 0.05em;
      transition: all 0.2s;
    }

    .header-btn:hover {
      color: #3b82f6;
      border-color: #3b82f6;
    }

    .radio-hidden {
      position: absolute;
      opacity: 0;
      width: 0;
      height: 0;
    }

    .q-label {
      flex: 1;
      display: flex;
    }

    .q-btn {
      position: relative;
      background-color: #0f172a;
      border: 1px solid #334155;
      padding: 1.5rem 0.5rem;
      text-align: center;
      cursor: pointer;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100px;
      height: 100%;
    }

    .q-btn:hover {
      background-color: #1e293b;
      border-color: #475569;
    }

    .q-btn-title {
      font-weight: bold;
      font-size: 1rem;
      margin-bottom: 0.25rem;
      color: #e2e8f0;
    }

    .q-btn-sub {
      font-size: 0.75rem;
      color: #64748b;
    }

    .radio-hidden:checked+.q-btn {
      background-color: #1e3a8a;
      border-color: #60a5fa;
      color: white;
    }

    .radio-hidden:checked+.q-btn .q-btn-title {
      color: #ffffff;
    }

    .radio-hidden:checked+.q-btn .q-btn-sub {
      color: #bfdbfe;
    }

    .radio-hidden:checked+.q-btn::after {
      content: 'SELECTED';
      position: absolute;
      top: 0;
      right: 0;
      background: #60a5fa;
      color: #0f172a;
      font-size: 0.65rem;
      font-weight: bold;
      padding: 2px 6px;
    }

    .days-input {
      background: #000;
      border: 1px solid #475569;
      color: white;
      width: 50px;
      text-align: center;
      padding: 6px;
      font-size: 0.9rem;
      margin: 0 8px;
    }

    .days-input:focus {
      border-color: #3b82f6;
    }

    .action-btn {
      width: 100%;
      background-color: #2563eb;
      color: white;
      font-weight: bold;
      padding: 1.25rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      transition: all 0.2s;
      animation: cyberPulseBlue 3s infinite;
      margin-top: 1rem;
    }

    .action-btn:hover {
      background-color: #3b82f6;
      animation: none;
      transform: translateY(-1px);
    }

    .action-btn:active {
      transform: scale(0.98);
    }

    .info-trigger {
      font-size: 0.7rem;
      color: #475569;
      text-decoration: none;
      margin-left: 8px;
      cursor: pointer;
      border: 1px solid #334155;
      padding: 2px 6px;
      border-radius: 4px;
      transition: all 0.2s;
      display: inline-block;
    }

    .info-trigger:hover {
      color: #facc15;
      border-color: #facc15;
    }

    .hard-card {
      background-color: #0f172a;
      border: 1px solid #334155;
    }

    .sleep-border {
      border-left: 4px solid #3b82f6;
    }

    .wake-border {
      border-left: 4px solid #facc15;
    }

    .display-select {
      background-color: #0f172a;
      color: #3b82f6;
      border: 1px solid #334155;
      font-size: 0.75rem;
      padding: 4px 8px;
    }

    .kb-header {
      color: #3b82f6;
      font-weight: bold;
      font-size: 0.8rem;
      border-bottom: 1px solid #334155;
      padding-bottom: 0.5rem;
      margin-bottom: 1rem;
    }

    .kb-title {
      color: #fff;
      font-weight: bold;
      margin-bottom: 0.5rem;
      font-size: 1.1rem;
    }

    .kb-text {
      color: #94a3b8;
      font-size: 0.85rem;
      line-height: 1.6;
      margin-bottom: 1.5rem;
    }

    .anim-stagger {
      opacity: 0;
      animation: fadeInUp 0.5s cubic-bezier(0.22, 1, 0.36, 1) forwards;
    }

    .flow-container {
      display: none;
    }

    .flow-container.active-flow {
      display: block;
      animation: fadeInUp 0.3s forwards;
    }

    .math-block {
      background: #0f172a;
      border: 1px solid #334155;
      padding: 1.25rem;
      border-radius: 6px;
      margin-bottom: 1rem;
    }

    .math-title {
      color: #facc15;
      font-weight: bold;
      font-size: 0.95rem;
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      border-bottom: 1px solid #1e293b;
      padding-bottom: 6px;
    }

    .math-desc {
      color: #94a3b8;
      font-size: 0.85rem;
    }

    .math-formula {
      padding: 10px 0;
      display: flex;
      justify-content: center;
      background: #020617;
      border-radius: 4px;
      margin: 10px 0;
    }
  </style>
</head>

<body class="min-h-screen flex flex-col items-center justify-start pt-4 pb-12 px-4 md:pt-12">

  <div class="w-full max-w-6xl relative">
    <div class="flex justify-between items-start mb-4 border-b border-slate-800 pb-4 w-full">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold text-blue-500 tracking-tighter uppercase">JETLAG_COMMANDER <span
            class="text-slate-500 text-[10px] md:text-xs ml-1 align-bottom font-mono">v11.6.0</span></h1>
        <p class="text-[10px] text-slate-500 mt-1 tracking-widest">CIRCADIAN RHYTHM OVERRIDE PROTOCOL</p>
      </div>
      <div class="flex gap-2">
        <button id="licenseBtn" onclick="goToView('view-license')" class="header-btn">LICENSES</button>
        <button id="compatBtn" onclick="toggleCompatMode()" class="header-btn">PC</button>
        <button id="langBtn" onclick="toggleLanguage()" class="header-btn">EN / ä¸­</button>
      </div>
    </div>

    <div id="progress-container" class="w-full h-1 bg-slate-900 mb-8 hidden rounded-full overflow-hidden">
      <div id="progress-bar"
        class="h-full bg-blue-500 transition-all duration-700 ease-out w-0 shadow-[0_0_10px_rgba(59,130,246,0.8)]">
      </div>
    </div>

    <div id="view-welcome" class="view-section active text-center py-12 max-w-2xl mx-auto">
      <div class="text-6xl mb-6 animate-bounce">ğŸ‰</div>
      <h2 class="text-3xl font-bold text-white mb-4 tracking-tight" data-i18n="welcome_title">æ¬¢è¿</h2>
      <p class="text-slate-400 mb-12 px-4 leading-relaxed text-sm md:text-base" data-i18n="welcome_desc">
        Jetlag Commander æ˜¯ä¸€ä¸ªæ™ºèƒ½è°ƒèŠ‚æ—¶å·®çš„ç½‘é¡µ,å¸®åŠ©ä½ ç§‘å­¦çš„å€’æ—¶å·®,åŒ…æ‹¬è·¨å›½é£è¡Œä»¥åŠç†¬å¤œé€ æˆçš„æ—¶å·®ã€‚
      </p>
      <button onclick="goToView(1)" class="action-btn max-w-xs mx-auto" data-i18n="btn_start">GET STARTED -></button>
    </div>

    <div id="view-license" class="view-section max-w-2xl mx-auto pt-4">
      <h2 class="kb-header">COMPLIANCE // OPEN SOURCE LICENSES</h2>
      <div class="space-y-6">
        <div>
          <h4 class="text-white font-bold text-sm mb-2">Tailwind CSS</h4>
          <p class="text-[10px] text-slate-500 font-mono">MIT License | Copyright (c) Tailwind Labs, Inc.</p>
        </div>
        <div>
          <h4 class="text-white font-bold text-sm mb-2">Luxon.js</h4>
          <p class="text-[10px] text-slate-500 font-mono">MIT License | Copyright (c) 2017 Isaac Cambron</p>
        </div>
        <div>
          <h4 class="text-white font-bold text-sm mb-2">JetBrains Mono</h4>
          <p class="text-[10px] text-slate-500 font-mono">SIL Open Font License 1.1 | Copyright (c) 2020 JetBrains
            s.r.o.</p>
        </div>
        <div>
          <h4 class="text-white font-bold text-sm mb-2">MathJax</h4>
          <p class="text-[10px] text-slate-500 font-mono">Apache License 2.0 | Copyright (c) The MathJax Consortium</p>
        </div>
      </div>
      <button onclick="goToView(1)" class="action-btn mt-8 bg-slate-800 hover:bg-slate-700" style="animation: none;"
        data-i18n="btn_return">&lt;&lt; RETURN</button>
    </div>

    <div id="view-inputs" class="view-section max-w-2xl mx-auto">
      <h3 class="text-blue-500 text-xs font-bold uppercase mb-6 tracking-widest border-l-2 border-blue-500 pl-3">Phase
        1: Data Injection</h3>
      <div class="space-y-8">
        <div class="space-y-2">
          <label class="text-xs font-bold text-slate-500 uppercase flex items-center justify-start">
            <span data-i18n="step1">Step 1: ä¸Šä¸€æ¬¡å…¥ç¡æ—¶é—´</span>
            <span class="info-trigger" onclick="goToView('info-sleep')" data-i18n="btn_what">[?] è¿™æ˜¯ä»€ä¹ˆ</span>
          </label>
          <div class="split-input-container">
            <div class="row-main">
              <div class="input-stack">
                <span id="sleepDateDisplay" class="display-layer">-- MMM</span>
                <input type="date" id="sleepDate" class="hybrid-input"
                  oninput="updateDateDisplay(this, 'sleepDateDisplay')">
              </div>
              <div class="input-stack">
                <span id="sleepTimeDisplay" class="display-layer">--:--</span>
                <input type="time" id="sleepTime" class="hybrid-input"
                  oninput="updateTimeDisplay(this, 'sleepTimeDisplay'); syncAMPM('sleepTime', 'sleepAMPM')"
                  onchange="updateTimeDisplay(this, 'sleepTimeDisplay'); syncAMPM('sleepTime', 'sleepAMPM')">
              </div>
              <button id="sleepAMPM" class="ampm-toggle" onclick="toggleAMPM('sleepAMPM')">AM</button>
            </div>
            <div class="row-zone"><select id="sleepZone" class="zone-select"></select></div>
          </div>
        </div>

        <div class="space-y-2">
          <label class="text-xs font-bold text-slate-500 uppercase flex items-center justify-start">
            <span data-i18n="step2">Step 2: ä¸Šä¸€æ¬¡èµ·åºŠæ—¶é—´</span>
            <span class="info-trigger" onclick="goToView('info-wake')" data-i18n="btn_what">[?] è¿™æ˜¯ä»€ä¹ˆ</span>
          </label>
          <div class="split-input-container">
            <div class="row-main">
              <div class="input-stack">
                <span id="wakeDateDisplay" class="display-layer">-- MMM</span>
                <input type="date" id="wakeDate" class="hybrid-input"
                  oninput="updateDateDisplay(this, 'wakeDateDisplay')">
              </div>
              <div class="input-stack">
                <span id="wakeTimeDisplay" class="display-layer">--:--</span>
                <input type="time" id="wakeTime" class="hybrid-input"
                  oninput="updateTimeDisplay(this, 'wakeTimeDisplay'); syncAMPM('wakeTime', 'wakeAMPM')"
                  onchange="updateTimeDisplay(this, 'wakeTimeDisplay'); syncAMPM('wakeTime', 'wakeAMPM')">
              </div>
              <button id="wakeAMPM" class="ampm-toggle" onclick="toggleAMPM('wakeAMPM')">AM</button>
            </div>
            <div class="row-zone"><select id="wakeZone" class="zone-select"></select></div>
          </div>
        </div>

        <div class="space-y-2">
          <label class="text-xs font-bold text-blue-500 uppercase flex items-center justify-start">
            <span data-i18n="step3">Step 3: ç›®æ ‡æ—¶åŒº</span>
            <span class="info-trigger border-slate-700 text-blue-500 hover:text-yellow-400 hover:border-yellow-400"
              onclick="goToView('info-target')" data-i18n="btn_what">[?] è¿™æ˜¯ä»€ä¹ˆ</span>
          </label>
          <select id="targetZone"
            class="w-full bg-slate-900 border border-slate-700 text-blue-400 p-4 text-sm focus:outline-none focus:border-blue-500 rounded-none transition-colors"></select>
        </div>
      </div>

      <div class="flex gap-4 mt-8">
        <button onclick="goToView(0)"
          class="flex-1 bg-slate-800 text-slate-400 font-bold py-4 text-xs uppercase hover:bg-slate-700 transition-colors"
          data-i18n="btn_home">&lt;&lt; HOME</button>
        <button onclick="goToView(2)"
          class="flex-[2] bg-blue-600 text-white font-bold py-4 text-sm uppercase tracking-widest hover:bg-blue-500 shadow-[0_0_20px_rgba(37,99,235,0.3)] transition-all"
          data-i18n="btn_next">ä¸‹ä¸€æ­¥ >></button>
      </div>
    </div>

    <div id="view-strategy" class="view-section max-w-2xl mx-auto">
      <h3 class="text-blue-500 text-xs font-bold uppercase mb-6 tracking-widest border-l-2 border-blue-500 pl-3">Phase
        2: Strategy Logic Tree</h3>
      <div class="flex flex-col gap-8" id="strategy-form">

        <div class="space-y-2" id="q1-container">
          <label class="text-xs font-bold text-white uppercase flex items-center justify-start mb-2">
            <span data-i18n="q1_title">Q1: è°ƒæ•´æ–¹å‘</span>
            <span class="info-trigger" onclick="goToView('info-dir')" data-i18n="btn_what">[?] è¿™æ˜¯ä»€ä¹ˆ</span>
          </label>
          <div class="flex gap-2 flex-col md:flex-row items-stretch">
            <label class="q-label"><input type="radio" name="q1" value="smart" class="radio-hidden"
                onchange="updateFlow()">
              <div class="q-btn"><span class="q-btn-title" data-i18n="q1_1">ğŸ¤– æ™ºèƒ½åˆ¤æ–­</span><span class="q-btn-sub"
                  data-i18n="q1_1s">è‡ªåŠ¨è®¡ç®—æœ€ä¼˜è§£</span></div>
            </label>
            <label class="q-label"><input type="radio" name="q1" value="early" class="radio-hidden"
                onchange="updateFlow()">
              <div class="q-btn"><span class="q-btn-title" data-i18n="q1_2">ğŸ›ï¸ å¼ºåˆ¶æ—©ç¡</span><span class="q-btn-sub"
                  data-i18n="q1_2s">å¼ºè¿«æ—¶é’Ÿå‰ç§»</span></div>
            </label>
            <label class="q-label"><input type="radio" name="q1" value="late" class="radio-hidden"
                onchange="updateFlow()">
              <div class="q-btn"><span class="q-btn-title" data-i18n="q1_3">ğŸ¦‰ å¼ºåˆ¶æ™šç¡</span><span class="q-btn-sub"
                  data-i18n="q1_3s">å¼ºè¿«æ—¶é’Ÿåç§»</span></div>
            </label>
          </div>
        </div>

        <div class="space-y-2 flow-container" id="q2-container">
          <label class="text-xs font-bold text-white uppercase flex items-center justify-start mb-2">
            <span data-i18n="q2_title">Q2: ç¬¬2å¤©æœ‰æ²¡æœ‰å¿…é¡»çŠ¶æ€åœ¨çº¿çš„äº‹ï¼Ÿ</span>
            <span class="info-trigger" onclick="goToView('info-q2')" data-i18n="btn_what">[?] è¿™æ˜¯ä»€ä¹ˆ</span>
          </label>
          <div class="flex gap-2 flex-col md:flex-row items-stretch">
            <label class="q-label"><input type="radio" name="q2" value="urgent" class="radio-hidden"
                onchange="updateFlow()">
              <div class="q-btn"><span class="q-btn-title" data-i18n="q2_1">ğŸ’¼ æœ‰</span><span class="q-btn-sub"
                  data-i18n="q2_1s">ä¸Šç­/è€ƒè¯•/é¢è¯•ç­‰</span></div>
            </label>
            <label class="q-label"><input type="radio" name="q2" value="moderate" class="radio-hidden"
                onchange="updateFlow()">
              <div class="q-btn"><span class="q-btn-title" data-i18n="q2_2">â˜• æœ‰ç‚¹äº‹</span><span class="q-btn-sub"
                  data-i18n="q2_2s">æ²¡é‚£ä¹ˆé‡è¦</span></div>
            </label>
            <label class="q-label"><input type="radio" name="q2" value="none" class="radio-hidden"
                onchange="updateFlow()">
              <div class="q-btn"><span class="q-btn-title" data-i18n="q2_3">ğŸ›‹ï¸ æ²¡æœ‰</span><span class="q-btn-sub"
                  data-i18n="q2_3s">è‡ªç”±æ”¯é…</span></div>
            </label>
          </div>
        </div>

        <div class="space-y-2 flow-container" id="q3-container">
          <label class="text-xs font-bold text-white uppercase flex items-center justify-start mb-2">
            <span data-i18n="q3_title">Q3: ä½ å¸Œæœ›å¤šå¿«è°ƒæ•´æ—¶å·®ï¼Ÿ</span>
            <span class="info-trigger" onclick="goToView('info-q3')" data-i18n="btn_what">[?] è¿™æ˜¯ä»€ä¹ˆ</span>
          </label>
          <div class="flex gap-2 flex-col md:flex-row items-stretch">
            <label class="q-label"><input type="radio" name="q3" value="steady" class="radio-hidden"
                onchange="updateFlow()">
              <div class="q-btn"><span class="q-btn-title" data-i18n="q3_1">ğŸ¢ ç¨³å¥</span><span class="q-btn-sub"
                  data-i18n="q3_1s">æ¯å¤©å˜åŒ–å°ï¼Œå°½é‡èˆ’æœ</span></div>
            </label>
            <label class="q-label"><input type="radio" name="q3" value="standard" class="radio-hidden"
                onchange="updateFlow()">
              <div class="q-btn"><span class="q-btn-title" data-i18n="q3_2">ğŸš¶ æ ‡å‡†</span><span class="q-btn-sub"
                  data-i18n="q3_2s">æŠ˜ä¸­</span></div>
            </label>
            <label class="q-label"><input type="radio" name="q3" value="aggressive" class="radio-hidden"
                onchange="updateFlow()">
              <div class="q-btn"><span class="q-btn-title" data-i18n="q3_3">ğŸš€ æ¿€è¿›</span><span class="q-btn-sub"
                  data-i18n="q3_3s">ä¼˜å…ˆé€Ÿåº¦</span></div>
            </label>
          </div>
        </div>

        <div class="space-y-2 flow-container" id="q4-container">
          <label class="text-xs font-bold text-white uppercase flex items-center justify-start mb-2">
            <span data-i18n="q4_title">Q4: èƒ½æ¥å—â€œä¸ºäº†åŠ é€Ÿè€Œå°‘ç¡/çŸ­ç¡â€å—ï¼Ÿ</span>
            <span class="info-trigger" onclick="goToView('info-q4')" data-i18n="btn_what">[?] è¿™æ˜¯ä»€ä¹ˆ</span>
          </label>
          <div class="flex gap-2 flex-col md:flex-row items-stretch">
            <label class="q-label"><input type="radio" name="q4" value="no" class="radio-hidden"
                onchange="updateFlow()">
              <div class="q-btn"><span class="q-btn-title" data-i18n="q4_1">ğŸ›¡ï¸ ä¸è¡Œ</span><span class="q-btn-sub"
                  data-i18n="q4_1s">å¿…é¡»ç¡å¤Ÿ</span></div>
            </label>
            <label class="q-label"><input type="radio" name="q4" value="less" class="radio-hidden"
                onchange="updateFlow()">
              <div class="q-btn"><span class="q-btn-title" data-i18n="q4_2">ğŸ”‹ é€‚å½“å°‘ç¡</span><span class="q-btn-sub"
                  data-i18n="q4_2s">æ¥å—å•æ—¥ä»…ç¡5-6å°æ—¶</span></div>
            </label>
            <label class="q-label"><input type="radio" name="q4" value="short" class="radio-hidden"
                onchange="updateFlow()">
              <div class="q-btn"><span class="q-btn-title" data-i18n="q4_3">âš¡ æé™ç¼ºè§‰</span><span class="q-btn-sub"
                  data-i18n="q4_3s">æ¥å—è¿ç»­ç†¬å¤œæˆ–æçŸ­ç¡çœ </span></div>
            </label>
          </div>
        </div>

        <div class="flow-container" id="exec-container">
          <div class="pt-4 border-t border-slate-800 flex items-center justify-between mt-4">
            <span class="text-xs text-slate-500 uppercase font-bold flex items-center">
              <span data-i18n="duration">å‘¨æœŸ/å¤©æ•°:</span>
            </span>
            <div class="flex items-center">
              <input type="number" id="days_global" value="3" min="2" max="7" class="days-input">
              <span class="text-xs text-slate-500" data-i18n="label_days">Days</span>
            </div>
          </div>
          <div class="flex gap-4 mt-8">
            <button onclick="goToView(1)"
              class="flex-1 bg-slate-800 text-slate-400 font-bold py-4 text-xs uppercase hover:bg-slate-700 transition-colors">&lt;&lt;
              Back</button>
            <button onclick="executeAndShow()"
              class="flex-[2] bg-yellow-400 text-black font-black py-4 text-sm uppercase tracking-widest hover:bg-yellow-300 shadow-[0_0_20px_rgba(250,204,21,0.4)] transition-all"
              style="animation: cyberPulseYellow 2s infinite;" data-i18n="btn_execute">ç”ŸæˆæŒ‡ä»¤ (EXECUTE)</button>
          </div>
        </div>

      </div>
    </div>

    <div id="view-results" class="view-section">
      <div class="flex justify-between items-end border-b border-slate-800 pb-2 mb-6">
        <div>
          <h2 class="text-blue-500 font-bold text-sm uppercase tracking-widest">Mission Protocol</h2>
          <div class="flex items-center gap-2 mt-1 flex-wrap">
            <span class="text-[10px] text-slate-500" data-i18n="view_zone">æ˜¾ç¤ºæ—¶åŒº:</span>
            <select id="displayZoneSelect" class="display-select" onchange="renderTimeline()"></select>
            <span class="text-[10px] text-slate-500 ml-2" data-i18n="view_model">æ¨¡å‹:</span>
            <select id="modelSelectOverride" class="display-select" onchange="overrideModelAndRender()"></select>
            <span class="info-trigger border-slate-700 text-blue-500 hover:text-yellow-400 hover:border-yellow-400 ml-2"
              onclick="goToView('info-math')">INFO [?]</span>
          </div>
        </div>
        <div class="flex flex-col items-end gap-1">
          <span id="directionBadge"
            class="text-[10px] bg-slate-900 text-blue-400 border border-slate-700 px-2 py-1 font-bold rounded">--</span>
          <span id="offsetBadge"
            class="text-[10px] bg-slate-900 text-yellow-400 px-2 py-1 font-mono border border-slate-700">--</span>
        </div>
      </div>
      <div id="timeline" class="space-y-4 pb-20"></div>
      <div class="fixed bottom-6 left-0 w-full px-6 flex justify-center gap-4 z-50">
        <button onclick="exportToCalendar()" data-i18n="btn_export"
          class="bg-blue-900 border border-blue-700 text-blue-200 px-6 py-3 rounded-full text-xs font-bold shadow-[0_0_15px_rgba(59,130,246,0.3)] hover:bg-blue-800 hover:text-white transition-all uppercase tracking-widest">ğŸ“…
          æ·»åŠ åˆ°æ—¥å†</button>
        <button onclick="goToView(0)"
          class="bg-slate-900 border border-slate-700 text-slate-400 px-6 py-3 rounded-full text-xs font-bold shadow-2xl hover:text-white hover:border-slate-500 transition-all uppercase tracking-widest">â†»
          Reset</button>
      </div>
    </div>

    <div id="info-sleep" class="view-section max-w-2xl mx-auto pt-8">
      <h2 class="kb-header" data-i18n="kb_id_01">DATA ANCHOR 01</h2>
      <h3 class="kb-title" data-i18n="kb_sleep_title">ç”Ÿç†é”šç‚¹ï¼šç”Ÿç‰©é’ŸåŸºçº¿</h3>
      <p class="kb-text" data-i18n="kb_sleep_desc">åˆ«å¡«é£æœºèµ·é£æ—¶é—´ï¼åˆ«å¡«ä½ æ‰“ç®—å‡ ç‚¹ç¡ï¼<br>è¿™é‡Œè¦çš„æ˜¯ä½ <strong>ä¸Šæ¬¡ç¡è§‰ç¡ç€çš„å¤§è‡´æ—¶é—´</strong></p>
      <button onclick="goToView(1)" class="action-btn mt-8 bg-slate-800 hover:bg-slate-700" style="animation: none;"
        data-i18n="btn_return">&lt;&lt; RETURN</button>
    </div>
    <div id="info-wake" class="view-section max-w-2xl mx-auto pt-8">
      <h2 class="kb-header" data-i18n="kb_id_02">DATA ANCHOR 02</h2>
      <h3 class="kb-title" data-i18n="kb_wake_title">å…‰ç…§é‡ç½®ï¼šå¼€æœºæ—¶é—´</h3>
      <p class="kb-text" data-i18n="kb_wake_desc">å¡«å†™<strong>ä»Šå¤©èµ·åºŠ</strong>çš„æ—¶é—´ã€‚<br><br></p>
      <button onclick="goToView(1)" class="action-btn mt-8 bg-slate-800 hover:bg-slate-700" style="animation: none;"
        data-i18n="btn_return">&lt;&lt; RETURN</button>
    </div>
    <div id="info-target" class="view-section max-w-2xl mx-auto pt-8">
      <h2 class="kb-header" data-i18n="kb_id_03">TARGET FRAME</h2>
      <h3 class="kb-title" data-i18n="kb_target_title">ç›®æ ‡æ—¶åŒº</h3>
      <p class="kb-text" data-i18n="kb_target_desc">å¡«å†™ä½ æƒ³å€’çš„ç›®æ ‡åœ°ç‚¹<br><br>åˆ«ç®¡ä¸­è½¬åœ°ï¼Œåˆ«ç®¡ç»åœç«™ï¼Œç›´æ¥é€‰æœ€ç»ˆç›®çš„åœ°ã€‚å¦‚æœæ˜¯ç†¬å¤œå€’æ—¶å·®åˆ™ä¿æŒç°æœ‰åœ°å°±è¡Œ</p>
      <button onclick="goToView(1)" class="action-btn mt-8 bg-slate-800 hover:bg-slate-700" style="animation: none;"
        data-i18n="btn_return">&lt;&lt; RETURN</button>
    </div>
    <div id="info-dir" class="view-section max-w-2xl mx-auto pt-8">
      <h2 class="kb-header" data-i18n="kb_id_04">VECTOR CONTROL</h2>
      <h3 class="kb-title" data-i18n="kb_dir_title">æ—©ç¡ vs ç†¬å¤œ</h3>
      <p class="kb-text" data-i18n="kb_dir_desc">
        äººè¿™èº«ä½“å•Šï¼Œ<strong>ç†¬å¤œå®¹æ˜“æ—©èµ·éš¾</strong>ã€‚ä¸€å¤©24å°æ—¶ï¼Œä½†ç”Ÿç‰©é’Ÿå…¶å®æœ‰ç‚¹â€œæ‹–å»¶ç—‡â€ï¼ˆ24.2å°æ—¶ï¼‰ï¼Œæ‰€ä»¥æ™šç¡å®ƒæ˜¯å¼€å¿ƒçš„ï¼Œæ—©èµ·å®ƒæ˜¯æŠ—æ‹’çš„ã€‚<br><br><strong
          class='text-blue-400'>æ™ºèƒ½åˆ¤æ–­</strong>ï¼šç³»ç»Ÿä¼šè‡ªåŠ¨å¸®ä½ ç®—ç®—ï¼Œæ˜¯ç°åœ¨å’¬ç‰™å°‘ç¡å‡ å°æ—¶åˆ’ç®—ï¼Œè¿˜æ˜¯å¹²è„†é€šå®µç†¬ä¸€ç†¬æ›´è½»æ¾ã€‚ç›¸ä¿¡ç®—æ³•ï¼Œå®ƒæ˜¯ä¸“ä¸šçš„ï¼Œèƒ½è®©ä½ å°‘å—ç‚¹ç½ªã€‚</p>
      <button onclick="goToView(2)" class="action-btn mt-8 bg-slate-800 hover:bg-slate-700" style="animation: none;"
        data-i18n="btn_return">&lt;&lt; RETURN</button>
    </div>
    <div id="info-q2" class="view-section max-w-2xl mx-auto pt-8">
      <h2 class="kb-header">Q2 PARAMETERS</h2>
      <h3 class="kb-title" data-i18n="kb_q2_title">ç¬¬äºŒå¤©çš„çŠ¶æ€è¦æ±‚</h3>
      <p class="kb-text" data-i18n="kb_q2_desc">è¯„ä¼°ç¬¬äºŒå¤©å¯¹ç²¾åŠ›çš„éœ€æ±‚ï¼Œå†³å®šæ˜¯å¦å¯ä»¥é‡‡ç”¨æ¿€è¿›çš„æ—¶å·®è°ƒæ•´ç­–ç•¥ã€‚</p>
      <button onclick="goToView(2)" class="action-btn mt-8 bg-slate-800 hover:bg-slate-700" style="animation: none;"
        data-i18n="btn_return">&lt;&lt; RETURN</button>
    </div>
    <div id="info-q3" class="view-section max-w-2xl mx-auto pt-8">
      <h2 class="kb-header">Q3 PARAMETERS</h2>
      <h3 class="kb-title" data-i18n="kb_q3_title">è°ƒæ•´é€Ÿåº¦</h3>
      <p class="kb-text" data-i18n="kb_q3_desc">å†³å®šæ—¶å·®å¹³ç§»çš„æ¯æ—¥æ­¥å¹…ã€‚æ¿€è¿›å°†å¤§å¹…æ”¹å˜ä½œæ¯ï¼Œç¨³å¥åˆ™ç›¸å¯¹ä¿å®ˆã€‚</p>
      <button onclick="goToView(2)" class="action-btn mt-8 bg-slate-800 hover:bg-slate-700" style="animation: none;"
        data-i18n="btn_return">&lt;&lt; RETURN</button>
    </div>
    <div id="info-q4" class="view-section max-w-2xl mx-auto pt-8">
      <h2 class="kb-header">Q4 PARAMETERS</h2>
      <h3 class="kb-title" data-i18n="kb_q4_title">ç¡çœ å‰¥å¤ºè€å—åº¦</h3>
      <p class="kb-text" data-i18n="kb_q4_desc">çŸ­æœŸçš„ç¡çœ å‰¥å¤ºï¼ˆå°‘ç¡/ç†¬å¤œï¼‰å¯ä»¥å¿«é€Ÿé‡ç½®ç”Ÿç‰©é’Ÿï¼Œä½†å¯¹ç”Ÿç†è´Ÿè·è¦æ±‚è¾ƒé«˜ã€‚</p>
      <button onclick="goToView(2)" class="action-btn mt-8 bg-slate-800 hover:bg-slate-700" style="animation: none;"
        data-i18n="btn_return">&lt;&lt; RETURN</button>
    </div>

    <div id="info-math" class="view-section max-w-2xl mx-auto pt-8 pb-12">
      <h2 class="kb-header">COMPUTE KERNEL // MATHEMATICS</h2>
      <h3 class="kb-title" data-i18n="kb_math_title">æ•°å­¦ç®—æ³•è§£æ (Algorithms)</h3>

      <img src="lib/graph.webp" alt="Model Completion Curves"
        class="w-full rounded-lg border border-slate-700 shadow-[0_4px_20px_rgba(0,0,0,0.5)] mb-6 mt-4 opacity-95">

      <p class="kb-text text-xs mb-6 border-l-2 border-yellow-500 pl-3 bg-slate-900/50 py-3 pr-2" data-i18n="math_var">
        <span class="text-blue-400 font-bold">å‚æ•°å®šä¹‰:</span><br>
        $\Delta$ = æ€»æ—¶å·®<br>
        $N$ = æ€»å¤©æ•°<br>
        $i$ = å½“å‰ç¬¬å‡ å¤©<br>
        $R_i$ = å‰©ä½™æœªè°ƒæ•´æ—¶å·®<br>
        $S(i)$ = ç¬¬ $i$ å¤©ç´¯è®¡åç§»é‡
      </p>

      <div class="math-block">
        <div class="math-title">model_A <span class="text-slate-500 font-normal text-xs ml-2">| çº¿æ€§ç­‰åˆ† (Linear
            Even)</span></div>
        <div class="math-formula">$$ S(i) = \Delta \times \left( \frac{i}{N} \right) $$</div>
        <div class="math-desc" data-i18n="math_A_desc">æœ€åŸºç¡€çš„ç®—æœ¯æ¨¡å‹ï¼Œæ¯å¤©å‡åŒ€åˆ†é…è°ƒæ•´é‡ï¼Œæ— è§†ç”Ÿç†å“åº”è§„å¾‹ã€‚</div>
      </div>

      <div class="math-block">
        <div class="math-title">model_B <span class="text-slate-500 font-normal text-xs ml-2">| å¿«é€ŸæŠ˜ä¸­ (Rapid Fold)</span>
        </div>
        <div class="math-formula">$$ S(i) = \Delta \times \left( 1 - 0.5^i \right) $$</div>
        <div class="math-desc" data-i18n="math_B_desc">æŒ‡æ•°è¡°å‡æ”¶æ•›ï¼ŒåˆæœŸè°ƒæ•´å¹…åº¦æå¤§ï¼ˆæ¯å¤©æ¶ˆé™¤å‰©ä½™çš„ä¸€åŠï¼‰ï¼ŒåæœŸå¹³æ»‘ã€‚</div>
      </div>

      <div class="math-block">
        <div class="math-title">model_C <span class="text-slate-500 font-normal text-xs ml-2">| ç§‘å­¦æ¨¡å‹ (Scientific / Power
            Law)</span></div>
        <div class="math-formula">$$ S(i) = \Delta \times \left( \frac{i}{N} \right)^{0.7} $$</div>
        <div class="math-desc" data-i18n="math_C_desc">å¼•å…¥ 0.7 æ¬¡å¹‚çš„éçº¿æ€§æ­¥è¿›ï¼Œå‰æœŸå¿«åæœŸæ…¢ï¼Œå®ç°å¹³ç¼“è¿‡æ¸¡ã€‚</div>
      </div>

      <div class="math-block">
        <div class="math-title">model_D <span class="text-slate-500 font-normal text-xs ml-2">| å…‰é€‚åº”è¡°å‡ (St Hilaire Photic
            Decay)</span></div>
        <div class="math-formula">$$ \Delta S_i = R_i \cdot 0.5 \cdot \kappa(i) \quad \text{where} \; \kappa(i) =
          \begin{cases} 1.0, & i=1 \\ 0.8, & i>1 \end{cases} $$</div>
        <div class="math-desc" data-i18n="math_D_desc">æ¨¡æ‹Ÿè§†ç½‘è†œæ„Ÿå…‰ç»†èƒå¯¹æŒç»­å…‰ç…§çš„æ•æ„Ÿåº¦è¡°å‡ï¼Œåç»­ç›¸ç§»é˜»åŠ›é€æ¸å¢åŠ ã€‚</div>
      </div>

      <div class="math-block">
        <div class="math-title">model_E <span class="text-slate-500 font-normal text-xs ml-2">| æ­£å¼¦å“åº” (Sine PRC)</span>
        </div>
        <div class="math-formula">$$ \Delta S_i = 1.5 \cdot \sin\left(\frac{R_i}{12} \pi\right) $$</div>
        <div class="math-desc" data-i18n="math_E_desc">åº”ç”¨æ­£å¼¦æ³¢å½¢ï¼ˆPhase Response Curveï¼‰æ˜ å°„ç”Ÿç‰©é’Ÿå¯¹æ—¶é—´åç§»çš„éçº¿æ€§å“åº”ç‡ã€‚</div>
      </div>

      <div class="math-block">
        <div class="math-title">model_F <span class="text-slate-500 font-normal text-xs ml-2">| æé™ç¯æŒ¯å­ (Kronauer
            Oscillator Approx)</span></div>
        <div class="math-formula">$$ \Delta S_i = R_i \cdot 0.45 \left[ 1 + 0.2 \cos\left(\frac{R_i}{12}\pi\right)
          \right] $$</div>
        <div class="math-desc" data-i18n="math_F_desc">æ ¸å¿ƒæ¨èã€‚åŸºäº Van der Pol éçº¿æ€§æŒ¯å­æ–¹ç¨‹ï¼Œå¼•å…¥ç›¸ç§»åˆšåº¦çš„åŠ¨æ€å˜åŒ–è®¡ç®—å®é™…æé™ç¯åç§»ã€‚</div>
      </div>

      <div class="math-block">
        <div class="math-title">model_G <span class="text-slate-500 font-normal text-xs ml-2">| ç¡çœ ç¨³æ€ (BorbÃ©ly
            Two-Process)</span></div>
        <div class="math-formula">$$ S_{dur}(i) = S_{base} \pm \beta(i) \quad \text{with} \quad \Delta S_i =
          \frac{R_i}{N} $$</div>
        <div class="math-desc" data-i18n="math_G_desc">ç‹¬ç«‹è®¡ç®—åç§»é‡ï¼Œæ ¸å¿ƒåœ¨äºå°†æ—¶å·®ä¸åŠ¨æ€ç¡çœ é•¿åº¦è§£è€¦ï¼ŒåŠ¨æ€è°ƒèŠ‚ Process Sï¼ˆç¡çœ å‹åŠ›ï¼‰ã€‚</div>
      </div>

      <div class="math-block">
        <div class="math-title">model_H <span class="text-slate-500 font-normal text-xs ml-2">| ç”Ÿç‰©è‡ªé€‚åº” (Bio
            Adaptive)</span></div>
        <div class="math-formula">$$ S(i) = \Delta \times \left( \frac{i}{N} \right)^{0.6} \rightarrow \text{Modulated }
          S_{dur} $$</div>
        <div class="math-desc" data-i18n="math_H_desc">ç»å…¸åŠ¨æ€ç¡çœ æ¨¡å‹ï¼Œé€šè¿‡ä¸»åŠ¨ç¼©çŸ­ç¡çœ æ—¶é•¿åˆ¶é€ ç¡çœ å‰¥å¤ºï¼Œå¼ºåˆ¶é”šå®šç”Ÿç‰©é’Ÿã€‚</div>
      </div>

      <button onclick="goToView(3)" class="action-btn mt-8 bg-slate-800 hover:bg-slate-700" style="animation: none;"
        data-i18n="btn_return">&lt;&lt; RETURN</button>
    </div>

  </div>

  <script>
    const DateTime = luxon.DateTime;
    let currentLang = 'zh';
    let globalPlan = [];
    let isCompatMode = false;

    const modelsList = [
      { value: 'model_A', label: 'model_A' },
      { value: 'model_B', label: 'model_B' },
      { value: 'model_C', label: 'model_C' },
      { value: 'model_D', label: 'model_D' },
      { value: 'model_E', label: 'model_E' },
      { value: 'model_F', label: 'model_F' },
      { value: 'model_G', label: 'model_G' },
      { value: 'model_H', label: 'model_H' }
    ];

    function initModelSelect() {
      const select = document.getElementById('modelSelectOverride');
      select.innerHTML = '';
      modelsList.forEach(m => { select.add(new Option(m.label, m.value)); });
    }

    function detectPlatform() {
      const ua = navigator.userAgent.toLowerCase();
      const isMobile = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(ua);
      const btn = document.getElementById('compatBtn');
      if (isMobile) {
        document.body.classList.add('mode-overlay');
        document.body.classList.remove('mode-compat');
        isCompatMode = false;
        btn.classList.remove('compat-active');
        btn.innerText = "MOBILE";
      } else {
        document.body.classList.add('mode-compat');
        document.body.classList.remove('mode-overlay');
        isCompatMode = true;
        btn.classList.add('compat-active');
        btn.innerText = "PC";
      }
    }

    function toggleCompatMode() {
      isCompatMode = !isCompatMode;
      const btn = document.getElementById('compatBtn');
      if (isCompatMode) {
        document.body.classList.add('mode-compat');
        document.body.classList.remove('mode-overlay');
        btn.classList.add('compat-active');
        btn.innerText = "PC";
      } else {
        document.body.classList.remove('mode-compat');
        document.body.classList.add('mode-overlay');
        btn.classList.remove('compat-active');
        btn.innerText = "MOBILE";
      }
    }

    function updateDateDisplay(inputEl, displayId) {
      const val = inputEl.value;
      if (!val) return;
      const dt = DateTime.fromISO(val);
      document.getElementById(displayId).innerText = dt.setLocale('en').toFormat('dd MMM');
    }

    function updateTimeDisplay(inputEl, displayId) {
      const val = inputEl.value;
      if (!val) return;
      const [h, m] = val.split(':').map(Number);
      let h12 = h % 12;
      if (h12 === 0) h12 = 12;
      const hStr = h12.toString().padStart(2, '0');
      const mStr = m.toString().padStart(2, '0');
      document.getElementById(displayId).innerText = `${hStr}:${mStr}`;
    }

    function syncAMPM(inputId, btnId) {
      const val = document.getElementById(inputId).value;
      if (!val) return;
      const h = parseInt(val.split(':')[0]);
      setAMPM(btnId, h >= 12);
    }

    function toggleAMPM(btnId) {
      const prefix = btnId.replace('AMPM', '');
      const input = document.getElementById(prefix + 'Time');
      if (!input.value) return;
      let [h, m] = input.value.split(':').map(Number);
      if (h < 12) h += 12; else h -= 12;
      input.value = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
      syncAMPM(prefix + 'Time', btnId);
      updateTimeDisplay(input, prefix + 'TimeDisplay');
    }

    function setAMPM(id, isPM) {
      const btn = document.getElementById(id);
      if (isPM) {
        btn.innerText = 'PM';
        btn.classList.add('pm-active');
        btn.classList.remove('am-active');
      } else {
        btn.innerText = 'AM';
        btn.classList.add('am-active');
        btn.classList.remove('pm-active');
      }
    }

    function initSplitInputs() {
      const now = DateTime.now();
      const sleepInit = now.minus({ hours: 8 });
      const wakeInit = now;
      const sDate = document.getElementById('sleepDate');
      const sTime = document.getElementById('sleepTime');
      sDate.value = sleepInit.toFormat('yyyy-MM-dd');
      sTime.value = sleepInit.toFormat('HH:mm');
      updateDateDisplay(sDate, 'sleepDateDisplay');
      updateTimeDisplay(sTime, 'sleepTimeDisplay');
      syncAMPM('sleepTime', 'sleepAMPM');
      const wDate = document.getElementById('wakeDate');
      const wTime = document.getElementById('wakeTime');
      wDate.value = wakeInit.toFormat('yyyy-MM-dd');
      wTime.value = wakeInit.toFormat('HH:mm');
      updateDateDisplay(wDate, 'wakeDateDisplay');
      updateTimeDisplay(wTime, 'wakeTimeDisplay');
      syncAMPM('wakeTime', 'wakeAMPM');
    }

    const translations = {
      zh: {
        welcome_title: "æ¬¢è¿", welcome_desc: "Jetlag Commander æ˜¯ä¸€ä¸ªæ™ºèƒ½è°ƒèŠ‚æ—¶å·®çš„ç½‘é¡µ,å¸®åŠ©ä½ ç§‘å­¦çš„å€’æ—¶å·®,åŒ…æ‹¬è·¨å›½é£è¡Œä»¥åŠç†¬å¤œé€ æˆçš„æ—¶å·®ã€‚",
        btn_start: "GET STARTED ->", btn_next: "ä¸‹ä¸€æ­¥ >>", btn_home: "<< HOME", btn_execute: "ç”ŸæˆæŒ‡ä»¤ (EXECUTE)", btn_what: " [?] è¿™æ˜¯ä»€ä¹ˆ", btn_return: "<< RETURN", btn_export: "ğŸ“… æ·»åŠ åˆ°æ—¥å†",
        step1: "Step 1: ä¸Šä¸€æ¬¡å…¥ç¡æ—¶é—´", step2: "Step 2: ä¸Šä¸€æ¬¡èµ·åºŠæ—¶é—´", step3: "Step 3: ç›®æ ‡æ—¶åŒº",
        q1_title: "Q1: è°ƒæ•´æ–¹å‘", q1_1: "ğŸ¤– æ™ºèƒ½åˆ¤æ–­", q1_1s: "è‡ªåŠ¨è®¡ç®—æœ€ä¼˜è§£", q1_2: "ğŸ›ï¸ å¼ºåˆ¶æ—©ç¡", q1_2s: "å¼ºè¿«æ—¶é’Ÿå‰ç§»", q1_3: "ğŸ¦‰ å¼ºåˆ¶æ™šç¡", q1_3s: "å¼ºè¿«æ—¶é’Ÿåç§»",
        q2_title: "Q2: ç¬¬2å¤©æœ‰æ²¡æœ‰å¿…é¡»çŠ¶æ€åœ¨çº¿çš„äº‹ï¼Ÿ", q2_1: "ğŸ’¼ æœ‰", q2_1s: "ä¸Šç­/è€ƒè¯•/é¢è¯•ç­‰", q2_2: "â˜• æœ‰ç‚¹äº‹", q2_2s: "æ²¡é‚£ä¹ˆé‡è¦", q2_3: "ğŸ›‹ï¸ æ²¡æœ‰", q2_3s: "è‡ªç”±æ”¯é…",
        q3_title: "Q3: ä½ å¸Œæœ›å¤šå¿«è°ƒæ•´æ—¶å·®ï¼Ÿ", q3_1: "ğŸ¢ ç¨³å¥", q3_1s: "æ¯å¤©å˜åŒ–å°ï¼Œå°½é‡èˆ’æœ", q3_2: "ğŸš¶ æ ‡å‡†", q3_2s: "æŠ˜ä¸­", q3_3: "ğŸš€ æ¿€è¿›", q3_3s: "ä¼˜å…ˆé€Ÿåº¦",
        q4_title: "Q4: èƒ½æ¥å—â€œä¸ºäº†åŠ é€Ÿè€Œå°‘ç¡/çŸ­ç¡â€å—ï¼Ÿ", q4_1: "ğŸ›¡ï¸ ä¸è¡Œ", q4_1s: "å¿…é¡»ç¡å¤Ÿ", q4_2: "ğŸ”‹ é€‚å½“å°‘ç¡", q4_2s: "æ¥å—å•æ—¥ä»…ç¡5-6å°æ—¶", q4_3: "âš¡ æé™ç¼ºè§‰", q4_3s: "æ¥å—è¿ç»­ç†¬å¤œæˆ–æçŸ­ç¡çœ ",
        duration: "å‘¨æœŸ/å¤©æ•°:", label_days: "Days", view_zone: "æ˜¾ç¤ºæ—¶åŒº:", view_model: "æ¨¡å‹:", label_sleep: "å…¥ç¡ (Sleep)", label_wake: "å”¤é†’ (Wake)", day_prefix: "DAY",
        badge_smart_early: "MODE: æ™ºèƒ½æ—©ç¡", badge_smart_late: "MODE: æ™ºèƒ½ç†¬å¤œ", badge_force_early: "MODE: å¼ºåˆ¶æ—©ç¡", badge_force_late: "MODE: å¼ºåˆ¶ç†¬å¤œ",
        model_A: "model_A | ä¼ ç»Ÿæ¨¡å‹ï¼šçº¿æ€§å‡åˆ†", model_B: "model_B | ä¼ ç»Ÿæ¨¡å‹ï¼šå¿«é€ŸæŠ˜ä¸­", model_C: "model_C | ç»å…¸æ¨¡å‹ï¼šScientific",
        model_D: "model_D | Cutting Edge Models: model_sthilaire_like", model_E: "model_E | Cutting Edge Models: model_prc_like",
        model_F: "model_F | Cutting Edge Models: model_kronauer_like", model_G: "model_G | Cutting Edge Models: model_borbely_like",
        model_H: "model_H | ç»å…¸æ¨¡å‹ï¼šBio Adaptive",
        kb_id_01: "DATA ANCHOR 01", kb_sleep_title: "æ—¶é—´é”šç‚¹:å…¥ç¡æ—¶é—´", kb_sleep_desc: "åˆ«å¡«é£æœºèµ·é£æ—¶é—´ï¼åˆ«å¡«ä½ æ‰“ç®—å‡ ç‚¹ç¡ï¼<br>è¿™é‡Œè¦çš„æ˜¯ä½ <strong>ä¸Šæ¬¡ç¡è§‰ç¡ç€çš„å¤§è‡´æ—¶é—´</strong>",
        kb_id_02: "DATA ANCHOR 02", kb_wake_title: "æ—¶é—´é”šç‚¹ï¼šä¸Šä¸€æ¬¡èµ·åºŠæ—¶é—´", kb_wake_desc: "å¡«å†™<strong>ä»Šå¤©èµ·åºŠ</strong>çš„æ—¶é—´ã€‚<br><br>",
        kb_id_03: "TARGET FRAME", kb_target_title: "ç›®æ ‡æ—¶åŒº", kb_target_desc: "å¡«å†™ä½ æƒ³å€’çš„ç›®æ ‡åœ°ç‚¹<br><br>åˆ«ç®¡ä¸­è½¬åœ°ï¼Œåˆ«ç®¡ç»åœç«™ï¼Œç›´æ¥é€‰æœ€ç»ˆç›®çš„åœ°ã€‚å¦‚æœæ˜¯ç†¬å¤œå€’æ—¶å·®åˆ™ä¿æŒç°æœ‰åœ°å°±è¡Œ",
        kb_id_04: "VECTOR CONTROL", kb_dir_title: "æ—©ç¡ vs ç†¬å¤œ", kb_dir_desc: "äººè¿™èº«ä½“å•Šï¼Œ<strong class='text-blue-400'>ç†¬å¤œå®¹æ˜“æ—©èµ·éš¾</strong>ã€‚ä¸€å¤©24å°æ—¶ï¼Œä½†ç”Ÿç‰©é’Ÿå…¶å®æœ‰ç‚¹â€œæ‹–å»¶ç—‡â€ï¼ˆ24.2å°æ—¶ï¼‰ï¼Œæ‰€ä»¥æ™šç¡å®ƒæ˜¯å¼€å¿ƒçš„ï¼Œæ—©èµ·å®ƒæ˜¯æŠ—æ‹’çš„ã€‚<br><br><strong class='text-yellow-400'>æ™ºèƒ½åˆ¤æ–­</strong>ï¼šç³»ç»Ÿä¼šè‡ªåŠ¨å¸®ä½ ç®—ç®—ï¼Œæ˜¯ç°åœ¨å’¬ç‰™å°‘ç¡å‡ å°æ—¶åˆ’ç®—ï¼Œè¿˜æ˜¯å¹²è„†é€šå®µç†¬ä¸€ç†¬æ›´è½»æ¾ã€‚ç›¸ä¿¡ç®—æ³•ï¼Œå®ƒæ˜¯ä¸“ä¸šçš„ï¼Œèƒ½è®©ä½ å°‘å—ç‚¹ç½ªã€‚",
        kb_q2_title: "ç¬¬äºŒå¤©çš„çŠ¶æ€è¦æ±‚", kb_q2_desc: "è¯„ä¼°ç¬¬äºŒå¤©å¯¹ç²¾åŠ›çš„éœ€æ±‚ï¼Œå†³å®šæ˜¯å¦å¯ä»¥é‡‡ç”¨æ¿€è¿›çš„æ—¶å·®è°ƒæ•´ç­–ç•¥ã€‚",
        kb_q3_title: "è°ƒæ•´é€Ÿåº¦", kb_q3_desc: "å†³å®šæ—¶å·®å¹³ç§»çš„æ¯æ—¥æ­¥å¹…ã€‚æ¿€è¿›å°†å¤§å¹…æ”¹å˜ä½œæ¯ï¼Œç¨³å¥åˆ™ç›¸å¯¹ä¿å®ˆã€‚",
        kb_q4_title: "ç¡çœ å‰¥å¤ºè€å—åº¦", kb_q4_desc: "çŸ­æœŸçš„ç¡çœ å‰¥å¤ºï¼ˆå°‘ç¡/ç†¬å¤œï¼‰å¯ä»¥å¿«é€Ÿé‡ç½®ç”Ÿç‰©é’Ÿï¼Œä½†å¯¹ç”Ÿç†è´Ÿè·è¦æ±‚è¾ƒé«˜ã€‚",
        kb_math_title: "æ•°å­¦ç®—æ³•è§£æ (Algorithms)",
        math_var: "<span class='text-blue-400 font-bold'>å‚æ•°å®šä¹‰:</span><br>$\\Delta$ = æ€»æ—¶å·®<br>$N$ = æ€»å¤©æ•°<br>$i$ = å½“å‰ç¬¬å‡ å¤©<br>$R_i$ = å‰©ä½™æœªè°ƒæ•´æ—¶å·®<br>$S(i)$ = ç¬¬ $i$ å¤©ç´¯è®¡åç§»é‡",
        math_A_desc: "æœ€åŸºç¡€çš„ç®—æœ¯æ¨¡å‹ï¼Œæ¯å¤©å‡åŒ€åˆ†é…è°ƒæ•´é‡ï¼Œæ— è§†ç”Ÿç†å“åº”è§„å¾‹ã€‚",
        math_B_desc: "æŒ‡æ•°è¡°å‡æ”¶æ•›ï¼ŒåˆæœŸè°ƒæ•´å¹…åº¦æå¤§ï¼ˆæ¯å¤©æ¶ˆé™¤å‰©ä½™çš„ä¸€åŠï¼‰ï¼ŒåæœŸå¹³æ»‘ã€‚",
        math_C_desc: "å¼•å…¥ 0.7 æ¬¡å¹‚çš„éçº¿æ€§æ­¥è¿›ï¼Œå‰æœŸå¿«åæœŸæ…¢ï¼Œå®ç°å¹³ç¼“è¿‡æ¸¡ã€‚",
        math_D_desc: "æ¨¡æ‹Ÿè§†ç½‘è†œæ„Ÿå…‰ç»†èƒå¯¹æŒç»­å…‰ç…§çš„æ•æ„Ÿåº¦è¡°å‡ï¼Œåç»­ç›¸ç§»é˜»åŠ›é€æ¸å¢åŠ ã€‚",
        math_E_desc: "åº”ç”¨æ­£å¼¦æ³¢å½¢ï¼ˆPhase Response Curveï¼‰æ˜ å°„ç”Ÿç‰©é’Ÿå¯¹æ—¶é—´åç§»çš„éçº¿æ€§å“åº”ç‡ã€‚",
        math_F_desc: "æ ¸å¿ƒæ¨èã€‚åŸºäº Van der Pol éçº¿æ€§æŒ¯å­æ–¹ç¨‹ï¼Œå¼•å…¥ç›¸ç§»åˆšåº¦çš„åŠ¨æ€å˜åŒ–è®¡ç®—å®é™…æé™ç¯åç§»ã€‚",
        math_G_desc: "ç‹¬ç«‹è®¡ç®—åç§»é‡ï¼Œæ ¸å¿ƒåœ¨äºå°†æ—¶å·®ä¸åŠ¨æ€ç¡çœ é•¿åº¦è§£è€¦ï¼ŒåŠ¨æ€è°ƒèŠ‚ Process Sï¼ˆç¡çœ å‹åŠ›ï¼‰ã€‚",
        math_H_desc: "ç»å…¸åŠ¨æ€ç¡çœ æ¨¡å‹ï¼Œé€šè¿‡ä¸»åŠ¨ç¼©çŸ­ç¡çœ æ—¶é•¿åˆ¶é€ ç¡çœ å‰¥å¤ºï¼Œå¼ºåˆ¶é”šå®šç”Ÿç‰©é’Ÿã€‚"
      },
      en: {
        welcome_title: "Welcome", welcome_desc: "Jetlag Commander is a smart web tool for adjusting jet lag, helping you scientifically adjust jet lag, including transcontinental flights and staying up late.",
        btn_start: "GET STARTED ->", btn_next: "NEXT STEP >>", btn_home: "<< HOME", btn_execute: "EXECUTE PROTOCOL", btn_what: " [?] Info", btn_return: "<< RETURN", btn_export: "ğŸ“… Add to Calendar",
        step1: "Step 1: Last Sleep Time", step2: "Step 2: Last Wake Time", step3: "Step 3: Target Zone",
        q1_title: "Q1: Direction", q1_1: "ğŸ¤– Smart Auto", q1_1s: "Calculate optimal path", q1_2: "ğŸ›ï¸ Force Early", q1_2s: "Force clock advance", q1_3: "ğŸ¦‰ Force Late", q1_3s: "Force clock delay",
        q2_title: "Q2: Mandatory high-performance events on Day 2?", q2_1: "ğŸ’¼ Yes", q2_1s: "Work/Exam/Interview", q2_2: "â˜• Moderate", q2_2s: "Not critical", q2_3: "ğŸ›‹ï¸ None", q2_3s: "Free schedule",
        q3_title: "Q3: Desired adjustment speed?", q3_1: "ğŸ¢ Steady", q3_1s: "Minimal daily shift", q3_2: "ğŸš¶ Standard", q3_2s: "Balanced", q3_3: "ğŸš€ Aggressive", q3_3s: "Maximize speed",
        q4_title: "Q4: Willing to sacrifice sleep duration for speed?", q4_1: "ğŸ›¡ï¸ No", q4_1s: "Must sleep fully", q4_2: "ğŸ”‹ Less Sleep", q4_2s: "Accept 5-6 hrs for one day", q4_3: "âš¡ Extreme", q4_3s: "Accept severe sleep deprivation",
        duration: "Duration:", label_days: "Days", view_zone: "View:", view_model: "Model:", label_sleep: "Sleep At", label_wake: "Wake At", day_prefix: "DAY",
        badge_smart_early: "MODE: SMART EARLY", badge_smart_late: "MODE: SMART LATE", badge_force_early: "MODE: FORCE EARLY", badge_force_late: "MODE: FORCE LATE",
        model_A: "model_A | Traditional: Linear Even", model_B: "model_B | Traditional: Rapid Fold", model_C: "model_C | Classic: Scientific",
        model_D: "model_D | Cutting Edge Models: model_sthilaire_like", model_E: "model_E | Cutting Edge Models: model_prc_like",
        model_F: "model_F | Cutting Edge Models: model_kronauer_like (Rec)", model_G: "model_G | Cutting Edge Models: model_borbely_like",
        model_H: "model_H | Classic: Bio Adaptive",
        kb_id_01: "DATA ANCHOR 01", kb_sleep_title: "Real Sleep Time: When You Blacked Out", kb_sleep_desc: "Don't put your flight takeoff time! Don't put when you 'planned' to sleep!<br><br>We need the exact moment you actually <strong>closed your eyes and drifted off</strong>. The algorithm needs to know when your biological battery started charging. Garbage in, garbage out.",
        kb_id_02: "DATA ANCHOR 02", kb_wake_title: "System Boot: When You Opened Your Eyes", kb_wake_desc: "This is simply when you <strong>opened your eyes</strong> today. Whether you woke up naturally or a chaotic alarm dragged you out, this moment started your biological day.<br><br>This timestamp tells us exactly where your internal clock is currently pointing. Don't lie about snoozing.",
        kb_id_03: "TARGET FRAME", kb_target_title: "The Goal: Final Destination", kb_target_desc: "Where are you headed? Select the <strong>standard time</strong> of your final destination.<br><br>Ignore layovers, ignore stopovers. Your body only cares about where it's going to crash tonight.",
        kb_id_04: "VECTOR CONTROL", kb_dir_title: "Hard Mode vs Easy Mode", kb_dir_desc: "Here's the truth: <strong class='text-blue-400'>Staying up (Delaying) is easy, waking up early (Advancing) is hard.</strong> Your body naturally wants to drift later.<br><br><strong class='text-yellow-400'>Smart Auto</strong>: Let the system do the math. It calculates if it's less painful to force yourself awake or just power through and stay up late. Trust the math.",
        kb_q2_title: "Day 2 Performance Requirement", kb_q2_desc: "Assesses your energy needs for the next day to determine if an aggressive strategy is viable.",
        kb_q3_title: "Adjustment Speed", kb_q3_desc: "Determines the daily stride of the time shift. Aggressive means massive schedule changes, steady is more conservative.",
        kb_q4_title: "Sleep Deprivation Tolerance", kb_q4_desc: "Short-term sleep deprivation (less sleep/staying up) can quickly reset the clock but demands higher physiological toll.",
        kb_math_title: "Mathematical Algorithms",
        math_var: "<span class='text-blue-400 font-bold'>Variables Definition:</span><br>$\\Delta$ = Total Target Shift<br>$N$ = Total Days<br>$i$ = Current Day<br>$R_i$ = Remaining Shift<br>$S(i)$ = Cumulative Shift on Day $i$",
        math_A_desc: "Basic arithmetic model. Distributes the shift evenly across days, ignoring physiological curves.",
        math_B_desc: "Exponential decay. Rapid initial shift (eliminates 50% of the remaining shift daily), slowing down later.",
        math_C_desc: "Non-linear stepping using a 0.7 power law. Faster initial shift transitioning to a smooth landing.",
        math_D_desc: "Simulates photic adaptation. Retinal sensitivity decreases over time, making later shifts harder.",
        math_E_desc: "Uses a Phase Response Curve (PRC) sine wave to map biological non-linear response to time shifts.",
        math_F_desc: "Core Recommended. Based on the Van der Pol non-linear oscillator, dynamically changing phase stiffness.",
        math_G_desc: "Decouples time shift from dynamic sleep duration, regulating Process S (homeostatic sleep pressure).",
        math_H_desc: "Classic dynamic model. Utilizes calculated sleep deprivation to forcefully anchor the new circadian rhythm."
      }
    };

    function updateFlow() {
      const q1 = document.querySelector('input[name="q1"]:checked');
      const q2 = document.querySelector('input[name="q2"]:checked');
      const q3 = document.querySelector('input[name="q3"]:checked');
      const q4 = document.querySelector('input[name="q4"]:checked');

      const q1c = document.getElementById('q1-container');
      const q2c = document.getElementById('q2-container');
      const q3c = document.getElementById('q3-container');
      const q4c = document.getElementById('q4-container');
      const exe = document.getElementById('exec-container');

      q2c.classList.remove('active-flow');
      q3c.classList.remove('active-flow');
      q4c.classList.remove('active-flow');
      exe.classList.remove('active-flow');

      q1c.style.order = 1;
      q2c.style.order = 2;
      q3c.style.order = 3;
      q4c.style.order = 4;
      exe.style.order = 5;

      if (!q1) return;
      q2c.classList.add('active-flow');

      if (!q2) return;

      let isComplete = false;

      if (q2.value === 'urgent') {
        q4c.style.order = 3;
        q3c.style.order = 4;

        q4c.classList.add('active-flow');
        if (q4) {
          if (q4.value === 'no') {
            q3c.classList.add('active-flow');
            if (q3) isComplete = true;
          } else {
            isComplete = true;
            if (document.querySelector('input[name="q3"]:checked')) {
              document.querySelector('input[name="q3"]:checked').checked = false;
            }
          }
        }
      } else if (q2.value === 'moderate' || q2.value === 'none') {
        q3c.style.order = 3;
        q4c.style.order = 4;

        q3c.classList.add('active-flow');
        if (q3) {
          if (q3.value === 'aggressive') {
            q4c.classList.add('active-flow');
            if (q4) isComplete = true;
          } else {
            isComplete = true;
            if (document.querySelector('input[name="q4"]:checked')) {
              document.querySelector('input[name="q4"]:checked').checked = false;
            }
          }
        }
      }

      if (isComplete) {
        exe.classList.add('active-flow');
      }
    }

    function goToView(targetId) {
      const progressContainer = document.getElementById('progress-container');
      const progressBar = document.getElementById('progress-bar');

      if (typeof targetId === 'string' && targetId.startsWith('info-')) {
        progressContainer.classList.add('hidden');
      } else if (targetId === 'view-welcome' || targetId === 0 || targetId === 'view-license') {
        progressContainer.classList.add('hidden');
      } else {
        progressContainer.classList.remove('hidden');
        if (targetId === 1 || targetId === 'view-inputs') progressBar.style.width = '33%';
        else if (targetId === 2 || targetId === 'view-strategy') progressBar.style.width = '66%';
        else if (targetId === 3 || targetId === 'view-results') progressBar.style.width = '100%';
      }

      if (typeof targetId === 'number') {
        if (targetId === 0) targetId = 'view-welcome';
        else if (targetId === 1) targetId = 'view-inputs';
        else if (targetId === 2) {
          const s = getSplitDateTime('sleep');
          const w = getSplitDateTime('wake');
          if (!s || !w || !s.isValid || !w.isValid) { return; }
          if (w <= s) { return; }
          targetId = 'view-strategy';
        }
        else if (targetId === 3) targetId = 'view-results';
      }
      document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
      document.getElementById(targetId).classList.add('active');
      window.scrollTo(0, 0);

      if (window.MathJax && targetId === 'info-math') {
        MathJax.typesetPromise();
      }
    }

    function getSplitDateTime(prefix) {
      const dateStr = document.getElementById(prefix + 'Date').value;
      const timeStr = document.getElementById(prefix + 'Time').value;
      const zone = document.getElementById(prefix + 'Zone').value;
      if (!dateStr || !timeStr) return null;
      return DateTime.fromISO(`${dateStr}T${timeStr}`, { zone: zone });
    }

    function toggleLanguage() { currentLang = currentLang === 'zh' ? 'en' : 'zh'; applyLanguage(); }

    function applyLanguage() {
      const t = translations[currentLang];
      document.querySelectorAll('[data-i18n]').forEach(el => { const key = el.getAttribute('data-i18n'); if (t[key]) el.innerHTML = t[key]; });
      document.getElementById('langBtn').innerText = currentLang === 'zh' ? 'EN / ä¸­' : 'CN / EN';
      if (document.getElementById('view-results').classList.contains('active')) renderTimeline();

      if (window.MathJax && document.getElementById('info-math').classList.contains('active')) {
        MathJax.typesetPromise();
      }
    }

    const rawTimezones = ["Asia/Shanghai", "Asia/Tokyo", "Asia/Singapore", "Asia/Kuala_Lumpur", "Asia/Bangkok", "Asia/Dubai", "Asia/Seoul", "Asia/Kolkata", "Asia/Hong_Kong", "Asia/Mumbai", "Australia/Melbourne", "Australia/Sydney", "Australia/Brisbane", "Australia/Adelaide", "Australia/Perth", "Pacific/Auckland", "Europe/London", "Europe/Paris", "Europe/Berlin", "Europe/Rome", "Europe/Amsterdam", "Europe/Moscow", "Europe/Istanbul", "Europe/Zurich", "Europe/Madrid", "America/New_York", "America/Los_Angeles", "America/Toronto", "America/Vancouver", "America/Mexico_City", "America/Sao_Paulo", "Africa/Johannesburg"];

    function formatZoneDisplay(tz) {
      if (tz === "Asia/Shanghai") return "Asia/China";
      if (tz === "Asia/Hong_Kong") return "Asia/Hong Kong";
      if (tz.startsWith("America/")) return tz.replace("America/", "North America/");
      return tz;
    }

    const populate = (id, def) => {
      const el = document.getElementById(id);
      el.innerHTML = "";
      rawTimezones.sort().forEach(tz => { el.add(new Option(formatZoneDisplay(tz), tz)); });
      const userZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
      if (!rawTimezones.includes(userZone)) el.add(new Option(userZone, userZone));
      el.value = def || userZone;
    };

    function executeAndShow() {
      try { execute(null); goToView(3); setTimeout(() => renderTimeline(), 10); }
      catch (e) { console.error(e); }
    }

    function overrideModelAndRender() {
      const selected = document.getElementById('modelSelectOverride').value;
      execute(selected);
      renderTimeline();
    }

    function execute(overrideModel = null) {
      const t = translations[currentLang];
      const lastSleep = getSplitDateTime('sleep');
      const lastWake = getSplitDateTime('wake');
      const tZone = document.getElementById('targetZone').value;

      const q1 = document.querySelector('input[name="q1"]:checked')?.value || 'smart';
      const q2 = document.querySelector('input[name="q2"]:checked')?.value;
      const q3 = document.querySelector('input[name="q3"]:checked')?.value;
      const q4 = document.querySelector('input[name="q4"]:checked')?.value;
      const durationDays = parseInt(document.getElementById('days_global').value) || 3;

      const wakeInTarget = lastWake.setZone(tZone);
      let idealWake = wakeInTarget.set({ hour: 7, minute: 0, second: 0 });
      let diffRaw = idealWake.diff(wakeInTarget, 'hours').hours;
      if (diffRaw > 12) diffRaw -= 24; else if (diffRaw < -12) diffRaw += 24;

      let diffAdvance, diffDelay;
      if (diffRaw <= 0) { diffAdvance = diffRaw; diffDelay = diffRaw + 24; }
      else { diffAdvance = diffRaw - 24; diffDelay = diffRaw; }

      let finalDiff, finalMode;
      if (q1 === 'early') { finalDiff = diffAdvance; finalMode = "ADVANCE"; }
      else if (q1 === 'late') { finalDiff = diffDelay; finalMode = "DELAY"; }
      else {
        const costAdvance = Math.abs(diffAdvance) * 1.5;
        const costDelay = Math.abs(diffDelay) * 1.0;
        if (costAdvance < costDelay) { finalDiff = diffAdvance; finalMode = "ADVANCE"; }
        else { finalDiff = diffDelay; finalMode = "DELAY"; }
      }

      const badge = document.getElementById('directionBadge');
      let badgeKey = "";
      let badgeColor = "";
      if (finalMode === "ADVANCE") {
        badgeColor = "text-[10px] bg-[#0f172a] text-blue-400 border border-slate-700 px-2 py-1 font-bold rounded";
        badgeKey = q1 === 'smart' ? 'badge_smart_early' : 'badge_force_early';
      } else {
        badgeColor = "text-[10px] bg-[#0f172a] text-yellow-400 border border-slate-700 px-2 py-1 font-bold rounded";
        badgeKey = q1 === 'smart' ? 'badge_smart_late' : 'badge_force_late';
      }
      badge.innerText = t[badgeKey];
      badge.className = badgeColor;
      badge.dataset.key = badgeKey;

      let finalModel = '';
      if (overrideModel) {
        finalModel = overrideModel;
      } else {
        if (q2 === 'urgent') {
          if (q4 === 'short') finalModel = 'model_H';
          else if (q4 === 'less') finalModel = 'model_C';
          else if (q4 === 'no') {
            if (q3 === 'aggressive') finalModel = 'model_B';
            else finalModel = 'model_F';
          }
        } else if (q2 === 'moderate') {
          if (q3 === 'steady') finalModel = 'model_D';
          else if (q3 === 'standard') finalModel = 'model_F';
          else if (q3 === 'aggressive') {
            if (q4 === 'no') finalModel = 'model_B';
            else finalModel = 'model_C';
          }
        } else if (q2 === 'none') {
          if (q3 === 'steady') finalModel = 'model_A';
          else if (q3 === 'standard') finalModel = 'model_F';
          else if (q3 === 'aggressive') {
            if (q4 === 'no') finalModel = 'model_B';
            else finalModel = 'model_C';
          }
        }
        if (!finalModel) finalModel = 'model_F';
        document.getElementById('modelSelectOverride').value = finalModel;
      }

      globalPlan = [];
      let currentShift = 0;

      for (let i = 1; i <= durationDays; i++) {
        let sleepDur = 8;
        let dayWake, daySleep;
        let stepShift = 0;

        if (finalModel === 'model_A') {
          currentShift = (finalDiff / durationDays) * i;
        } else if (finalModel === 'model_B') {
          let completedRatio = i === durationDays ? 1.0 : (1 - Math.pow(0.5, i));
          currentShift = finalDiff * completedRatio;
        } else if (finalModel === 'model_C') {
          let ratio = Math.pow(i / durationDays, 0.7);
          currentShift = finalDiff * ratio;
        } else if (finalModel === 'model_D') {
          let remaining = finalDiff - currentShift;
          let adaptation = (i > 1) ? 0.8 : 1.0;
          stepShift = remaining * 0.5 * adaptation;
          if (i === durationDays) stepShift = remaining;
          currentShift += stepShift;
        } else if (finalModel === 'model_E') {
          let remaining = finalDiff - currentShift;
          let phaseErr = (remaining / 12) * Math.PI;
          stepShift = 1.5 * Math.sin(phaseErr);
          if (Math.abs(stepShift) > Math.abs(remaining)) stepShift = remaining;
          if (i === durationDays) stepShift = remaining;
          currentShift += stepShift;
        } else if (finalModel === 'model_F') {
          let remaining = finalDiff - currentShift;
          stepShift = remaining * 0.45 * (1 + 0.2 * Math.cos(remaining / 12 * Math.PI));
          if (Math.abs(stepShift) > Math.abs(remaining)) stepShift = remaining;
          if (i === durationDays) stepShift = remaining;
          currentShift += stepShift;
        } else if (finalModel === 'model_G') {
          let remaining = finalDiff - currentShift;
          stepShift = remaining / durationDays;
          currentShift += stepShift;
          if (finalMode === 'ADVANCE') sleepDur = 6.5 + (i * 0.3);
          else sleepDur = 9.0 - (i * 0.2);
        } else if (finalModel === 'model_H') {
          let shiftRatio = finalMode === 'ADVANCE' ? Math.pow(i / durationDays, 0.6) : (i / durationDays);
          currentShift = finalDiff * shiftRatio;
          sleepDur = finalMode === 'ADVANCE' ? (i === 1 ? 6 : 7 + i * 0.1) : (9.5 - i * 0.3);
          if (sleepDur > 8) sleepDur = 8; if (sleepDur < 6) sleepDur = 6;
          if (finalMode === 'DELAY') sleepDur = 9;
        }

        dayWake = wakeInTarget.plus({ hours: (24 * i) + currentShift });
        daySleep = dayWake.minus({ hours: sleepDur });

        globalPlan.push({
          i,
          totalDays: durationDays,
          sleepTime: daySleep,
          wakeTime: dayWake,
          type: finalModel
        });
      }

      document.getElementById('offsetBadge').innerText = `SHIFT: ${finalDiff > 0 ? '+' : ''}${finalDiff.toFixed(1)}H`;
      populate('displayZoneSelect', tZone);
    }

    function renderTimeline() {
      const t = translations[currentLang];
      const container = document.getElementById('timeline');
      container.innerHTML = "";
      const displayZone = document.getElementById('displayZoneSelect').value;
      const badge = document.getElementById('directionBadge');
      if (badge.dataset.key) badge.innerText = t[badge.dataset.key];

      globalPlan.forEach((item, index) => {
        const dispSleep = item.sleepTime.setZone(displayZone);
        const dispWake = item.wakeTime.setZone(displayZone);
        let desc = t[item.type] || item.type;
        const delay = index * 0.1;
        container.innerHTML += `
            <div class="hard-card p-6 anim-stagger" style="animation-delay: ${delay}s">
                <div class="flex justify-between items-center mb-6 border-b border-slate-800 pb-2">
                    <span class="text-xs font-bold text-slate-400 bg-slate-900 border border-slate-700 px-2 py-1">${t.day_prefix} ${item.i}</span>
                    <span class="text-[10px] text-blue-400 font-mono text-right max-w-[70%] leading-tight">${desc}</span>
                </div>
                <div class="grid grid-cols-2 gap-6">
                    <div class="sleep-border bg-[#020617] p-4 pl-5">
                        <p class="text-[10px] text-blue-500 font-bold mb-1 uppercase tracking-wider">${t.label_sleep}</p>
                        <p class="text-3xl font-bold text-white font-mono">${dispSleep.toFormat('HH:mm')}</p>
                        <p class="text-xs text-slate-500 mt-1">${dispSleep.toFormat('MM-dd (cccc)')}</p>
                    </div>
                    <div class="wake-border bg-[#020617] p-4 pl-5">
                        <p class="text-[10px] text-yellow-500 font-bold mb-1 uppercase tracking-wider">${t.label_wake}</p>
                        <p class="text-3xl font-bold text-white font-mono">${dispWake.toFormat('HH:mm')}</p>
                        <p class="text-xs text-slate-500 mt-1">${dispWake.toFormat('MM-dd (cccc)')}</p>
                    </div>
                </div>
            </div>`;
      });
    }

    function exportToCalendar() {
      if (!globalPlan.length) return;
      let icsMsg = "BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//Jetlag//V11//EN\n";
      globalPlan.forEach(item => {
        const fmt = (dt) => dt.toUTC().toFormat("yyyyMMdd'T'HHmmss'Z'");
        icsMsg += `BEGIN:VEVENT\nSUMMARY:Sleep Protocol\nDTSTART:${fmt(item.sleepTime)}\nDTEND:${fmt(item.wakeTime)}\nDESCRIPTION:Mode: ${item.type}\nEND:VEVENT\n`;
      });
      icsMsg += "END:VCALENDAR";
      const blob = new Blob([icsMsg], { type: 'text/calendar;charset=utf-8' });
      const link = document.createElement('a');
      link.href = window.URL.createObjectURL(blob);
      link.setAttribute('download', 'jetlag.ics');
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    initModelSelect();
    populate('sleepZone', Intl.DateTimeFormat().resolvedOptions().timeZone);
    populate('wakeZone', Intl.DateTimeFormat().resolvedOptions().timeZone);
    populate('targetZone', "Asia/Shanghai");
    populate('displayZoneSelect', "Asia/Shanghai");
    initSplitInputs();
    detectPlatform();

    const browserLang = navigator.language || navigator.userLanguage;
    if (browserLang.startsWith('zh')) currentLang = 'zh'; else currentLang = 'en';
    applyLanguage();
  </script>
</body>

</html>