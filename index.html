<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JETLAG COMMANDER // V10.9.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/luxon/3.4.4/luxon.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        
        body { 
            font-family: 'JetBrains Mono', monospace; 
            background-color: #020617; 
            color: #e2e8f0; 
            overflow-x: hidden;
        }

        /* -----------------------
           Wizard Transition
           ----------------------- */
        .view-section {
            display: none;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        .view-section.active {
            display: block;
            opacity: 1;
        }

        /* -----------------------
           Cyberpunk AM/PM Toggle
           ----------------------- */
        .ampm-toggle {
            background: #0f172a;
            border: 1px solid #334155;
            color: #64748b;
            cursor: pointer;
            font-weight: bold;
            padding: 0 12px;
            transition: all 0.2s;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .ampm-toggle.am-active {
            background: #fbbf24; color: #000; border-color: #fbbf24;
            box-shadow: 0 0 10px rgba(251, 191, 36, 0.3);
        }
        .ampm-toggle.pm-active {
            background: #2563eb; color: #fff; border-color: #2563eb;
            box-shadow: 0 0 10px rgba(37, 99, 235, 0.3);
        }

        /* -----------------------
           Cards & Buttons
           ----------------------- */
        .radio-hidden { position: absolute; opacity: 0; width: 0; height: 0; }
        
        .strategy-card {
            cursor: pointer;
            background-color: #0f172a; 
            border: 1px solid #334155; 
            padding: 1.5rem;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: all 0.2s ease-in-out;
            position: relative;
            min-height: 160px; 
        }
        .strategy-card:hover { background-color: #1e293b; border-color: #475569; }
        .radio-hidden:checked + .strategy-card {
            background-color: #064e3b; 
            border-color: #10b981; 
            box-shadow: 0 0 0 1px #10b981 inset;
        }
        .radio-hidden:checked + .strategy-card::after {
            content: 'SELECTED';
            position: absolute;
            top: 0;
            right: 0;
            background: #10b981;
            color: #000;
            font-size: 0.7rem;
            font-weight: bold;
            padding: 2px 6px;
        }

        .dir-label { flex: 1; display: flex; }
        .dir-btn {
            background-color: #0f172a; border: 1px solid #334155; 
            padding: 1rem; text-align: center; cursor: pointer; transition: all 0.2s;
            width: 100%; height: 100%; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .dir-radio:checked + .dir-btn {
            background-color: #1e3a8a; border-color: #60a5fa; color: white;
        }
        .dir-icon { font-size: 1.5rem; margin-bottom: 0.5rem; }

        .hard-card { background-color: #0f172a; border: 1px solid #334155; border-radius: 0; }
        .sleep-border { border-left: 4px solid #3b82f6; } 
        .wake-border { border-left: 4px solid #f97316; } 

        /* Inputs */
        .input-row { display: flex; gap: 8px; }
        
        /* Custom "One Strip" Date Input */
        .date-strip {
            display: flex;
            align-items: center;
            background: #1e293b;
            border: 1px solid #334155;
            padding: 0 12px;
            width: 100%;
            height: 50px; /* Fixed height match */
        }
        .date-strip:focus-within {
            border-color: #10b981;
        }
        .date-part {
            background: transparent;
            border: none;
            color: #f8fafc;
            font-family: inherit;
            font-size: 1rem;
            text-align: center;
            padding: 0;
            outline: none;
        }
        /* Remove spinners */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; margin: 0; 
        }
        input[type=number] { -moz-appearance: textfield; }

        .custom-input {
            background: #1e293b; border: 1px solid #334155; color: #f8fafc;
            padding: 12px; font-family: inherit; font-size: 1rem; text-align: center;
            border-radius: 0; outline: none;
            height: 50px;
        }
        .custom-input:focus { border-color: #10b981; }

        .zone-select {
            flex: 1; background: #0f172a; border: 1px solid #334155;
            color: #94a3b8; font-size: 0.8rem; padding: 12px; text-align: center;
            height: 50px;
        }
        .colon { display: flex; align-items: center; justify-content: center; font-weight: bold; color: #475569; margin: 0 4px; }
        
        .days-input {
            background: #000; border: 1px solid #475569; color: white; 
            width: 50px; text-align: center; padding: 6px; font-size: 0.9rem; margin: 0 8px;
        }
        .card-footer {
            border-top: 1px solid #334155;
            padding-top: 1rem;
            margin-top: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .display-select {
            background-color: #0f172a; color: #10b981; border: 1px solid #334155;
            font-size: 0.75rem; padding: 4px 8px; outline: none; cursor: pointer;
        }

        /* Action Button */
        .action-btn {
            width: 100%;
            background-color: #059669; 
            color: white;
            font-weight: bold;
            padding: 1.25rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            transition: all 0.2s;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.2);
            margin-top: 1rem;
        }
        .action-btn:hover { background-color: #10b981; }
        .action-btn:active { transform: scale(0.98); }

        /* Info Trigger */
        .info-trigger {
            font-size: 0.7rem;
            color: #475569;
            text-decoration: none;
            margin-left: 8px;
            cursor: pointer;
            border: 1px solid #334155;
            padding: 2px 6px;
            border-radius: 4px;
            transition: all 0.2s;
            white-space: nowrap;
            display: inline-block;
        }
        .info-trigger:hover { color: #10b981; border-color: #10b981; }

        .text-yellow-cyber { color: #fbbf24; } 

        /* Knowledge Base */
        .kb-header {
            color: #10b981; font-weight: bold; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.1em;
            margin-bottom: 1rem; border-bottom: 1px solid #334155; padding-bottom: 0.5rem;
        }
        .kb-title { color: #fff; font-weight: bold; margin-bottom: 0.5rem; font-size: 1.1rem; }
        .kb-text { color: #94a3b8; font-size: 0.85rem; line-height: 1.6; margin-bottom: 1.5rem; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-start pt-4 pb-12 px-4 md:pt-12">

    <div class="w-full max-w-6xl relative">
        
        <div class="flex justify-between items-start mb-8 border-b border-slate-800 pb-4 w-full">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold text-emerald-500 tracking-tighter uppercase">JETLAG_COMMANDER <span class="text-slate-600 text-[10px] md:text-xs ml-1 align-bottom">V10.9.2 by Louie Tang</span></h1>
                <p class="text-[10px] text-slate-500 mt-1 tracking-widest">CIRCADIAN RHYTHM OVERRIDE PROTOCOL</p>
            </div>
            <button id="langBtn" onclick="toggleLanguage()" class="text-[10px] border border-slate-700 bg-slate-900 rounded px-2 py-1 text-slate-400 hover:text-emerald-500 hover:border-emerald-500 transition-colors font-bold tracking-wider">
                EN / ä¸­
            </button>
        </div>

        <div id="view-welcome" class="view-section active text-center py-12 max-w-2xl mx-auto">
            <div class="text-6xl mb-6">ğŸ‰</div>
            <h2 class="text-3xl font-bold text-white mb-4 tracking-tight" data-i18n="welcome_title">æ¬¢è¿</h2>
            <p class="text-slate-400 mb-12 px-4 leading-relaxed text-sm md:text-base" data-i18n="welcome_desc">
                Jetlag Commander æ˜¯ä¸€ä¸ªæ™ºèƒ½è°ƒèŠ‚æ—¶å·®çš„ç½‘é¡µ,å¸®åŠ©ä½ ç§‘å­¦çš„å€’æ—¶å·®,åŒ…æ‹¬è·¨å›½é£è¡Œä»¥åŠç†¬å¤œé€ æˆçš„æ—¶å·®ã€‚
            </p>
            <button onclick="goToView(1)" class="action-btn max-w-xs mx-auto" data-i18n="btn_start">
                å¼€å§‹
            </button>
        </div>

        <div id="view-inputs" class="view-section max-w-2xl mx-auto">
            
            <h3 class="text-emerald-500 text-xs font-bold uppercase mb-6 tracking-widest border-l-2 border-emerald-500 pl-3">
                Phase 1: Data Injection
            </h3>

            <div class="space-y-8">
                <div class="space-y-2">
                    <label class="text-xs font-bold text-slate-500 uppercase flex items-center justify-start flex-wrap gap-2">
                        <span data-i18n="step1">Step 1: ä¸Šä¸€æ¬¡å…¥ç¡æ—¶é—´</span>
                        <span class="text-[10px] text-slate-600 font-mono tracking-tight opacity-70">FMT: YYYY/MM/DD</span>
                        <span class="info-trigger" onclick="goToView('info-sleep')" data-i18n="btn_what">[?] è¿™æ˜¯ä»€ä¹ˆ</span>
                    </label>
                    <div class="split-input-container shadow-lg">
                        <div class="date-strip">
                            <input type="number" id="sleepYear" placeholder="YYYY" class="date-part w-16" oninput="if(this.value.length>4) this.value=this.value.slice(0,4)">
                            <span class="colon text-slate-600">/</span>
                            <input type="number" id="sleepMonth" placeholder="MM" class="date-part w-10" oninput="if(this.value.length>2) this.value=this.value.slice(0,2)">
                            <span class="colon text-slate-600">/</span>
                            <input type="number" id="sleepDay" placeholder="DD" class="date-part w-10 flex-1 text-left" oninput="if(this.value.length>2) this.value=this.value.slice(0,2)">
                        </div>
                        
                        <div class="input-row mt-2">
                            <input type="number" id="sleepHH" placeholder="HH" min="1" max="12" class="custom-input time-num flex-1">
                            <span class="colon">:</span>
                            <input type="number" id="sleepMM" placeholder="MM" min="0" max="59" class="custom-input time-num flex-1">
                            <button id="sleepAMPM" class="ampm-toggle" onclick="toggleAMPM('sleepAMPM')">AM</button>
                        </div>
                        <div class="input-row mt-2">
                            <select id="sleepZone" class="zone-select w-full"></select>
                        </div>
                    </div>
                </div>

                <div class="space-y-2">
                    <label class="text-xs font-bold text-slate-500 uppercase flex items-center justify-start flex-wrap gap-2">
                        <span data-i18n="step2">Step 2: ä¸Šä¸€æ¬¡èµ·åºŠæ—¶é—´</span>
                        <span class="text-[10px] text-slate-600 font-mono tracking-tight opacity-70">FMT: YYYY/MM/DD</span>
                        <span class="info-trigger" onclick="goToView('info-wake')" data-i18n="btn_what">[?] è¿™æ˜¯ä»€ä¹ˆ</span>
                    </label>
                    <div class="split-input-container shadow-lg">
                        <div class="date-strip">
                            <input type="number" id="wakeYear" placeholder="YYYY" class="date-part w-16" oninput="if(this.value.length>4) this.value=this.value.slice(0,4)">
                            <span class="colon text-slate-600">/</span>
                            <input type="number" id="wakeMonth" placeholder="MM" class="date-part w-10" oninput="if(this.value.length>2) this.value=this.value.slice(0,2)">
                            <span class="colon text-slate-600">/</span>
                            <input type="number" id="wakeDay" placeholder="DD" class="date-part w-10 flex-1 text-left" oninput="if(this.value.length>2) this.value=this.value.slice(0,2)">
                        </div>

                        <div class="input-row mt-2">
                            <input type="number" id="wakeHH" placeholder="HH" min="1" max="12" class="custom-input time-num flex-1">
                            <span class="colon">:</span>
                            <input type="number" id="wakeMM" placeholder="MM" min="0" max="59" class="custom-input time-num flex-1">
                            <button id="wakeAMPM" class="ampm-toggle" onclick="toggleAMPM('wakeAMPM')">AM</button>
                        </div>
                        <div class="input-row mt-2">
                            <select id="wakeZone" class="zone-select w-full"></select>
                        </div>
                    </div>
                </div>

                <div class="space-y-2">
                    <label class="text-xs font-bold text-emerald-600 uppercase flex items-center justify-start">
                        <span data-i18n="step3">Step 3: ç›®æ ‡æ—¶åŒº</span>
                        <span class="info-trigger border-emerald-900 text-emerald-600 hover:text-emerald-400" onclick="goToView('info-target')" data-i18n="btn_what">[?] è¿™æ˜¯ä»€ä¹ˆ</span>
                    </label>
                    <select id="targetZone" class="w-full bg-slate-900 border border-emerald-900 text-emerald-500 p-4 text-sm focus:outline-none focus:border-emerald-500 rounded-none"></select>
                </div>
            </div>

            <button onclick="goToView(2)" class="action-btn mt-8" data-i18n="btn_next">
                ä¸‹ä¸€æ­¥ >>
            </button>
        </div>

        <div id="view-strategy" class="view-section">
            
            <div class="space-y-4 mb-8">
                <label class="text-xs font-bold text-white uppercase flex items-center justify-start">
                    <span data-i18n="step_dir">æ—¶å·®è°ƒæ•´æ–¹å‘è®¾ç½®</span>
                    <span class="info-trigger" onclick="goToView('info-dir')" data-i18n="btn_what">[?] è¿™æ˜¯ä»€ä¹ˆ</span>
                </label>
                <div class="flex gap-4 flex-col md:flex-row items-stretch">
                    <label class="dir-label">
                        <input type="radio" name="direction" value="smart" class="dir-radio radio-hidden" checked>
                        <div class="dir-btn">
                            <span class="dir-icon">ğŸ¤–</span>
                            <span class="font-bold text-sm" data-i18n="dir_smart">æ™ºèƒ½åˆ¤æ–­ (æ¨è)</span>
                            <span class="text-xs text-slate-400 mt-1" data-i18n="dir_smart_desc">è‡ªåŠ¨è®¡ç®—â€œæ—©ç¡â€ä¸â€œç†¬å¤œâ€çš„ç”Ÿç†ä»£ä»·ï¼Œé€‰æ‹©æœ€ä¼˜è§£ã€‚</span>
                        </div>
                    </label>
                    <label class="dir-label">
                        <input type="radio" name="direction" value="early" class="dir-radio radio-hidden">
                        <div class="dir-btn">
                            <span class="dir-icon">ğŸ›ï¸</span>
                            <span class="font-bold text-sm" data-i18n="dir_early">å¼ºåˆ¶æ—©ç¡</span>
                            <span class="text-xs text-slate-400 mt-1" data-i18n="dir_early_desc">å¼ºè¿«æ—¶é’Ÿå‰ç§»ï¼Œå¯¹èº«ä½“æ›´å‹å¥½ã€‚</span>
                        </div>
                    </label>
                    <label class="dir-label">
                        <input type="radio" name="direction" value="late" class="dir-radio radio-hidden">
                        <div class="dir-btn">
                            <span class="dir-icon">â˜€ï¸</span>
                            <span class="font-bold text-sm" data-i18n="dir_late">å¼ºåˆ¶ç†¬å¤œ</span>
                            <span class="text-xs text-slate-400 mt-1" data-i18n="dir_late_desc">å¼ºè¿«æ—¶é’Ÿåç§»ï¼Œä»…æ¨èæå‰ç¡è§‰ç¡ä¸ç€çš„ã€‚</span>
                        </div>
                    </label>
                </div>
            </div>

            <div class="space-y-4">
                <label class="text-xs font-bold text-white uppercase flex items-center justify-start">
                    <span data-i18n="step_algo">é€‰æ‹©ç®—æ³•æ¨¡å‹</span>
                    <span class="info-trigger" onclick="goToView('info-algo')" data-i18n="btn_what">[?] è¿™æ˜¯ä»€ä¹ˆ</span>
                </label>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    
                    <label>
                        <input type="radio" name="strategy" value="bio_adaptive" class="radio-hidden" checked>
                        <div class="strategy-card">
                            <div>
                                <div class="text-yellow-cyber font-bold text-sm" data-i18n="strat_bio_title">âš¡ï¸ğŸ§ª æ–°æ™ºèƒ½æ¨¡å¼(Beta)</div>
                                <div class="text-xs text-slate-400 mt-2 leading-relaxed" data-i18n="strat_bio_desc">ä¸å¼ºåˆ¶8å°æ—¶ç¡çœ ã€‚æ ¹æ®æ—¶å·®æ–¹å‘åŠ¨æ€å‹ç¼©æˆ–å»¶é•¿ç¡çœ æ—¶é—´ (6-10h)ï¼Œåˆ©ç”¨ç¡çœ å‹åŠ›è¿›è¡Œç›¸ä½é‡å¡‘ã€‚</div>
                            </div>
                            <div class="card-footer">
                                <span class="text-xs text-slate-500" data-i18n="duration">å‘¨æœŸ/å¤©æ•°:</span>
                                <div class="flex items-center">
                                    <input type="number" id="days_bio" value="3" min="2" max="5" class="days-input" onclick="event.stopPropagation()">
                                    <span class="text-xs text-slate-500" data-i18n="label_days">Days</span>
                                </div>
                            </div>
                        </div>
                    </label>

                    <label>
                        <input type="radio" name="strategy" value="scientific" class="radio-hidden">
                        <div class="strategy-card">
                            <div>
                                <div class="text-red-400 font-bold text-sm" data-i18n="strat_sci_title">âš¡ï¸ æ™ºèƒ½ç§‘å­¦</div>
                                <div class="text-xs text-slate-400 mt-2 leading-relaxed" data-i18n="strat_sci_desc">æ¨¡æ‹Ÿç”Ÿç†å…‰ç…§å“åº”æ›²çº¿ (PRC)ã€‚éçº¿æ€§æ­¥è¿›ã€‚</div>
                            </div>
                            <div class="card-footer">
                                <span class="text-xs text-slate-500" data-i18n="duration">å‘¨æœŸ/å¤©æ•°:</span>
                                <div class="flex items-center">
                                    <input type="number" id="days_sci" value="3" min="2" max="5" class="days-input" onclick="event.stopPropagation()">
                                    <span class="text-xs text-slate-500" data-i18n="label_days">Days</span>
                                </div>
                            </div>
                        </div>
                    </label>

                    <label>
                        <input type="radio" name="strategy" value="smart_fold" class="radio-hidden">
                        <div class="strategy-card">
                            <div>
                                <div class="text-emerald-400 font-bold text-sm" data-i18n="strat_fold_title">ğŸ§¬ å¿«é€ŸæŠ˜ä¸­</div>
                                <div class="text-xs text-slate-400 mt-2 leading-relaxed" data-i18n="strat_fold_desc">é«˜æ•ˆæ”¶æ•›ã€‚æ¯æ—¥æ¶ˆé™¤ 50%ã€‚æœ€åä¸€å¤©å¼ºåˆ¶ç†”æ–­ã€‚</div>
                            </div>
                            <div class="card-footer">
                                <span class="text-xs text-slate-500" data-i18n="duration">å‘¨æœŸ/å¤©æ•°:</span>
                                <div class="flex items-center">
                                    <input type="number" id="days_fold" value="4" min="2" max="5" class="days-input" onclick="event.stopPropagation()">
                                    <span class="text-xs text-slate-500" data-i18n="label_days">Days</span>
                                </div>
                            </div>
                        </div>
                    </label>

                    <label>
                        <input type="radio" name="strategy" value="smart_even" class="radio-hidden">
                        <div class="strategy-card">
                            <div>
                                <div class="text-blue-400 font-bold text-sm" data-i18n="strat_even_title">âš–ï¸ çº¿æ€§å‡åˆ†</div>
                                <div class="text-xs text-slate-400 mt-2 leading-relaxed" data-i18n="strat_even_desc">ä¼ ç»Ÿç¨³å¥ã€‚å°†æ—¶å·®å¹³å‡åˆ†é…åˆ°æ¯ä¸€å¤©ã€‚</div>
                            </div>
                            <div class="card-footer">
                                <span class="text-xs text-slate-500" data-i18n="duration">å‘¨æœŸ/å¤©æ•°:</span>
                                <div class="flex items-center">
                                    <input type="number" id="days_even" value="3" min="2" max="5" class="days-input" onclick="event.stopPropagation()">
                                    <span class="text-xs text-slate-500" data-i18n="label_days">Days</span>
                                </div>
                            </div>
                        </div>
                    </label>

                </div>
            </div>

            <div class="flex gap-4 mt-8">
                <button onclick="goToView(1)" class="flex-1 bg-slate-800 text-slate-400 font-bold py-4 text-xs uppercase hover:bg-slate-700 transition-colors">
                    &lt;&lt; Back
                </button>
                <button onclick="executeAndShow()" class="flex-[2] bg-emerald-600 text-white font-bold py-4 text-sm uppercase tracking-widest hover:bg-emerald-500 shadow-[0_0_20px_rgba(16,185,129,0.3)] transition-colors" data-i18n="btn_execute">
                    ç”ŸæˆæŒ‡ä»¤ (EXECUTE)
                </button>
            </div>
        </div>

        <div id="view-results" class="view-section">
            <div class="flex justify-between items-end border-b border-slate-800 pb-2 mb-6">
                <div>
                    <h2 class="text-emerald-500 font-bold text-sm uppercase tracking-widest">Mission Protocol</h2>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="text-[10px] text-slate-500" data-i18n="view_zone">æ˜¾ç¤ºæ—¶åŒº:</span>
                        <select id="displayZoneSelect" class="display-select" onchange="renderTimeline()"></select>
                    </div>
                </div>
                <div class="flex flex-col items-end gap-1">
                    <span id="directionBadge" class="text-[10px] bg-blue-900 text-blue-200 px-2 py-1 font-bold rounded">--</span>
                    <span id="offsetBadge" class="text-[10px] bg-slate-900 text-slate-400 px-2 py-1 font-mono border border-slate-700">--</span>
                </div>
            </div>

            <div id="timeline" class="space-y-4 pb-20"></div>

            <div class="fixed bottom-6 left-0 w-full px-6 flex justify-center">
                <button onclick="goToView(0)" class="bg-slate-900 border border-slate-700 text-slate-400 px-6 py-3 rounded-full text-xs font-bold shadow-2xl hover:text-white hover:border-white transition-all uppercase tracking-widest">
                    â†» Reset
                </button>
            </div>
        </div>

        <div id="info-sleep" class="view-section max-w-2xl mx-auto pt-8">
            <h2 class="kb-header" data-i18n="kb_id_01">DATA ANCHOR 01</h2>
            <h3 class="kb-title" data-i18n="kb_sleep_title">ç”Ÿç†é”šç‚¹ï¼šç”Ÿç‰©é’ŸåŸºçº¿</h3>
            <p class="kb-text" data-i18n="kb_sleep_desc">...</p>
            <button onclick="goToView(1)" class="action-btn mt-8 bg-slate-800 hover:bg-slate-700" data-i18n="btn_return">&lt;&lt; RETURN</button>
        </div>

        <div id="info-wake" class="view-section max-w-2xl mx-auto pt-8">
            <h2 class="kb-header" data-i18n="kb_id_02">DATA ANCHOR 02</h2>
            <h3 class="kb-title" data-i18n="kb_wake_title">å…‰ç…§é‡ç½®ï¼šçš®è´¨é†‡å”¤é†’</h3>
            <p class="kb-text" data-i18n="kb_wake_desc">...</p>
            <button onclick="goToView(1)" class="action-btn mt-8 bg-slate-800 hover:bg-slate-700" data-i18n="btn_return">&lt;&lt; RETURN</button>
        </div>

        <div id="info-target" class="view-section max-w-2xl mx-auto pt-8">
            <h2 class="kb-header" data-i18n="kb_id_03">TARGET FRAME</h2>
            <h3 class="kb-title" data-i18n="kb_target_title">ç›®æ ‡å‚è€ƒç³»</h3>
            <p class="kb-text" data-i18n="kb_target_desc">...</p>
            <button onclick="goToView(1)" class="action-btn mt-8 bg-slate-800 hover:bg-slate-700" data-i18n="btn_return">&lt;&lt; RETURN</button>
        </div>

        <div id="info-dir" class="view-section max-w-2xl mx-auto pt-8">
            <h2 class="kb-header" data-i18n="kb_id_04">VECTOR CONTROL</h2>
            <h3 class="kb-title" data-i18n="kb_dir_title">ç›¸ä½åŠ¨åŠ›å­¦</h3>
            <p class="kb-text" data-i18n="kb_dir_desc">...</p>
            <button onclick="goToView(2)" class="action-btn mt-8 bg-slate-800 hover:bg-slate-700" data-i18n="btn_return">&lt;&lt; RETURN</button>
        </div>

        <div id="info-algo" class="view-section max-w-2xl mx-auto pt-8">
            <h2 class="kb-header" data-i18n="kb_id_05">COMPUTE KERNEL</h2>
            <h3 class="kb-title" data-i18n="kb_algo_title">ç®—æ³•æ¨¡å‹æ¶æ„</h3>
            <h4 class="text-yellow-cyber font-bold text-sm mt-6 mb-2" data-i18n="strat_bio_title">âš¡ï¸ğŸ§ª æ–°æ™ºèƒ½æ¨¡å¼(Beta)</h4>
            <p class="kb-text" data-i18n="kb_algo_bio_desc">...</p>
            <h4 class="text-white font-bold text-sm mt-6 mb-2" data-i18n="strat_sci_title">âš¡ï¸ æ™ºèƒ½ç§‘å­¦</h4>
            <p class="kb-text" data-i18n="kb_algo_sci_desc">...</p>
            <h4 class="text-white font-bold text-sm mt-6 mb-2" data-i18n="strat_even_title">âš–ï¸ çº¿æ€§å‡åˆ†</h4>
            <p class="kb-text" data-i18n="kb_algo_even_desc">...</p>
            <h4 class="text-white font-bold text-sm mt-6 mb-2" data-i18n="strat_fold_title">ğŸ§¬ å¿«é€ŸæŠ˜ä¸­</h4>
            <p class="kb-text" data-i18n="kb_algo_fold_desc">...</p>
            <button onclick="goToView(2)" class="action-btn mt-8 bg-slate-800 hover:bg-slate-700" data-i18n="btn_return">&lt;&lt; RETURN</button>
        </div>

    </div>

    <script>
        const DateTime = luxon.DateTime;

        // --- I18N ---
        const translations = {
            zh: {
                welcome_title: "æ¬¢è¿",
                welcome_desc: "Jetlag Commander æ˜¯ä¸€ä¸ªæ™ºèƒ½è°ƒèŠ‚æ—¶å·®çš„ç½‘é¡µ,å¸®åŠ©ä½ ç§‘å­¦çš„å€’æ—¶å·®,åŒ…æ‹¬è·¨å›½é£è¡Œä»¥åŠç†¬å¤œé€ æˆçš„æ—¶å·®ã€‚",
                btn_start: "å¼€å§‹",
                btn_next: "ä¸‹ä¸€æ­¥ >>",
                btn_execute: "ç”ŸæˆæŒ‡ä»¤ (EXECUTE)",
                btn_what: " [?] è¯´æ˜",
                btn_return: "<< è¿”å›",
                
                step1: "Step 1: ä¸Šä¸€æ¬¡å…¥ç¡æ—¶é—´",
                step2: "Step 2: ä¸Šä¸€æ¬¡èµ·åºŠæ—¶é—´",
                step3: "Step 3: ç›®æ ‡æ—¶åŒº",
                step_dir: "æ—¶å·®è°ƒæ•´æ–¹å‘è®¾ç½®",
                step_algo: "é€‰æ‹©ç®—æ³•æ¨¡å‹",
                
                dir_smart: "æ™ºèƒ½åˆ¤æ–­ (æ¨è)",
                dir_smart_desc: "è‡ªåŠ¨è®¡ç®—â€œæ—©ç¡â€ä¸â€œç†¬å¤œâ€çš„ç”Ÿç†ä»£ä»·ï¼Œé€‰æ‹©æœ€ä¼˜è§£ã€‚",
                dir_early: "å¼ºåˆ¶æ—©ç¡",
                dir_early_desc: "å¼ºè¿«æ—¶é’Ÿå‰ç§»ï¼Œå¯¹èº«ä½“æ›´å‹å¥½ã€‚",
                dir_late: "å¼ºåˆ¶ç†¬å¤œ",
                dir_late_desc: "å¼ºè¿«æ—¶é’Ÿåç§»ï¼Œä»…æ¨èæå‰ç¡è§‰ç¡ä¸ç€çš„ã€‚",

                strat_bio_title: "âš¡ï¸ğŸ§ª æ–°æ™ºèƒ½æ¨¡å¼(Beta)",
                strat_bio_desc: "ä¸å¼ºåˆ¶8å°æ—¶ç¡çœ ã€‚æ ¹æ®æ—¶å·®æ–¹å‘åŠ¨æ€å‹ç¼©æˆ–å»¶é•¿ç¡çœ æ—¶é—´ (6-10h)ï¼Œåˆ©ç”¨ç¡çœ å‹åŠ›è¿›è¡Œç›¸ä½é‡å¡‘ã€‚",
                strat_sci_title: "âš¡ï¸ æ™ºèƒ½ç§‘å­¦",
                strat_sci_desc: "æ¨¡æ‹Ÿç”Ÿç†å…‰ç…§å“åº”æ›²çº¿ (PRC)ã€‚éçº¿æ€§æ­¥è¿›ã€‚",
                strat_even_title: "âš–ï¸ çº¿æ€§å‡åˆ†",
                strat_even_desc: "ä¼ ç»Ÿç¨³å¥ã€‚å°†æ—¶å·®å¹³å‡åˆ†é…åˆ°æ¯ä¸€å¤©ã€‚",
                strat_fold_title: "ğŸ§¬ å¿«é€ŸæŠ˜ä¸­",
                strat_fold_desc: "é«˜æ•ˆæ”¶æ•›ã€‚æ¯æ—¥æ¶ˆé™¤ 50%ã€‚æœ€åä¸€å¤©å¼ºåˆ¶ç†”æ–­ã€‚",
                
                duration: "å‘¨æœŸ/å¤©æ•°:",
                label_days: "å¤©",
                view_zone: "æ˜¾ç¤ºæ—¶åŒº:",
                label_sleep: "å…¥ç¡ (Sleep)",
                label_wake: "å”¤é†’ (Wake)",
                
                desc_bio: "ç”Ÿç‰©è‡ªé€‚åº”ï¼šåŠ¨æ€ç¡çœ é•¿åº¦",
                desc_sci: "ç›¸ä½å‹ç¼©ï¼šé«˜å¼ºåº¦éçº¿æ€§æ­¥è¿›",
                desc_sci_final: "âœ… å¼ºåˆ¶é—­ç¯ï¼šå…‰ç…§é”šå®šå®Œæˆ",
                desc_even: "çº¿æ€§å‡åˆ†ï¼šæ¯æ—¥è°ƒæ•´",
                desc_fold_success: "âœ… åŒºé—´è¾¾æ ‡ (20:00-23:00)ã€‚æå‰å®Œæˆã€‚",
                desc_fold_adjust: "æŠ˜ä¸­æ”¶æ•›ï¼šç›¸ä½è°ƒæ•´",
                desc_fold_force: "âš ï¸ å¼ºåˆ¶æ‰§è¡Œï¼šç³»ç»Ÿæ¥ç®¡ï¼Œé”å®šæœ€ç»ˆä½œæ¯ã€‚",
                day_prefix: "DAY",
                
                badge_smart_early: "MODE: æ™ºèƒ½æ—©ç¡",
                badge_smart_late: "MODE: æ™ºèƒ½ç†¬å¤œ",
                badge_force_early: "MODE: å¼ºåˆ¶æ—©ç¡",
                badge_force_late: "MODE: å¼ºåˆ¶ç†¬å¤œ",

                // KB
                kb_id_01: "DATA ANCHOR 01",
                kb_sleep_title: "ç”Ÿç†é”šç‚¹ï¼šç”Ÿç‰©é’ŸåŸºçº¿",
                kb_sleep_desc: "ç®—æ³•è®¡ç®—éœ€è¦åŸºäºä½ èº«ä½“å½“å‰çš„çœŸå®ç›¸ä½ã€‚è¯·è¾“å…¥ä½ ä¸Šä¸€æ¬¡ç»å†çš„<strong>å®é™…å…¥ç¡æ—¶é—´</strong>ï¼Œå³ä¸­æ¢ç¥ç»ç³»ç»Ÿè¿›å…¥ä¼‘çœ çš„æ—¶é—´ç‚¹ã€‚<br><br>ä¸¥ç¦è¾“å…¥ï¼šæœºç¥¨ä¸Šçš„èµ·é£æ—¶é—´ã€è½åœ°æ—¶é—´æˆ–ä½ â€œè®¡åˆ’â€ç¡è§‰çš„æ—¶é—´ã€‚<br>å¿…é¡»è¾“å…¥ï¼šä½ é—­ä¸Šçœ¼å¹¶å®é™…å¤±å»æ„è¯†çš„æ—¶é—´ã€‚è¿™æ˜¯è®¡ç®—ä½“å†…è¤ªé»‘ç´ åˆ†æ³Œç›¸ä½çš„ç‰©ç†åŸºå‡†ã€‚",
                
                kb_id_02: "DATA ANCHOR 02",
                kb_wake_title: "å…‰ç…§é‡ç½®ï¼šçš®è´¨é†‡å”¤é†’",
                kb_wake_desc: "å”¤é†’æ—¶é—´æ ‡è®°äº†è§†äº¤å‰ä¸Šæ ¸ (SCN) æ¥æ”¶ç¬¬ä¸€ç¼•å…‰çº¿ä¿¡å·çš„æ—¶åˆ»ï¼Œè¿™é€šå¸¸å¯¹åº”ä½“å†…çš®è´¨é†‡è„‰å†²çš„èµ·å§‹ç‚¹ã€‚<br><br>è¯¥æ•°æ®å†³å®šäº†ä½ å½“å‰â€œä¸»è§‚æ—¥â€çš„é•¿åº¦ã€‚ç®—æ³•å°†åˆ©ç”¨æ­¤æ•°æ®è®¡ç®—ä½ çš„å†…æºæ€§èŠ‚å¾‹ä¸ç›®æ ‡æ—¶åŒºä¹‹é—´çš„ç›¸ä½å·® (Î”t)ã€‚æ•°æ®çš„ç²¾ç¡®åº¦ç›´æ¥å†³å®šäº†ç›¸ä½å¹³ç§»çš„æ•ˆç‡ã€‚",
                
                kb_id_03: "TARGET FRAME",
                kb_target_title: "ç›®æ ‡å‚è€ƒç³»",
                kb_target_desc: "è¿™æ˜¯ä½ è¯•å›¾å°†ç”Ÿç‰©é’Ÿâ€œå¹³ç§»â€åˆ°çš„æ–°æ—¶ç©ºåæ ‡ã€‚<br><br>ç³»ç»Ÿå°†è®¡ç®—ä½ çš„ç”Ÿç‰©æ—¶é—´ (Internal Time) ä¸è¯¥åœ°ç†æ—¶é—´ (External Time) ä¹‹é—´çš„åç§»é‡ã€‚è¯·åŠ¡å¿…é€‰æ‹©ç›®çš„åœ°çš„æ ‡å‡†æ—¶é—´ï¼Œè€Œéä¸­è½¬åœ°æ—¶é—´ã€‚",
                
                kb_id_04: "VECTOR CONTROL",
                kb_dir_title: "ç›¸ä½åŠ¨åŠ›å­¦",
                kb_dir_desc: "äººç±»çš„å†…æºæ€§èŠ‚å¾‹å‘¨æœŸå¹³å‡çº¦ä¸º 24.2 å°æ—¶ã€‚è¿™æ„å‘³ç€â€œå‘åæ¨è¿Ÿ (Delay)â€ï¼ˆå¦‚ç†¬å¤œï¼‰é¡ºåº”äº†ç”Ÿç‰©æƒ¯æ€§ï¼Œåœ¨æ­¤æ–¹å‘ä¸Šçš„è°ƒæ•´é˜»åŠ›è¾ƒå°ï¼Œç”Ÿç†ä»£ä»·è¾ƒä½ã€‚<br><br>ç›¸åï¼Œâ€œå‘å‰æå‰ (Advance)â€ï¼ˆå¦‚æ—©èµ·ï¼‰éœ€è¦å‹ç¼©ç”Ÿç‰©èŠ‚å¾‹ï¼Œæ˜¯ä¸€ä¸ªé€†ç†µè¿‡ç¨‹ï¼Œéš¾åº¦è¾ƒå¤§ã€‚<br><br><strong>æ™ºèƒ½åˆ¤æ–­</strong>æ¨¡å—é€šè¿‡è®¡ç®—ä¸¤ç§è·¯å¾„çš„ç”Ÿç†ä»£ä»·å‡½æ•°ï¼Œè‡ªåŠ¨ä¸ºä½ é€‰æ‹©èƒ½è€—æœ€ä½çš„æ–¹æ¡ˆã€‚ä¾‹å¦‚ï¼Œè™½ç„¶æ—©ç¡ 4 å°æ—¶ç†è®ºä¸Šæ›´è¿‘ï¼Œä½†èº«ä½“å¯èƒ½æ— æ³•æ‰§è¡Œï¼Œç³»ç»Ÿå¯èƒ½ä¼šå»ºè®®é€šè¿‡ç†¬å¤œ 20 å°æ—¶æ¥è¾¾æˆåŒç›¸åŒæ­¥ã€‚",
                
                kb_id_05: "COMPUTE KERNEL",
                kb_algo_title: "ç®—æ³•æ¨¡å‹æ¶æ„",
                kb_algo_bio_desc: "è¿™æ˜¯æœ¬ç‰ˆæœ¬å¼•å…¥çš„æœ€å¼ºç®—æ³•ã€‚å®ƒæ‘’å¼ƒäº†â€œæ¯å¤©ç¡8å°æ—¶â€çš„åƒµåŒ–é€»è¾‘ã€‚<br><strong>å‘ä¸œé£/æ—©èµ· (Advance)</strong>ï¼šç®—æ³•ä¼šä¸»åŠ¨å‹ç¼©ç¡çœ æ—¶é—´ï¼ˆå¦‚é¦–æ—¥ä»…6å°æ—¶ï¼‰ï¼Œé€šè¿‡åˆ¶é€ â€œç¡çœ å‹åŠ›â€æ¥å¼ºè¿«èº«ä½“åœ¨æ¬¡æ—¥æ›´æ—©å…¥ç¡ã€‚<br><strong>å‘è¥¿é£/ç†¬å¤œ (Delay)</strong>ï¼šç®—æ³•ä¼šå…è®¸æ›´é•¿çš„æ¢å¤æ€§ç¡çœ ï¼ˆ9-10å°æ—¶ï¼‰ï¼Œåˆ©ç”¨è‡ªç„¶é¿å…‰æ¨è¿Ÿé†’æ¥æ—¶é—´ã€‚",
                kb_algo_sci_desc: "éçº¿æ€§ç›¸ä½å‹ç¼©æ¨¡å‹ã€‚å®ƒä¸éµå¾ªçº¿æ€§å‡åˆ†ï¼Œè€Œæ˜¯æ¨¡æ‹Ÿå…‰ç…§å“åº”æ›²çº¿ (PRC)ã€‚<br>é€»è¾‘æ ¸å¿ƒï¼šåœ¨å‘¨æœŸçš„å‰ 2/3 é˜¶æ®µï¼Œé€šè¿‡ç‰¹å®šçš„ä½œæ¯å®‰æ’åˆ¶é€ é«˜ç¨³æ€ç¡çœ å‹åŠ› (Homeostatic Sleep Pressure)ï¼Œä»¥æ­¤ä½œä¸ºé©±åŠ¨åŠ›å¼ºè¡Œæ¨åŠ¨ 75% çš„ç›¸ä½è¿ç§»ã€‚æœ€åä¸€å¤©è¿›è¡Œè½¯ç€é™†é”šå®šã€‚è¿™æ˜¯ç›®å‰æ•ˆç‡æœ€é«˜çš„ä¿®æ­£æ–¹æ¡ˆã€‚",
                kb_algo_even_desc: "ç®—æœ¯å¹³å‡åˆ†å¸ƒã€‚å°†æ€»æ—¶å·®ç»å¯¹å€¼å¹³å‡åˆ‡å‰²ã€‚<br>è¿™æ˜¯ä¸€ç§æœºæ¢°å¼çš„ä¿å®ˆæ–¹æ¡ˆã€‚ä¼˜ç‚¹æ˜¯æ¯å¤©çš„å˜åŒ–é‡æ’å®šï¼Œèº«ä½“ååº”å¯é¢„æœŸï¼›ç¼ºç‚¹æ˜¯å¯¹äºå¤§æ—¶å·®ï¼ˆ>8å°æ—¶ï¼‰è°ƒæ•´å‘¨æœŸè¿‡é•¿ï¼Œä¸”æœªåˆ©ç”¨ç”Ÿç†æœºèƒ½çš„å¼¹æ€§ã€‚",
                kb_algo_fold_desc: "æ¸è¿›æ”¶æ•›æ¨¡å‹ã€‚åŸºäºåŠè¡°æœŸåŸç†ã€‚<br>æ¯å¤©æ¶ˆé™¤å½“å‰å‰©ä½™æ—¶å·®çš„ 50%ã€‚é¦–æ—¥è°ƒæ•´å¹…åº¦æœ€å¤§ï¼Œéšåå‘ˆæŒ‡æ•°çº§è¡°å‡ã€‚åŒ…å«ä¸€ä¸ªâ€œå¼ºåˆ¶ç†”æ–­å™¨â€ï¼Œåœ¨å‰©ä½™æ—¶å·®å°äºé˜ˆå€¼æ—¶å¼ºè¡Œå¯¹é½ã€‚"
            },
            en: {
                welcome_title: "Welcome",
                welcome_desc: "Jetlag Commander is a smart web tool for adjusting jet lag, helping you scientifically adjust jet lag, including transcontinental flights and staying up late.",
                btn_start: "Start",
                btn_next: "NEXT STEP >>",
                btn_execute: "EXECUTE PROTOCOL",
                btn_what: " [?] Info",
                btn_return: "<< RETURN",
                
                step1: "Step 1: Last Sleep Time",
                step2: "Step 2: Last Wake Time",
                step3: "Step 3: Target Zone",
                step_dir: "Direction Control",
                step_algo: "Algorithm Model",
                
                dir_smart: "Smart Auto (Rec)",
                dir_smart_desc: "Calculates physiological cost of Advance vs Delay.",
                dir_early: "Force Early",
                dir_early_desc: "Forces clock advance. Friendlier to the body.",
                dir_late: "Force Late",
                dir_late_desc: "Forces clock delay. Only recommended if unable to sleep early.",

                strat_bio_title: "âš¡ï¸ğŸ§ª Smart New(Beta)",
                strat_bio_desc: "Variable sleep duration (6-10h). Compresses sleep to advance phase, extends sleep to delay phase.",
                strat_sci_title: "âš¡ï¸ Smart Science",
                strat_sci_desc: "Simulates Physiological PRC. Non-linear stepping.",
                strat_even_title: "âš–ï¸ Linear Even", 
                strat_even_desc: "Conservative. Distributes offset evenly.",
                strat_fold_title: "ğŸ§¬ Rapid Fold",
                strat_fold_desc: "Efficient convergence (50%/day). Force snap.",
                
                duration: "Duration:",
                label_days: "Days",
                view_zone: "View:",
                label_sleep: "Sleep At",
                label_wake: "Wake At",

                desc_bio: "Bio-Adaptive: Dynamic Sleep Duration",
                desc_sci: "Phase Compression: High-intensity shift",
                desc_sci_final: "âœ… Locked: Circadian Anchor Set",
                desc_even: "Linear Even: Daily shift",
                desc_fold_success: "âœ… Target Met (20:00-23:00).",
                desc_fold_adjust: "Fold Convergence: Phase shift",
                desc_fold_force: "âš ï¸ Override: System takeover.",
                day_prefix: "DAY",
                
                badge_smart_early: "MODE: SMART EARLY",
                badge_smart_late: "MODE: SMART LATE",
                badge_force_early: "MODE: FORCE EARLY",
                badge_force_late: "MODE: FORCE LATE",

                kb_id_01: "DATA ANCHOR 01",
                kb_sleep_title: "Biological Anchor: Baseline Onset",
                kb_sleep_desc: "Calculation relies on your current <strong>biological phase</strong>. Please input your <strong>actual last sleep time</strong>.<br><br>Do not input: Flight takeoff time or planned bedtime.<br>Must input: The time you actually fell asleep. This is the physical baseline for melatonin onset calculation.",
                
                kb_id_02: "DATA ANCHOR 02",
                kb_wake_title: "Photic Reset: Cortisol Awakening",
                kb_wake_desc: "Wake time marks the moment the SCN receives the first light signal.<br><br>This defines your current \"subjective day\" length. The algorithm calculates the Phase Difference (Î”t) based on this.",
                
                kb_id_03: "TARGET FRAME",
                kb_target_title: "Reference Frame",
                kb_target_desc: "This is the new spatio-temporal coordinate you are trying to \"shift\" your body into.<br><br>Please select the standard time of your destination, not layover times.",
                
                kb_id_04: "VECTOR CONTROL",
                kb_dir_title: "Phase Dynamics",
                kb_dir_desc: "The human intrinsic circadian period averages ~24.2 hours. Thus, \"Delaying\" (staying up) is easier.<br>\"Advancing\" (waking early) is harder.<br><br><strong>Smart Auto</strong> calculates physiological cost and selects the path of least resistance.",
                
                kb_id_05: "COMPUTE KERNEL",
                kb_algo_title: "Algorithm Architecture",
                kb_algo_bio_desc: "The most advanced algorithm in this version. Discourages rigid 8h sleep.<br><strong>Advance:</strong> Compresses sleep (e.g. 6h) to build sleep pressure.<br><strong>Delay:</strong> Allows extended sleep (9-10h) to naturally drift later.",
                kb_algo_sci_desc: "Non-linear phase compression. Simulates Phase Response Curve (PRC).",
                kb_algo_even_desc: "Arithmetic mean distribution. Splits Î”t evenly over N days.",
                kb_algo_fold_desc: "Half-life convergence. Eliminates 50% of remaining offset daily."
            }
        };

        let currentLang = 'zh';
        let globalPlan = [];

        // --- WIZARD LOGIC ---
        function goToView(targetId) {
            if (typeof targetId === 'number') {
                if(targetId === 0) targetId = 'view-welcome';
                else if(targetId === 1) targetId = 'view-inputs';
                else if(targetId === 2) {
                    const s = getSplitDateTime('sleep');
                    const w = getSplitDateTime('wake');
                    if(!s || !w || !s.isValid || !w.isValid) {
                        alert("INVALID TIME DATA. CHECK INPUTS.");
                        document.getElementById('view-inputs').classList.add('active');
                        return;
                    }
                    if (w <= s) {
                        alert("TEMPORAL PARADOX: Wake time must be after Sleep time.");
                        document.getElementById('view-inputs').classList.add('active');
                        return;
                    }
                    targetId = 'view-strategy';
                }
                else if(targetId === 3) targetId = 'view-results';
            }

            document.querySelectorAll('.view-section').forEach(el => {
                el.classList.remove('active');
            });
            document.getElementById(targetId).classList.add('active');
            window.scrollTo(0,0);
        }

        function executeAndShow() {
            try {
                execute();
                goToView(3);
                setTimeout(() => {
                    renderTimeline();
                }, 10);
            } catch(e) {
                console.error(e);
                alert("CALCULATION ERROR.");
            }
        }

        // --- UI UTILS ---
        function initSplitInputs() {
            const now = DateTime.now();
            const sleepInit = now.minus({hours:8});
            const wakeInit = now;

            // Sleep
            document.getElementById('sleepYear').value = sleepInit.year;
            document.getElementById('sleepMonth').value = sleepInit.month;
            document.getElementById('sleepDay').value = sleepInit.day;
            let sH = sleepInit.hour;
            let sIsPM = sH >= 12;
            if(sH === 0) sH = 12; else if(sH > 12) sH -= 12;
            document.getElementById('sleepHH').value = sH;
            document.getElementById('sleepMM').value = sleepInit.minute;
            setAMPM('sleepAMPM', sIsPM);

            // Wake
            document.getElementById('wakeYear').value = wakeInit.year;
            document.getElementById('wakeMonth').value = wakeInit.month;
            document.getElementById('wakeDay').value = wakeInit.day;
            let wH = wakeInit.hour;
            let wIsPM = wH >= 12;
            if(wH === 0) wH = 12; else if(wH > 12) wH -= 12;
            document.getElementById('wakeHH').value = wH;
            document.getElementById('wakeMM').value = wakeInit.minute;
            setAMPM('wakeAMPM', wIsPM);
        }

        function toggleAMPM(id) {
            const btn = document.getElementById(id);
            const isPM = btn.innerText === 'PM';
            setAMPM(id, !isPM);
        }

        function setAMPM(id, isPM) {
            const btn = document.getElementById(id);
            if(isPM) {
                btn.innerText = 'PM';
                btn.classList.add('pm-active');
                btn.classList.remove('am-active');
            } else {
                btn.innerText = 'AM';
                btn.classList.add('am-active');
                btn.classList.remove('pm-active');
            }
        }

        function getSplitDateTime(prefix) {
            const y = document.getElementById(prefix + 'Year').value;
            const m = document.getElementById(prefix + 'Month').value.padStart(2, '0');
            const d = document.getElementById(prefix + 'Day').value.padStart(2, '0');
            
            let hh = parseInt(document.getElementById(prefix + 'HH').value);
            const mm = parseInt(document.getElementById(prefix + 'MM').value);
            const isPM = document.getElementById(prefix + 'AMPM').innerText === 'PM';
            const zone = document.getElementById(prefix + 'Zone').value;

            if(!y || !m || !d || isNaN(hh) || isNaN(mm)) return null;
            if (isPM && hh < 12) hh += 12;
            if (!isPM && hh === 12) hh = 0;

            const dateStr = `${y}-${m}-${d}`;
            const timeStr = `${hh.toString().padStart(2, '0')}:${mm.toString().padStart(2, '0')}`;
            return DateTime.fromISO(`${dateStr}T${timeStr}`, { zone: zone });
        }

        function toggleLanguage() {
            currentLang = currentLang === 'zh' ? 'en' : 'zh';
            applyLanguage();
        }

        function applyLanguage() {
            const t = translations[currentLang];
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) {
                    el.innerHTML = t[key];
                }
            });
            document.getElementById('langBtn').innerText = currentLang === 'zh' ? 'EN / ä¸­' : 'CN / EN';
            if(document.getElementById('view-results').classList.contains('active')) renderTimeline();
        }

        const rawTimezones = [
            "Asia/Shanghai", "Asia/Tokyo", "Asia/Singapore", "Asia/Kuala_Lumpur", "Asia/Bangkok", 
            "Asia/Dubai", "Asia/Seoul", "Asia/Kolkata", "Asia/Hong_Kong", "Asia/Mumbai",
            "Australia/Melbourne", "Australia/Sydney", "Australia/Brisbane", "Australia/Adelaide", "Australia/Perth", "Pacific/Auckland",
            "Europe/London", "Europe/Paris", "Europe/Berlin", "Europe/Rome", "Europe/Amsterdam", 
            "Europe/Moscow", "Europe/Istanbul", "Europe/Zurich", "Europe/Madrid",
            "America/New_York", "America/Los_Angeles", "America/Toronto", "America/Vancouver", 
            "America/Mexico_City", "America/Sao_Paulo",
            "Africa/Johannesburg"
        ];
        
        function formatZoneDisplay(tz) {
            if (tz === "Asia/Shanghai") return "Asia/China";
            if (tz === "Asia/Hong_Kong") return "Asia/Hong Kong";
            if (tz.startsWith("America/")) {
                if (tz.includes("Sao_Paulo")) return "South America/Brazil";
                if (tz.includes("Mexico")) return "North America/Mexico";
                return tz.replace("America/", "North America/");
            }
            return tz;
        }

        const populate = (id, def) => {
            const el = document.getElementById(id);
            el.innerHTML = "";
            rawTimezones.sort().forEach(tz => {
                const disp = formatZoneDisplay(tz);
                el.add(new Option(disp, tz));
            });
            const userZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            if(!rawTimezones.includes(userZone)) el.add(new Option(userZone, userZone));
            el.value = def || userZone;
        };

        populate('sleepZone', Intl.DateTimeFormat().resolvedOptions().timeZone);
        populate('wakeZone', Intl.DateTimeFormat().resolvedOptions().timeZone);
        populate('targetZone', "Asia/Shanghai");
        populate('displayZoneSelect', "Asia/Shanghai");

        initSplitInputs();
        
        const browserLang = navigator.language || navigator.userLanguage; 
        if (browserLang.startsWith('zh')) currentLang = 'zh'; else currentLang = 'en';
        applyLanguage();

        function execute() {
            const t = translations[currentLang];
            const lastSleep = getSplitDateTime('sleep');
            const lastWake = getSplitDateTime('wake');
            const tZone = document.getElementById('targetZone').value;
            const strategy = document.querySelector('input[name="strategy"]:checked').value;
            const directionMode = document.querySelector('input[name="direction"]:checked').value;

            const wakeInTarget = lastWake.setZone(tZone);
            let idealWake = wakeInTarget.set({ hour: 7, minute: 0, second: 0 });
            let diffRaw = idealWake.diff(wakeInTarget, 'hours').hours;
            
            if (diffRaw > 12) diffRaw -= 24; else if (diffRaw < -12) diffRaw += 24;

            let diffAdvance, diffDelay;
            if (diffRaw <= 0) { diffAdvance = diffRaw; diffDelay = diffRaw + 24; } 
            else { diffAdvance = diffRaw - 24; diffDelay = diffRaw; }

            let finalDiff;
            let finalMode = ""; 

            if (directionMode === 'early') {
                finalDiff = diffAdvance; finalMode = "ADVANCE";
            } else if (directionMode === 'late') {
                finalDiff = diffDelay; finalMode = "DELAY";
            } else {
                const costAdvance = Math.abs(diffAdvance) * 1.5;
                const costDelay = Math.abs(diffDelay) * 1.0;
                if (costAdvance < costDelay) { finalDiff = diffAdvance; finalMode = "ADVANCE"; }
                else { finalDiff = diffDelay; finalMode = "DELAY"; }
            }

            const badge = document.getElementById('directionBadge');
            let badgeKey = "";
            let badgeColor = "";

            if (finalMode === "ADVANCE") {
                badgeColor = "text-[10px] bg-purple-900 text-purple-200 px-2 py-1 font-bold rounded";
                badgeKey = directionMode === 'smart' ? 'badge_smart_early' : 'badge_force_early';
            } else {
                badgeColor = "text-[10px] bg-orange-900 text-orange-200 px-2 py-1 font-bold rounded";
                badgeKey = directionMode === 'smart' ? 'badge_smart_late' : 'badge_force_late';
            }
            
            badge.innerText = t[badgeKey];
            badge.className = badgeColor;
            badge.dataset.key = badgeKey;

            let durationDays = 3;
            if (strategy === 'bio_adaptive') durationDays = parseInt(document.getElementById('days_bio').value);
            else if (strategy === 'scientific') durationDays = parseInt(document.getElementById('days_sci').value);
            else if (strategy === 'smart_even') durationDays = parseInt(document.getElementById('days_even').value);
            else if (strategy === 'smart_fold') durationDays = parseInt(document.getElementById('days_fold').value);

            globalPlan = [];

            if (strategy === 'bio_adaptive') {
                for (let i = 1; i <= durationDays; i++) {
                    let sleepDur = 8; 
                    let shiftRatio = 0;
                    if (finalMode === 'ADVANCE') {
                        if (i === 1) sleepDur = 6.0; 
                        else if (i === 2) sleepDur = 7.0;
                        else sleepDur = 7.5 + (i * 0.1); 
                        if(sleepDur > 8) sleepDur = 8;
                        shiftRatio = Math.pow(i / durationDays, 0.6);
                    } else { 
                        if (i === 1) sleepDur = 9.5;
                        else if (i === 2) sleepDur = 9.0;
                        else sleepDur = 8.5;
                        shiftRatio = (i / durationDays);
                    }
                    let currentShift = finalDiff * shiftRatio;
                    let dayWake = wakeInTarget.plus({ hours: (24 * i) + currentShift });
                    let daySleep = dayWake.minus({ hours: sleepDur });
                    globalPlan.push({ i: i, totalDays: durationDays, sleepTime: daySleep, wakeTime: dayWake, shift: currentShift, type: 'bio', isFinal: i === durationDays, dur: sleepDur });
                }
            }
            else if (strategy === 'scientific') {
                for (let i = 1; i <= durationDays; i++) {
                    let ratio = Math.pow(i / durationDays, 0.7);
                    let shiftAmount = finalDiff * ratio;
                    let dayWake = wakeInTarget.plus({ hours: (24 * i) + shiftAmount });
                    let daySleep = dayWake.minus({ hours: 8 });
                    let currentShift = finalDiff * (ratio - Math.pow((i-1)/durationDays, 0.7));
                    globalPlan.push({ i: i, totalDays: durationDays, sleepTime: daySleep, wakeTime: dayWake, shift: currentShift, type: 'sci', isFinal: i === durationDays });
                }
            } else if (strategy === 'smart_even') {
                const step = finalDiff / durationDays;
                for (let i = 1; i <= durationDays; i++) {
                    let dayWake = wakeInTarget.plus({ hours: 24 * i + (step * i) });
                    let daySleep = dayWake.minus({ hours: 8 });
                    globalPlan.push({ i: i, totalDays: durationDays, sleepTime: daySleep, wakeTime: dayWake, shift: step, type: 'even', isFinal: false });
                }
            } else if (strategy === 'smart_fold') {
                for (let i = 1; i <= durationDays; i++) {
                    let remainingRatio = Math.pow(0.5, i); 
                    let completedRatio = 1 - remainingRatio; 
                    if (i === durationDays) completedRatio = 1.0;
                    let totalShiftSoFar = finalDiff * completedRatio;
                    let dayWake = wakeInTarget.plus({ hours: (24 * i) + totalShiftSoFar });
                    let daySleep = dayWake.minus({ hours: 8 });
                    let sleepHour = daySleep.hour;
                    let success = (sleepHour >= 20 && sleepHour < 23);
                    let moveAmount = Math.abs(totalShiftSoFar - (finalDiff * (1 - Math.pow(0.5, i-1))));
                    globalPlan.push({ i: i, totalDays: durationDays, sleepTime: daySleep, wakeTime: dayWake, shift: moveAmount, type: 'fold', success: success, isFinal: i === durationDays });
                    if (success) break;
                }
            }

            document.getElementById('offsetBadge').innerText = `SHIFT: ${finalDiff > 0 ? '+' : ''}${finalDiff.toFixed(1)}H`;
            populate('displayZoneSelect', tZone);
        }

        function renderTimeline() {
            const t = translations[currentLang];
            const container = document.getElementById('timeline');
            container.innerHTML = "";
            const displayZone = document.getElementById('displayZoneSelect').value;
            const badge = document.getElementById('directionBadge');
            if(badge.dataset.key) badge.innerText = t[badge.dataset.key];

            globalPlan.forEach(item => {
                const dispSleep = item.sleepTime.setZone(displayZone);
                const dispWake = item.wakeTime.setZone(displayZone);
                let desc = "";
                if (item.type === 'bio') desc = `${t.desc_bio} (${item.dur}h)`;
                else if (item.type === 'sci') desc = item.isFinal ? t.desc_sci_final : `${t.desc_sci} ${Math.abs(item.shift).toFixed(1)}h`;
                else if (item.type === 'even') desc = `${t.desc_even} ${Math.abs(item.shift).toFixed(1)}h`;
                else if (item.type === 'fold') {
                    if (item.isFinal) desc = t.desc_fold_force;
                    else if (item.success) desc = t.desc_fold_success;
                    else desc = `${t.desc_fold_adjust} ${item.shift.toFixed(1)}h`;
                }

                const row = document.createElement('div');
                row.className = "hard-card p-6"; 
                row.innerHTML = `
                    <div class="flex justify-between items-center mb-6 border-b border-slate-800 pb-2">
                        <span class="text-xs font-bold text-slate-400 bg-slate-950 border border-slate-800 px-2 py-1">${t.day_prefix} ${item.i}/${item.totalDays}</span>
                        <span class="text-[10px] text-emerald-500 font-mono text-right max-w-[60%] leading-tight">${desc}</span>
                    </div>
                    <div class="grid grid-cols-2 gap-6">
                        <div class="sleep-border bg-slate-950 p-4 pl-5">
                            <p class="text-[10px] text-blue-500 font-bold mb-1 uppercase tracking-wider">${t.label_sleep}</p>
                            <p class="text-3xl font-bold text-white font-mono">${dispSleep.toFormat('HH:mm')}</p>
                            <p class="text-xs text-slate-500 mt-1">${dispSleep.toFormat('MM-dd (cccc)')}</p>
                        </div>
                        <div class="wake-border bg-slate-950 p-4 pl-5">
                            <p class="text-[10px] text-orange-500 font-bold mb-1 uppercase tracking-wider">${t.label_wake}</p>
                            <p class="text-3xl font-bold text-white font-mono">${dispWake.toFormat('HH:mm')}</p>
                            <p class="text-xs text-slate-500 mt-1">${dispWake.toFormat('MM-dd (cccc)')}</p>
                        </div>
                    </div>
                `;
                container.appendChild(row);
            });
        }
    </script>
</body>
</html>
