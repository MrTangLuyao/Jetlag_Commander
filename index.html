<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>JETLAG COMMANDER // v11.1.1 by Louie Tang</title>
  <script src="lib/tailwindcss.js"></script>
  <script src="lib/luxon.min.js"></script>
  <style>
    /* -----------------------
       FONT & RESET
       ----------------------- */
    @font-face {
      font-family: 'JetBrains Mono';
      src: url('lib/JetBrainsMono-Bold.woff2') format('woff2');
      font-weight: normal;
      font-style: normal;
    }

    body {
      font-family: 'JetBrains Mono', "Microsoft YaHei", "PingFang SC", "Helvetica Neue", Helvetica, Arial, sans-serif;
      background-color: #020617;
      color: #e2e8f0;
      overflow-x: hidden;
      -webkit-tap-highlight-color: transparent;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      font-weight: 400;
    }

    input,
    select,
    button {
      outline: none;
    }

    /* -----------------------
       ANIMATIONS
       ----------------------- */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes cyberPulse {
      0% {
        box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4);
      }

      70% {
        box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
      }

      100% {
        box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
      }
    }

    .strategy-card,
    .input-stack,
    .dir-btn {
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .strategy-card:active,
    .input-stack:active,
    .dir-btn:active {
      transform: scale(0.98);
    }

    /* -----------------------
       INPUT SYSTEM
       ----------------------- */
    .input-stack {
      position: relative;
      flex: 1;
      height: 50px;
      background: #1e293b;
      border: 1px solid #334155;
      cursor: pointer;
    }

    body.mode-overlay .input-stack .display-layer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #f8fafc;
      font-weight: bold;
      text-transform: uppercase;
      font-size: 1rem;
      pointer-events: none;
      z-index: 1;
    }

    body.mode-overlay .input-stack .hybrid-input {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      z-index: 10;
      cursor: pointer;
      border: none;
    }

    body.mode-compat .input-stack .display-layer {
      display: none !important;
    }

    body.mode-compat .input-stack .hybrid-input {
      position: relative;
      width: 100%;
      height: 100%;
      opacity: 1 !important;
      background: #1e293b;
      color: white;
      border: none;
      text-align: center;
      font-family: inherit;
      font-weight: bold;
      font-size: 1rem;
      cursor: text;
      color-scheme: dark;
    }

    .compat-active {
      border-color: #fbbf24 !important;
      color: #fbbf24 !important;
      background: rgba(251, 191, 36, 0.1) !important;
    }

    /* -----------------------
       LAYOUT & UI
       ----------------------- */
    .view-section {
      display: none;
      opacity: 0;
    }

    .view-section.active {
      display: block;
      animation: fadeInUp 0.5s cubic-bezier(0.22, 1, 0.36, 1) forwards;
    }

    .split-input-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
      background: #020617;
      border: 1px solid #334155;
      padding: 12px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .row-main {
      display: flex;
      gap: 8px;
      width: 100%;
    }

    .row-zone {
      width: 100%;
    }

    .zone-select {
      width: 100%;
      height: 40px;
      background: #0f172a;
      border: 1px solid #334155;
      color: #94a3b8;
      font-size: 0.8rem;
      padding: 0 12px;
      text-align: center;
      border-radius: 0;
    }

    .ampm-toggle {
      background: #0f172a;
      border: 1px solid #334155;
      color: #64748b;
      cursor: pointer;
      font-weight: bold;
      width: 60px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      flex: none;
    }

    .ampm-toggle.am-active {
      background: #fbbf24;
      color: #000;
      border-color: #fbbf24;
      box-shadow: 0 0 10px rgba(251, 191, 36, 0.3);
    }

    .ampm-toggle.pm-active {
      background: #2563eb;
      color: #fff;
      border-color: #2563eb;
      box-shadow: 0 0 10px rgba(37, 99, 235, 0.3);
    }

    .header-btn {
      text-transform: uppercase;
      font-size: 10px;
      border: 1px solid #334155;
      background: #0f172a;
      border-radius: 4px;
      padding: 4px 8px;
      color: #94a3b8;
      font-weight: bold;
      letter-spacing: 0.05em;
      transition: all 0.2s;
    }

    .header-btn:hover {
      color: #10b981;
      border-color: #10b981;
    }

    .radio-hidden {
      position: absolute;
      opacity: 0;
      width: 0;
      height: 0;
    }

    .strategy-card {
      cursor: pointer;
      background-color: #0f172a;
      border: 1px solid #334155;
      padding: 1.5rem;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      transition: all 0.2s;
      position: relative;
      min-height: 200px;
    }

    .strategy-card:hover {
      background-color: #1e293b;
      border-color: #475569;
      transform: translateY(-2px);
    }

    .radio-hidden:checked+.strategy-card {
      background-color: #064e3b;
      border-color: #10b981;
      box-shadow: 0 0 0 1px #10b981 inset;
    }

    .radio-hidden:checked+.strategy-card::after {
      content: 'SELECTED';
      position: absolute;
      top: 0;
      right: 0;
      background: #10b981;
      color: #000;
      font-size: 0.7rem;
      font-weight: bold;
      padding: 2px 6px;
    }

    .dir-label {
      flex: 1;
      display: flex;
    }

    .dir-btn {
      background-color: #0f172a;
      border: 1px solid #334155;
      padding: 1rem;
      text-align: center;
      cursor: pointer;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .dir-radio:checked+.dir-btn {
      background-color: #1e3a8a;
      border-color: #60a5fa;
      color: white;
    }

    .days-input {
      background: #000;
      border: 1px solid #475569;
      color: white;
      width: 50px;
      text-align: center;
      padding: 6px;
      font-size: 0.9rem;
      margin: 0 8px;
    }

    .card-footer {
      border-top: 1px solid #334155;
      padding-top: 1rem;
      margin-top: 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .action-btn {
      width: 100%;
      background-color: #059669;
      color: white;
      font-weight: bold;
      padding: 1.25rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      transition: all 0.2s;
      animation: cyberPulse 3s infinite;
      margin-top: 1rem;
    }

    .action-btn:hover {
      background-color: #10b981;
      animation: none;
      transform: translateY(-1px);
    }

    .action-btn:active {
      transform: scale(0.98);
    }

    .info-trigger {
      font-size: 0.7rem;
      color: #475569;
      text-decoration: none;
      margin-left: 8px;
      cursor: pointer;
      border: 1px solid #334155;
      padding: 2px 6px;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .info-trigger:hover {
      color: #10b981;
      border-color: #10b981;
    }

    .hard-card {
      background-color: #0f172a;
      border: 1px solid #334155;
    }

    .sleep-border {
      border-left: 4px solid #3b82f6;
    }

    .wake-border {
      border-left: 4px solid #f97316;
    }

    .display-select {
      background-color: #0f172a;
      color: #10b981;
      border: 1px solid #334155;
      font-size: 0.75rem;
      padding: 4px 8px;
    }

    .text-yellow-cyber {
      color: #fbbf24;
    }

    .text-purple-cyber {
      color: #c084fc;
    }

    .kb-header {
      color: #10b981;
      font-weight: bold;
      font-size: 0.8rem;
      border-bottom: 1px solid #334155;
      padding-bottom: 0.5rem;
      margin-bottom: 1rem;
    }

    .kb-title {
      color: #fff;
      font-weight: bold;
      margin-bottom: 0.5rem;
      font-size: 1.1rem;
    }

    .kb-text {
      color: #94a3b8;
      font-size: 0.85rem;
      line-height: 1.6;
      margin-bottom: 1.5rem;
    }

    .anim-stagger {
      opacity: 0;
      animation: fadeInUp 0.5s cubic-bezier(0.22, 1, 0.36, 1) forwards;
    }

    /* Dropdown Styles */
    .pro-select {
      width: 100%;
      background-color: #020617;
      color: #e2e8f0;
      border: 1px solid #334155;
      padding: 8px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.7rem;
      margin-top: 8px;
      outline: none;
    }

    .pro-select:focus {
      border-color: #10b981;
    }
  </style>
</head>

<body class="min-h-screen flex flex-col items-center justify-start pt-4 pb-12 px-4 md:pt-12">

  <div class="w-full max-w-6xl relative">
    <div class="flex justify-between items-start mb-8 border-b border-slate-800 pb-4 w-full">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold text-emerald-500 tracking-tighter uppercase">JETLAG_COMMANDER <span
            class="text-slate-600 text-[10px] md:text-xs ml-1 align-bottom">v11.1.1 by Louie Tang</span></h1>
        <p class="text-[10px] text-slate-500 mt-1 tracking-widest">CIRCADIAN RHYTHM OVERRIDE PROTOCOL</p>
      </div>
      <div class="flex gap-2">
        <button id="licenseBtn" onclick="goToView('view-license')" class="header-btn">LICENSES</button>
        <button id="compatBtn" onclick="toggleCompatMode()" class="header-btn">PC</button>
        <button id="langBtn" onclick="toggleLanguage()" class="header-btn">EN / ä¸­</button>
      </div>
    </div>

    <div id="view-welcome" class="view-section active text-center py-12 max-w-2xl mx-auto">
      <div class="text-6xl mb-6 animate-bounce">ğŸ‰</div>
      <h2 class="text-3xl font-bold text-white mb-4 tracking-tight" data-i18n="welcome_title">æ¬¢è¿</h2>
      <p class="text-slate-400 mb-12 px-4 leading-relaxed text-sm md:text-base" data-i18n="welcome_desc">
        Jetlag Commander æ˜¯ä¸€ä¸ªæ™ºèƒ½è°ƒèŠ‚æ—¶å·®çš„ç½‘é¡µ,å¸®åŠ©ä½ ç§‘å­¦çš„å€’æ—¶å·®,åŒ…æ‹¬è·¨å›½é£è¡Œä»¥åŠç†¬å¤œé€ æˆçš„æ—¶å·®ã€‚
      </p>
      <button onclick="goToView(1)" class="action-btn max-w-xs mx-auto" data-i18n="btn_start">å¼€å§‹</button>
    </div>

    <div id="view-license" class="view-section max-w-2xl mx-auto pt-8">
      <h2 class="kb-header">COMPLIANCE // OPEN SOURCE LICENSES</h2>
      <div class="space-y-6">
        <div>
          <h4 class="text-white font-bold text-sm mb-2">Tailwind CSS</h4>
          <p class="text-[10px] text-slate-500 font-mono">MIT License | Copyright (c) Tailwind Labs, Inc.</p>
        </div>
        <div>
          <h4 class="text-white font-bold text-sm mb-2">Luxon.js</h4>
          <p class="text-[10px] text-slate-500 font-mono">MIT License | Copyright (c) 2017 Isaac Cambron</p>
        </div>
        <div>
          <h4 class="text-white font-bold text-sm mb-2">JetBrains Mono</h4>
          <p class="text-[10px] text-slate-500 font-mono">SIL Open Font License 1.1 | Copyright (c) 2020 JetBrains
            s.r.o.</p>
        </div>
      </div>
      <button onclick="goToView(1)" class="action-btn mt-8 bg-slate-800 hover:bg-slate-700"
        data-i18n="btn_return">&lt;&lt; RETURN</button>
    </div>

    <div id="view-inputs" class="view-section max-w-2xl mx-auto">
      <h3 class="text-emerald-500 text-xs font-bold uppercase mb-6 tracking-widest border-l-2 border-emerald-500 pl-3">
        Phase 1: Data Injection</h3>
      <div class="space-y-8">
        <div class="space-y-2">
          <label class="text-xs font-bold text-slate-500 uppercase flex items-center justify-start">
            <span data-i18n="step1">Step 1: ä¸Šä¸€æ¬¡å…¥ç¡æ—¶é—´</span>
            <span class="info-trigger" onclick="goToView('info-sleep')" data-i18n="btn_what">[?] è¿™æ˜¯ä»€ä¹ˆ</span>
          </label>
          <div class="split-input-container shadow-lg">
            <div class="row-main">
              <div class="input-stack">
                <span id="sleepDateDisplay" class="display-layer">-- MMM</span>
                <input type="date" id="sleepDate" class="hybrid-input"
                  oninput="updateDateDisplay(this, 'sleepDateDisplay')">
              </div>
              <div class="input-stack">
                <span id="sleepTimeDisplay" class="display-layer">--:--</span>
                <input type="time" id="sleepTime" class="hybrid-input"
                  oninput="updateTimeDisplay(this, 'sleepTimeDisplay'); syncAMPM('sleepTime', 'sleepAMPM')"
                  onchange="updateTimeDisplay(this, 'sleepTimeDisplay'); syncAMPM('sleepTime', 'sleepAMPM')">
              </div>
              <button id="sleepAMPM" class="ampm-toggle" onclick="toggleAMPM('sleepAMPM')">AM</button>
            </div>
            <div class="row-zone"><select id="sleepZone" class="zone-select"></select></div>
          </div>
        </div>

        <div class="space-y-2">
          <label class="text-xs font-bold text-slate-500 uppercase flex items-center justify-start">
            <span data-i18n="step2">Step 2: ä¸Šä¸€æ¬¡èµ·åºŠæ—¶é—´</span>
            <span class="info-trigger" onclick="goToView('info-wake')" data-i18n="btn_what">[?] è¿™æ˜¯ä»€ä¹ˆ</span>
          </label>
          <div class="split-input-container shadow-lg">
            <div class="row-main">
              <div class="input-stack">
                <span id="wakeDateDisplay" class="display-layer">-- MMM</span>
                <input type="date" id="wakeDate" class="hybrid-input"
                  oninput="updateDateDisplay(this, 'wakeDateDisplay')">
              </div>
              <div class="input-stack">
                <span id="wakeTimeDisplay" class="display-layer">--:--</span>
                <input type="time" id="wakeTime" class="hybrid-input"
                  oninput="updateTimeDisplay(this, 'wakeTimeDisplay'); syncAMPM('wakeTime', 'wakeAMPM')"
                  onchange="updateTimeDisplay(this, 'wakeTimeDisplay'); syncAMPM('wakeTime', 'wakeAMPM')">
              </div>
              <button id="wakeAMPM" class="ampm-toggle" onclick="toggleAMPM('wakeAMPM')">AM</button>
            </div>
            <div class="row-zone"><select id="wakeZone" class="zone-select"></select></div>
          </div>
        </div>

        <div class="space-y-2">
          <label class="text-xs font-bold text-emerald-600 uppercase flex items-center justify-start">
            <span data-i18n="step3">Step 3: ç›®æ ‡æ—¶åŒº</span>
            <span class="info-trigger border-emerald-900 text-emerald-600 hover:text-emerald-400"
              onclick="goToView('info-target')" data-i18n="btn_what">[?] è¿™æ˜¯ä»€ä¹ˆ</span>
          </label>
          <select id="targetZone"
            class="w-full bg-slate-900 border border-emerald-900 text-emerald-500 p-4 text-sm focus:outline-none focus:border-emerald-500 rounded-none"></select>
        </div>
      </div>
      <button onclick="goToView(2)" class="action-btn mt-8" data-i18n="btn_next">ä¸‹ä¸€æ­¥ >></button>
    </div>

    <div id="view-strategy" class="view-section">
      <div class="space-y-4 mb-8">
        <label class="text-xs font-bold text-white uppercase flex items-center justify-start">
          <span data-i18n="step_dir">æ—¶å·®è°ƒæ•´æ–¹å‘è®¾ç½®</span>
          <span class="info-trigger" onclick="goToView('info-dir')" data-i18n="btn_what">[?] è¿™æ˜¯ä»€ä¹ˆ</span>
        </label>
        <div class="flex gap-4 flex-col md:flex-row items-stretch">
          <label class="dir-label">
            <input type="radio" name="direction" value="smart" class="dir-radio radio-hidden" checked>
            <div class="dir-btn">
              <span class="dir-icon">ğŸ¤–</span>
              <span class="font-bold text-sm" data-i18n="dir_smart">æ™ºèƒ½åˆ¤æ–­ (æ¨è)</span>
              <span class="text-xs text-slate-400 mt-1" data-i18n="dir_smart_desc">è‡ªåŠ¨è®¡ç®—â€œæ—©ç¡â€ä¸â€œç†¬å¤œâ€çš„ç”Ÿç†ä»£ä»·ï¼Œé€‰æ‹©æœ€ä¼˜è§£ã€‚</span>
            </div>
          </label>
          <label class="dir-label">
            <input type="radio" name="direction" value="early" class="dir-radio radio-hidden">
            <div class="dir-btn">
              <span class="dir-icon">ğŸ›ï¸</span>
              <span class="font-bold text-sm" data-i18n="dir_early">å¼ºåˆ¶æ—©ç¡</span>
              <span class="text-xs text-slate-400 mt-1" data-i18n="dir_early_desc">å¼ºè¿«æ—¶é’Ÿå‰ç§»ï¼Œå¯¹èº«ä½“æ›´å‹å¥½ã€‚</span>
            </div>
          </label>
          <label class="dir-label">
            <input type="radio" name="direction" value="late" class="dir-radio radio-hidden">
            <div class="dir-btn">
              <span class="dir-icon">â˜€ï¸</span>
              <span class="font-bold text-sm" data-i18n="dir_late">å¼ºåˆ¶ç†¬å¤œ</span>
              <span class="text-xs text-slate-400 mt-1" data-i18n="dir_late_desc">å¼ºè¿«æ—¶é’Ÿåç§»ï¼Œä»…æ¨èæå‰ç¡è§‰ç¡ä¸ç€çš„ã€‚</span>
            </div>
          </label>
        </div>
      </div>

      <div class="space-y-4">
        <label class="text-xs font-bold text-white uppercase flex items-center justify-start">
          <span data-i18n="step_algo">é€‰æ‹©ç®—æ³•æ¨¡å‹</span>
          <span class="info-trigger" onclick="goToView('info-algo')" data-i18n="btn_what">[?] è¿™æ˜¯ä»€ä¹ˆ</span>
        </label>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">

          <label class="h-full">
            <input type="radio" name="strategy" value="science_pro" class="radio-hidden" checked>
            <div class="strategy-card">
              <div>
                <div class="text-yellow-cyber font-bold text-sm" data-i18n="strat_pro_title">âš¡ï¸ å‰æ²¿æ¨¡å‹ (Beta)</div>
                <div class="text-xs text-slate-400 mt-2 leading-relaxed" data-i18n="strat_pro_desc">åº”ç”¨å‰æ²¿ç”Ÿç‰©æ•°å­¦æ¨¡å‹ã€‚</div>
                <select id="proModelSelect" class="pro-select" onclick="event.stopPropagation()">
                  <option value="model_kronauer" data-i18n="opt_kronauer" selected>model_kronauerï¼ˆæ¨èï¼‰</option>
                  <option value="model_prc" data-i18n="opt_prc">model_prc</option>
                  <option value="model_sthilaire" data-i18n="opt_sthilaire">model_sthilaire</option>
                  <option value="model_borbely" data-i18n="opt_borbely">model_borbely</option>
                </select>
              </div>
              <div class="card-footer">
                <span class="text-xs text-slate-500" data-i18n="duration">å‘¨æœŸ/å¤©æ•°:</span>
                <div class="flex items-center">
                  <input type="number" id="days_pro" value="4" min="2" max="5" class="days-input"
                    onclick="event.stopPropagation()">
                  <span class="text-xs text-slate-500" data-i18n="label_days">Days</span>
                </div>
              </div>
            </div>
          </label>

          <label class="h-full">
            <input type="radio" name="strategy" value="classic" class="radio-hidden">
            <div class="strategy-card">
              <div>
                <div class="text-purple-cyber font-bold text-sm" data-i18n="strat_classic_title">ğŸ“– ç»å…¸æ¨¡å‹</div>
                <div class="text-xs text-slate-400 mt-2 leading-relaxed" data-i18n="strat_classic_desc">åŸºäº Jetlag
                  Commander V10 æ—©æœŸå†…æ ¸ã€‚</div>
                <select id="classicModelSelect" class="pro-select" onclick="event.stopPropagation()">
                  <option value="bio_adaptive" data-i18n="opt_smart_a">æ¨¡å‹ A</option>
                  <option value="scientific" data-i18n="opt_smart_b">æ¨¡å‹ B</option>
                </select>
              </div>
              <div class="card-footer">
                <span class="text-xs text-slate-500" data-i18n="duration">å‘¨æœŸ/å¤©æ•°:</span>
                <div class="flex items-center">
                  <input type="number" id="days_classic" value="3" min="2" max="5" class="days-input"
                    onclick="event.stopPropagation()">
                  <span class="text-xs text-slate-500" data-i18n="label_days">Days</span>
                </div>
              </div>
            </div>
          </label>

          <label class="h-full">
            <input type="radio" name="strategy" value="traditional" class="radio-hidden">
            <div class="strategy-card">
              <div>
                <div class="text-blue-400 font-bold text-sm" data-i18n="strat_trad_title">âš–ï¸ ä¼ ç»Ÿæ¨¡å‹</div>
                <div class="text-xs text-slate-400 mt-2 leading-relaxed" data-i18n="strat_trad_desc">åŸºç¡€çš„ç®—æœ¯ä¸æŠ˜ä¸­æ–¹æ¡ˆã€‚</div>
                <select id="traditionalModelSelect" class="pro-select" onclick="event.stopPropagation()">
                  <option value="smart_fold" data-i18n="opt_fold">å¿«é€ŸæŠ˜ä¸­</option>
                  <option value="smart_even" data-i18n="opt_even">çº¿æ€§å‡åˆ†</option>
                </select>
              </div>
              <div class="card-footer">
                <span class="text-xs text-slate-500" data-i18n="duration">å‘¨æœŸ/å¤©æ•°:</span>
                <div class="flex items-center">
                  <input type="number" id="days_trad" value="3" min="2" max="5" class="days-input"
                    onclick="event.stopPropagation()">
                  <span class="text-xs text-slate-500" data-i18n="label_days">Days</span>
                </div>
              </div>
            </div>
          </label>

        </div>
      </div>

      <div class="flex gap-4 mt-8">
        <button onclick="goToView(1)"
          class="flex-1 bg-slate-800 text-slate-400 font-bold py-4 text-xs uppercase hover:bg-slate-700 transition-colors">&lt;&lt;
          Back</button>
        <button onclick="executeAndShow()"
          class="flex-[2] bg-emerald-600 text-white font-bold py-4 text-sm uppercase tracking-widest hover:bg-emerald-500 shadow-[0_0_20px_rgba(16,185,129,0.3)] transition-colors"
          data-i18n="btn_execute">ç”ŸæˆæŒ‡ä»¤ (EXECUTE)</button>
      </div>
    </div>

    <div id="view-results" class="view-section">
      <div class="flex justify-between items-end border-b border-slate-800 pb-2 mb-6">
        <div>
          <h2 class="text-emerald-500 font-bold text-sm uppercase tracking-widest">Mission Protocol</h2>
          <div class="flex items-center gap-2 mt-1">
            <span class="text-[10px] text-slate-500" data-i18n="view_zone">æ˜¾ç¤ºæ—¶åŒº:</span>
            <select id="displayZoneSelect" class="display-select" onchange="renderTimeline()"></select>
          </div>
        </div>
        <div class="flex flex-col items-end gap-1">
          <span id="directionBadge" class="text-[10px] bg-blue-900 text-blue-200 px-2 py-1 font-bold rounded">--</span>
          <span id="offsetBadge"
            class="text-[10px] bg-slate-900 text-slate-400 px-2 py-1 font-mono border border-slate-700">--</span>
        </div>
      </div>
      <div id="timeline" class="space-y-4 pb-20"></div>
      <div class="fixed bottom-6 left-0 w-full px-6 flex justify-center gap-4">
        <button onclick="exportToCalendar()" data-i18n="btn_export"
          class="bg-emerald-900 border border-emerald-700 text-emerald-400 px-6 py-3 rounded-full text-xs font-bold shadow-2xl hover:text-white hover:border-white transition-all uppercase tracking-widest">ğŸ“…
          æ·»åŠ åˆ°æ—¥å†</button>
        <button onclick="goToView(0)"
          class="bg-slate-900 border border-slate-700 text-slate-400 px-6 py-3 rounded-full text-xs font-bold shadow-2xl hover:text-white hover:border-white transition-all uppercase tracking-widest">â†»
          Reset</button>
      </div>
    </div>

    <div id="info-sleep" class="view-section max-w-2xl mx-auto pt-8">
      <h2 class="kb-header" data-i18n="kb_id_01">DATA ANCHOR 01</h2>
      <h3 class="kb-title" data-i18n="kb_sleep_title">ç”Ÿç†é”šç‚¹ï¼šç”Ÿç‰©é’ŸåŸºçº¿</h3>
      <p class="kb-text" data-i18n="kb_sleep_desc">...</p>
      <button onclick="goToView(1)" class="action-btn mt-8 bg-slate-800 hover:bg-slate-700"
        data-i18n="btn_return">&lt;&lt; RETURN</button>
    </div>
    <div id="info-wake" class="view-section max-w-2xl mx-auto pt-8">
      <h2 class="kb-header" data-i18n="kb_id_02">DATA ANCHOR 02</h2>
      <h3 class="kb-title" data-i18n="kb_wake_title">å…‰ç…§é‡ç½®ï¼šå¼€æœºæ—¶é—´</h3>
      <p class="kb-text" data-i18n="kb_wake_desc">...</p>
      <button onclick="goToView(1)" class="action-btn mt-8 bg-slate-800 hover:bg-slate-700"
        data-i18n="btn_return">&lt;&lt; RETURN</button>
    </div>
    <div id="info-target" class="view-section max-w-2xl mx-auto pt-8">
      <h2 class="kb-header" data-i18n="kb_id_03">TARGET FRAME</h2>
      <h3 class="kb-title" data-i18n="kb_target_title">ç›®æ ‡ï¼šæœ€åé‚£å¼ åºŠ</h3>
      <p class="kb-text" data-i18n="kb_target_desc">...</p>
      <button onclick="goToView(1)" class="action-btn mt-8 bg-slate-800 hover:bg-slate-700"
        data-i18n="btn_return">&lt;&lt; RETURN</button>
    </div>
    <div id="info-dir" class="view-section max-w-2xl mx-auto pt-8">
      <h2 class="kb-header" data-i18n="kb_id_04">VECTOR CONTROL</h2>
      <h3 class="kb-title" data-i18n="kb_dir_title">æ—©ç¡ vs ç†¬å¤œ</h3>
      <p class="kb-text" data-i18n="kb_dir_desc">...</p>
      <button onclick="goToView(2)" class="action-btn mt-8 bg-slate-800 hover:bg-slate-700"
        data-i18n="btn_return">&lt;&lt; RETURN</button>
    </div>

    <div id="info-algo" class="view-section max-w-2xl mx-auto pt-8">
      <h2 class="kb-header" data-i18n="kb_id_05">COMPUTE KERNEL</h2>
      <h3 class="kb-title" data-i18n="kb_algo_title">ç®—æ³•æ¨¡å‹æ¶æ„</h3>

      <h4 class="text-yellow-cyber font-bold text-sm mt-6 mb-2" data-i18n="strat_pro_title">âš¡ï¸ å‰æ²¿æ¨¡å‹ (Beta)</h4>
      <p class="kb-text">
        è¯¥æ¨¡å—é›†æˆäº†å½“å‰æ—¶é—´ç”Ÿç‰©å­¦ï¼ˆChronobiologyï¼‰é¢†åŸŸæœ€æƒå¨çš„æ•°å­¦æ¨¡å‹ã€‚
      </p>

      <div class="overflow-x-auto mt-4 mb-4">
        <table class="w-full text-xs text-left border-collapse">
          <thead>
            <tr>
              <th class="border-b border-slate-600 pb-2 text-slate-300 font-bold" data-i18n="tbl_model">æ¨¡å‹ (Model)</th>
              <th class="border-b border-slate-600 pb-2 text-slate-300 font-bold" data-i18n="tbl_stability">ç¨³å®šæ€§</th>
              <th class="border-b border-slate-600 pb-2 text-slate-300 font-bold" data-i18n="tbl_curve">æ›²çº¿è´¨é‡</th>
              <th class="border-b border-slate-600 pb-2 text-slate-300 font-bold" data-i18n="tbl_eng">å·¥ç¨‹åˆç†æ€§</th>
              <th class="border-b border-slate-600 pb-2 text-slate-300 font-bold" data-i18n="tbl_overall">ç»¼åˆ</th>
            </tr>
          </thead>
          <tbody class="text-slate-400">
            <tr>
              <td class="py-2 border-b border-slate-800">PRC</td>
              <td class="py-2 border-b border-slate-800">6</td>
              <td class="py-2 border-b border-slate-800">7</td>
              <td class="py-2 border-b border-slate-800">6</td>
              <td class="py-2 border-b border-slate-800">6.5</td>
            </tr>
            <tr>
              <td class="py-2 border-b border-slate-800 text-emerald-400 font-bold">Kronauer</td>
              <td class="py-2 border-b border-slate-800 text-emerald-400 font-bold">8</td>
              <td class="py-2 border-b border-slate-800 text-emerald-400 font-bold">8</td>
              <td class="py-2 border-b border-slate-800 text-emerald-400 font-bold">8</td>
              <td class="py-2 border-b border-slate-800 text-emerald-400 font-bold">8</td>
            </tr>
            <tr>
              <td class="py-2 border-b border-slate-800">StHilaire</td>
              <td class="py-2 border-b border-slate-800">9</td>
              <td class="py-2 border-b border-slate-800">5</td>
              <td class="py-2 border-b border-slate-800">7</td>
              <td class="py-2 border-b border-slate-800">7</td>
            </tr>
            <tr>
              <td class="py-2 border-b border-slate-800">BorbÃ©ly</td>
              <td class="py-2 border-b border-slate-800">6</td>
              <td class="py-2 border-b border-slate-800">5</td>
              <td class="py-2 border-b border-slate-800">6</td>
              <td class="py-2 border-b border-slate-800">5.5</td>
            </tr>
          </tbody>
        </table>
      </div>

      <p class="kb-text">
        <strong>Kronauer æŒ¯å­æ¨¡å‹</strong>ï¼šåŸºäº Van der Pol æé™ç¯æŒ¯å­çš„è¿ç»­æ—¶é—´ç§¯åˆ†æ¨¡æ‹Ÿã€‚å®ƒå¼•å…¥äº†éçº¿æ€§åˆšåº¦é¡¹ $\mu(x -
        \frac{4}{3}x^3)$ï¼ŒçœŸå®æ¨¡æ‹Ÿç”Ÿç‰©é’Ÿå¯¹å…‰ç…§çš„ç›¸ä½ä¾èµ–å“åº”ï¼ˆPRCï¼‰ï¼Œæ˜¯å­¦æœ¯ç•Œå…¬è®¤çš„â€œé‡‘æ ‡å‡†â€ã€‚
        <br><br>
        <strong>BorbÃ©ly ä¸¤è¿‡ç¨‹æ¨¡å‹ (Two-Process)</strong>ï¼šç»“åˆäº†æ˜¼å¤œèŠ‚å¾‹ï¼ˆProcess Cï¼‰ä¸ç¡çœ å‹åŠ›ï¼ˆProcess
        Sï¼‰ã€‚å®ƒä¸ä»…è®¡ç®—æ—¶é—´ï¼Œè¿˜è®¡ç®—ä½ çš„â€œå›°å€¦åº¦â€ç§¯ç´¯ä¸æ¶ˆæ•£ï¼Œé€‚åˆéœ€è¦ç²¾ç¡®ç®¡ç†ç²¾åŠ›æ°´å¹³çš„åœºæ™¯ã€‚
      </p>

      <h4 class="text-purple-cyber font-bold text-sm mt-6 mb-2" data-i18n="strat_classic_title">ğŸ“– ç»å…¸æ¨¡å‹</h4>
      <p class="kb-text">
        Jetlag Commander V10 ç‰ˆæœ¬çš„æ ¸å¿ƒç®—æ³•ï¼Œç»è¿‡å¤§é‡ç”¨æˆ·éªŒè¯çš„ç¨³å¥æ–¹æ¡ˆã€‚<br>
        <strong>æ¨¡å‹ A</strong>ï¼šåŠ¨æ€è‡ªé€‚åº”ç®—æ³•ï¼Œä¸å¼ºåˆ¶8å°æ—¶ç¡çœ ï¼Œåˆ©ç”¨ç¡çœ å‰¥å¤ºåŠ é€Ÿæ—¶å·®è°ƒèŠ‚ã€‚<br>
        <strong>æ¨¡å‹ B</strong>ï¼šåŸºäº PRC æ›²çº¿çš„éçº¿æ€§æ­¥è¿›ï¼Œæä¾›æ›´å¹³æ»‘çš„è¿‡æ¸¡ä½“éªŒã€‚
      </p>

      <h4 class="text-blue-400 font-bold text-sm mt-6 mb-2" data-i18n="strat_trad_title">âš–ï¸ ä¼ ç»Ÿæ¨¡å‹</h4>
      <p class="kb-text" data-i18n="strat_trad_desc">åŸºç¡€çš„ç®—æœ¯ä¸æŠ˜ä¸­æ–¹æ¡ˆã€‚</p>

      <button onclick="goToView(2)" class="action-btn mt-8 bg-slate-800 hover:bg-slate-700"
        data-i18n="btn_return">&lt;&lt; RETURN</button>
    </div>
  </div>

  <script>
    const DateTime = luxon.DateTime;

    let currentLang = 'zh';
    let globalPlan = [];
    let isCompatMode = false;

    function detectPlatform() {
      const ua = navigator.userAgent.toLowerCase();
      const isMobile = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(ua);
      const btn = document.getElementById('compatBtn');

      if (isMobile) {
        document.body.classList.add('mode-overlay');
        document.body.classList.remove('mode-compat');
        isCompatMode = false;
        btn.classList.remove('compat-active');
        btn.innerText = "MOBILE";
      } else {
        document.body.classList.add('mode-compat');
        document.body.classList.remove('mode-overlay');
        isCompatMode = true;
        btn.classList.add('compat-active');
        btn.innerText = "PC";
      }
    }

    function toggleCompatMode() {
      isCompatMode = !isCompatMode;
      const btn = document.getElementById('compatBtn');

      if (isCompatMode) {
        document.body.classList.add('mode-compat');
        document.body.classList.remove('mode-overlay');
        btn.classList.add('compat-active');
        btn.innerText = "PC";
      } else {
        document.body.classList.remove('mode-compat');
        document.body.classList.add('mode-overlay');
        btn.classList.remove('compat-active');
        btn.innerText = "MOBILE";
      }
    }

    function updateDateDisplay(inputEl, displayId) {
      const val = inputEl.value;
      if (!val) return;
      const dt = DateTime.fromISO(val);
      document.getElementById(displayId).innerText = dt.setLocale('en').toFormat('dd MMM');
    }

    function updateTimeDisplay(inputEl, displayId) {
      const val = inputEl.value;
      if (!val) return;
      const [h, m] = val.split(':').map(Number);
      let h12 = h % 12;
      if (h12 === 0) h12 = 12;
      const hStr = h12.toString().padStart(2, '0');
      const mStr = m.toString().padStart(2, '0');
      document.getElementById(displayId).innerText = `${hStr}:${mStr}`;
    }

    function syncAMPM(inputId, btnId) {
      const val = document.getElementById(inputId).value;
      if (!val) return;
      const h = parseInt(val.split(':')[0]);
      setAMPM(btnId, h >= 12);
    }

    function toggleAMPM(btnId) {
      const prefix = btnId.replace('AMPM', '');
      const input = document.getElementById(prefix + 'Time');
      if (!input.value) return;
      let [h, m] = input.value.split(':').map(Number);
      if (h < 12) h += 12; else h -= 12;
      input.value = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
      syncAMPM(prefix + 'Time', btnId);
      updateTimeDisplay(input, prefix + 'TimeDisplay');
    }

    function setAMPM(id, isPM) {
      const btn = document.getElementById(id);
      if (isPM) {
        btn.innerText = 'PM';
        btn.classList.add('pm-active');
        btn.classList.remove('am-active');
      } else {
        btn.innerText = 'AM';
        btn.classList.add('am-active');
        btn.classList.remove('pm-active');
      }
    }

    function initSplitInputs() {
      const now = DateTime.now();
      const sleepInit = now.minus({ hours: 8 });
      const wakeInit = now;
      const sDate = document.getElementById('sleepDate');
      const sTime = document.getElementById('sleepTime');
      sDate.value = sleepInit.toFormat('yyyy-MM-dd');
      sTime.value = sleepInit.toFormat('HH:mm');
      updateDateDisplay(sDate, 'sleepDateDisplay');
      updateTimeDisplay(sTime, 'sleepTimeDisplay');
      syncAMPM('sleepTime', 'sleepAMPM');
      const wDate = document.getElementById('wakeDate');
      const wTime = document.getElementById('wakeTime');
      wDate.value = wakeInit.toFormat('yyyy-MM-dd');
      wTime.value = wakeInit.toFormat('HH:mm');
      updateDateDisplay(wDate, 'wakeDateDisplay');
      updateTimeDisplay(wTime, 'wakeTimeDisplay');
      syncAMPM('wakeTime', 'wakeAMPM');
    }

    const translations = {
      zh: {
        welcome_title: "æ¬¢è¿", welcome_desc: "Jetlag Commander æ˜¯ä¸€ä¸ªæ™ºèƒ½è°ƒèŠ‚æ—¶å·®çš„ç½‘é¡µ,å¸®åŠ©ä½ ç§‘å­¦çš„å€’æ—¶å·®,åŒ…æ‹¬è·¨å›½é£è¡Œä»¥åŠç†¬å¤œé€ æˆçš„æ—¶å·®ã€‚", btn_start: "å¼€å§‹", btn_next: "ä¸‹ä¸€æ­¥ >>", btn_execute: "ç”ŸæˆæŒ‡ä»¤ (EXECUTE)", btn_what: " [?] è¯´æ˜", btn_return: "<< è¿”å›", btn_export: "ğŸ“… æ·»åŠ åˆ°æ—¥å†", step1: "Step 1: ä¸Šä¸€æ¬¡å…¥ç¡æ—¶é—´", step2: "Step 2: ä¸Šä¸€æ¬¡èµ·åºŠæ—¶é—´", step3: "Step 3: ç›®æ ‡æ—¶åŒº", step_dir: "æ—¶å·®è°ƒæ•´æ–¹å‘è®¾ç½®", step_algo: "é€‰æ‹©ç®—æ³•æ¨¡å‹",
        dir_smart: "æ™ºèƒ½åˆ¤æ–­ (æ¨è)", dir_smart_desc: "è‡ªåŠ¨è®¡ç®—â€œæ—©ç¡â€ä¸â€œç†¬å¤œâ€çš„ç”Ÿç†ä»£ä»·ï¼Œé€‰æ‹©æœ€ä¼˜è§£ã€‚", dir_early: "å¼ºåˆ¶æ—©ç¡", dir_early_desc: "å¼ºè¿«æ—¶é’Ÿå‰ç§»ï¼Œå¯¹èº«ä½“æ›´å‹å¥½ã€‚", dir_late: "å¼ºåˆ¶ç†¬å¤œ", dir_late_desc: "å¼ºè¿«æ—¶é’Ÿåç§»ï¼Œä»…æ¨èæå‰ç¡è§‰ç¡ä¸ç€çš„ã€‚",
        strat_pro_title: "âš¡ï¸ å‰æ²¿æ¨¡å‹ (Beta)", strat_pro_desc: "åº”ç”¨å‰æ²¿ç”Ÿç‰©æ•°å­¦æ¨¡å‹ã€‚", strat_classic_title: "ğŸ“– ç»å…¸æ¨¡å‹", strat_classic_desc: "åŸºäº Jetlag Commander V10 æ—©æœŸå†…æ ¸ã€‚", strat_trad_title: "âš–ï¸ ä¼ ç»Ÿæ¨¡å‹", strat_trad_desc: "åŸºç¡€çš„ç®—æœ¯ä¸æŠ˜ä¸­æ–¹æ¡ˆã€‚",
        duration: "å‘¨æœŸ/å¤©æ•°:", label_days: "Days", view_zone: "æ˜¾ç¤ºæ—¶åŒº:", label_sleep: "å…¥ç¡ (Sleep)", label_wake: "å”¤é†’ (Wake)",
        opt_kronauer: "model_kronauerï¼ˆæ¨èï¼‰", opt_prc: "model_prc", opt_sthilaire: "model_sthilaire", opt_borbely: "model_borbely",
        opt_smart_a: "æ¨¡å‹ A", opt_smart_b: "æ¨¡å‹ B", opt_fold: "å¿«é€ŸæŠ˜ä¸­", opt_even: "çº¿æ€§å‡åˆ†",
        desc_bio: "ç”Ÿç‰©è‡ªé€‚åº”ï¼šåŠ¨æ€ç¡çœ é•¿åº¦", desc_sci: "ç›¸ä½å‹ç¼©ï¼šé«˜å¼ºåº¦éçº¿æ€§æ­¥è¿›", desc_kronauer: "Kronauer Oscillator: åŠ¨æ€æé™ç¯ä»¿çœŸ", desc_prc: "PRC Sine: æ­£å¼¦ç›¸ä½å“åº”æ›²çº¿", desc_borbely: "Two-Process: ç¡çœ å‹åŠ›ç¨³æ€è°ƒèŠ‚", desc_sthilaire: "St Hilaire: å…‰é€‚åº”è€¦åˆæ¨¡å‹", desc_fold: "å¿«é€ŸæŠ˜ä¸­ï¼šæ¯æ—¥50%æ”¶æ•›", desc_even: "çº¿æ€§å‡åˆ†ï¼šæ¯æ—¥å¹³å‡è°ƒæ•´",
        day_prefix: "DAY", badge_smart_early: "MODE: æ™ºèƒ½æ—©ç¡", badge_smart_late: "MODE: æ™ºèƒ½ç†¬å¤œ", badge_force_early: "MODE: å¼ºåˆ¶æ—©ç¡", badge_force_late: "MODE: å¼ºåˆ¶ç†¬å¤œ", kb_id_01: "DATA ANCHOR 01", kb_sleep_title: "æ—¶é—´é”šç‚¹:å…¥ç¡æ—¶é—´", kb_sleep_desc: "åˆ«å¡«é£æœºèµ·é£æ—¶é—´ï¼åˆ«å¡«ä½ æ‰“ç®—å‡ ç‚¹ç¡ï¼<br>è¿™é‡Œè¦çš„æ˜¯ä½ <strong>ä¸Šæ¬¡ç¡è§‰ç¡ç€çš„å¤§è‡´æ—¶é—´</strong>", kb_id_02: "DATA ANCHOR 02", kb_wake_title: "æ—¶é—´é”šç‚¹ï¼šä¸Šä¸€æ¬¡èµ·åºŠæ—¶é—´", kb_wake_desc: "å¡«å†™<strong>ä»Šå¤©èµ·åºŠ</strong>çš„æ—¶é—´ã€‚<br><br>", kb_id_03: "TARGET FRAME", kb_target_title: "ç›®æ ‡æ—¶åŒº", kb_target_desc: "å¡«å†™ä½ æƒ³å€’çš„ç›®æ ‡åœ°ç‚¹<br><br>åˆ«ç®¡ä¸­è½¬åœ°ï¼Œåˆ«ç®¡ç»åœç«™ï¼Œç›´æ¥é€‰æœ€ç»ˆç›®çš„åœ°ã€‚å¦‚æœæ˜¯ç†¬å¤œå€’æ—¶å·®åˆ™ä¿æŒç°æœ‰åœ°å°±è¡Œ", kb_id_04: "VECTOR CONTROL", kb_dir_title: "æ—©ç¡ vs ç†¬å¤œ", kb_dir_desc: "äººè¿™èº«ä½“å•Šï¼Œ<strong>ç†¬å¤œå®¹æ˜“æ—©èµ·éš¾</strong>ã€‚ä¸€å¤©24å°æ—¶ï¼Œä½†ç”Ÿç‰©é’Ÿå…¶å®æœ‰ç‚¹â€œæ‹–å»¶ç—‡â€ï¼ˆ24.2å°æ—¶ï¼‰ï¼Œæ‰€ä»¥æ™šç¡å®ƒæ˜¯å¼€å¿ƒçš„ï¼Œæ—©èµ·å®ƒæ˜¯æŠ—æ‹’çš„ã€‚<br><br><strong>æ™ºèƒ½åˆ¤æ–­</strong>ï¼šç³»ç»Ÿä¼šè‡ªåŠ¨å¸®ä½ ç®—ç®—ï¼Œæ˜¯ç°åœ¨å’¬ç‰™å°‘ç¡å‡ å°æ—¶åˆ’ç®—ï¼Œè¿˜æ˜¯å¹²è„†é€šå®µç†¬ä¸€ç†¬æ›´è½»æ¾ã€‚ç›¸ä¿¡ç®—æ³•ï¼Œå®ƒæ˜¯ä¸“ä¸šçš„ï¼Œèƒ½è®©ä½ å°‘å—ç‚¹ç½ªã€‚", kb_id_05: "COMPUTE KERNEL", kb_algo_title: "ç®—æ³•æ¨¡å‹æ¶æ„",
        tbl_model: "æ¨¡å‹", tbl_stability: "ç¨³å®šæ€§", tbl_curve: "æ›²çº¿è´¨é‡", tbl_eng: "å·¥ç¨‹åˆç†æ€§", tbl_overall: "ç»¼åˆ"
      }, en: {
        welcome_title: "Welcome", welcome_desc: "Jetlag Commander is a smart web tool for adjusting jet lag, helping you scientifically adjust jet lag, including transcontinental flights and staying up late.", btn_start: "Start", btn_next: "NEXT STEP >>", btn_execute: "EXECUTE PROTOCOL", btn_what: " [?] Info", btn_return: "<< RETURN", btn_export: "ğŸ“… Add to Calendar", step1: "Step 1: Last Sleep Time", step2: "Step 2: Last Wake Time", step3: "Step 3: Target Zone", step_dir: "Direction Control", step_algo: "Algorithm Model",
        dir_smart: "Smart Auto (Rec)", dir_smart_desc: "Calculates physiological cost of Advance vs Delay.", dir_early: "Force Early", dir_early_desc: "Forces clock advance. Friendlier to the body.", dir_late: "Force Late", dir_late_desc: "Forces clock delay. Only recommended if unable to sleep early.",
        strat_pro_title: "âš¡ï¸ Frontier Model (Beta)", strat_pro_desc: "Advanced Biomathematical Models.", strat_classic_title: "ğŸ“– Classic Model", strat_classic_desc: "Based on V10 Legacy Kernels.", strat_trad_title: "âš–ï¸ Traditional", strat_trad_desc: "Basic arithmetic & fold methods.",
        duration: "Duration:", label_days: "Days", view_zone: "View:", label_sleep: "Sleep At", label_wake: "Wake At",
        opt_kronauer: "model_kronauer (Rec)", opt_prc: "model_prc", opt_sthilaire: "model_sthilaire", opt_borbely: "model_borbely",
        opt_smart_a: "Model A", opt_smart_b: "Model B", opt_fold: "Rapid Fold", opt_even: "Linear Even",
        desc_bio: "Bio-Adaptive: Dynamic Sleep Duration", desc_sci: "Phase Compression: High-intensity shift", desc_kronauer: "Kronauer Oscillator: Limit Cycle Sim", desc_prc: "PRC Sine: Sinusoidal Response", desc_borbely: "Two-Process: Homeostatic Regulation", desc_sthilaire: "St Hilaire: Photic Adaptation", desc_fold: "Rapid Fold: 50% Decay/Day", desc_even: "Linear Even: Arithmetic Mean",
        day_prefix: "DAY", badge_smart_early: "MODE: SMART EARLY", badge_smart_late: "MODE: SMART LATE", badge_force_early: "MODE: FORCE EARLY", badge_force_late: "MODE: FORCE LATE", kb_id_01: "DATA ANCHOR 01", kb_sleep_title: "Real Sleep Time: When You Blacked Out", kb_sleep_desc: "Don't put your flight takeoff time! Don't put when you 'planned' to sleep!<br><br>We need the exact moment you actually <strong>closed your eyes and drifted off</strong>. The algorithm needs to know when your biological battery started charging. Garbage in, garbage out.", kb_id_02: "DATA ANCHOR 02", kb_wake_title: "System Boot: When You Opened Your Eyes", kb_wake_desc: "This is simply when you <strong>opened your eyes</strong> today. Whether you woke up naturally or a chaotic alarm dragged you out, this moment started your biological day.<br><br>This timestamp tells us exactly where your internal clock is currently pointing. Don't lie about snoozing.", kb_id_03: "TARGET FRAME", kb_target_title: "The Goal: Final Destination", kb_target_desc: "Where are you headed? Select the <strong>standard time</strong> of your final destination.<br><br>Ignore layovers, ignore stopovers. Your body only cares about where it's going to crash tonight.", kb_id_04: "VECTOR CONTROL", kb_dir_title: "Hard Mode vs Easy Mode", kb_dir_desc: "Here's the truth: <strong>Staying up (Delaying) is easy, waking up early (Advancing) is hard.</strong> Your body naturally wants to drift later.<br><br><strong>Smart Auto</strong>: Let the system do the math. It calculates if it's less painful to force yourself awake or just power through and stay up late. Trust the math.", kb_id_05: "COMPUTE KERNEL", kb_algo_title: "Algorithm Architecture",
        tbl_model: "Model", tbl_stability: "Stability", tbl_curve: "Curve Quality", tbl_eng: "Engineering", tbl_overall: "Overall"
      }
    };

    function goToView(targetId) {
      if (typeof targetId === 'number') {
        if (targetId === 0) targetId = 'view-welcome';
        else if (targetId === 1) targetId = 'view-inputs';
        else if (targetId === 2) {
          const s = getSplitDateTime('sleep');
          const w = getSplitDateTime('wake');
          if (!s || !w || !s.isValid || !w.isValid) { alert("INVALID TIME DATA. CHECK INPUTS."); document.getElementById('view-inputs').classList.add('active'); return; }
          if (w <= s) { alert("TEMPORAL PARADOX: Wake time must be after Sleep time."); document.getElementById('view-inputs').classList.add('active'); return; }
          targetId = 'view-strategy';
        }
        else if (targetId === 3) targetId = 'view-results';
      }
      document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
      document.getElementById(targetId).classList.add('active');
      window.scrollTo(0, 0);
    }

    function executeAndShow() {
      try { execute(); goToView(3); setTimeout(() => renderTimeline(), 10); }
      catch (e) { console.error(e); alert("CALCULATION ERROR: " + e.message); }
    }

    function getSplitDateTime(prefix) {
      const dateStr = document.getElementById(prefix + 'Date').value;
      const timeStr = document.getElementById(prefix + 'Time').value;
      const zone = document.getElementById(prefix + 'Zone').value;
      if (!dateStr || !timeStr) return null;
      return DateTime.fromISO(`${dateStr}T${timeStr}`, { zone: zone });
    }

    function toggleLanguage() { currentLang = currentLang === 'zh' ? 'en' : 'zh'; applyLanguage(); }

    function applyLanguage() {
      const t = translations[currentLang];
      document.querySelectorAll('[data-i18n]').forEach(el => { const key = el.getAttribute('data-i18n'); if (t[key]) el.innerHTML = t[key]; });
      document.getElementById('langBtn').innerText = currentLang === 'zh' ? 'EN / ä¸­' : 'CN / EN';
      if (document.getElementById('view-results').classList.contains('active')) renderTimeline();
    }

    const rawTimezones = ["Asia/Shanghai", "Asia/Tokyo", "Asia/Singapore", "Asia/Kuala_Lumpur", "Asia/Bangkok", "Asia/Dubai", "Asia/Seoul", "Asia/Kolkata", "Asia/Hong_Kong", "Asia/Mumbai", "Australia/Melbourne", "Australia/Sydney", "Australia/Brisbane", "Australia/Adelaide", "Australia/Perth", "Pacific/Auckland", "Europe/London", "Europe/Paris", "Europe/Berlin", "Europe/Rome", "Europe/Amsterdam", "Europe/Moscow", "Europe/Istanbul", "Europe/Zurich", "Europe/Madrid", "America/New_York", "America/Los_Angeles", "America/Toronto", "America/Vancouver", "America/Mexico_City", "America/Sao_Paulo", "Africa/Johannesburg"];

    function formatZoneDisplay(tz) {
      if (tz === "Asia/Shanghai") return "Asia/China";
      if (tz === "Asia/Hong_Kong") return "Asia/Hong Kong";
      if (tz.startsWith("America/")) return tz.replace("America/", "North America/");
      return tz;
    }

    const populate = (id, def) => {
      const el = document.getElementById(id);
      el.innerHTML = "";
      rawTimezones.sort().forEach(tz => { el.add(new Option(formatZoneDisplay(tz), tz)); });
      const userZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
      if (!rawTimezones.includes(userZone)) el.add(new Option(userZone, userZone));
      el.value = def || userZone;
    };

    function execute() {
      const t = translations[currentLang];
      const lastSleep = getSplitDateTime('sleep');
      const lastWake = getSplitDateTime('wake');
      const tZone = document.getElementById('targetZone').value;

      const strategyMain = document.querySelector('input[name="strategy"]:checked').value;
      const directionMode = document.querySelector('input[name="direction"]:checked').value;

      const wakeInTarget = lastWake.setZone(tZone);

      let idealWake = wakeInTarget.set({ hour: 7, minute: 0, second: 0 });
      let diffRaw = idealWake.diff(wakeInTarget, 'hours').hours;
      if (diffRaw > 12) diffRaw -= 24; else if (diffRaw < -12) diffRaw += 24;

      let diffAdvance, diffDelay;
      if (diffRaw <= 0) { diffAdvance = diffRaw; diffDelay = diffRaw + 24; }
      else { diffAdvance = diffRaw - 24; diffDelay = diffRaw; }

      let finalDiff, finalMode;
      if (directionMode === 'early') { finalDiff = diffAdvance; finalMode = "ADVANCE"; }
      else if (directionMode === 'late') { finalDiff = diffDelay; finalMode = "DELAY"; }
      else {
        const costAdvance = Math.abs(diffAdvance) * 1.5;
        const costDelay = Math.abs(diffDelay) * 1.0;
        if (costAdvance < costDelay) { finalDiff = diffAdvance; finalMode = "ADVANCE"; }
        else { finalDiff = diffDelay; finalMode = "DELAY"; }
      }

      const badge = document.getElementById('directionBadge');
      let badgeKey = "";
      let badgeColor = "";
      if (finalMode === "ADVANCE") {
        badgeColor = "text-[10px] bg-purple-900 text-purple-200 px-2 py-1 font-bold rounded";
        badgeKey = directionMode === 'smart' ? 'badge_smart_early' : 'badge_force_early';
      } else {
        badgeColor = "text-[10px] bg-orange-900 text-orange-200 px-2 py-1 font-bold rounded";
        badgeKey = directionMode === 'smart' ? 'badge_smart_late' : 'badge_force_late';
      }
      badge.innerText = t[badgeKey];
      badge.className = badgeColor;
      badge.dataset.key = badgeKey;

      // Determine Sub-Model & Duration
      let durationDays = 3;
      let finalModel = "unknown";

      if (strategyMain === 'science_pro') {
        durationDays = parseInt(document.getElementById('days_pro').value);
        finalModel = document.getElementById('proModelSelect').value;
      }
      else if (strategyMain === 'classic') {
        durationDays = parseInt(document.getElementById('days_classic').value);
        finalModel = document.getElementById('classicModelSelect').value;
      }
      else if (strategyMain === 'traditional') {
        durationDays = parseInt(document.getElementById('days_trad').value);
        finalModel = document.getElementById('traditionalModelSelect').value;
      }

      globalPlan = [];
      let currentShift = 0;

      for (let i = 1; i <= durationDays; i++) {
        let sleepDur = 8;
        let dayWake, daySleep, typeDesc;
        let stepShift = 0;

        // A. Classic - Model A (Bio Adaptive)
        if (finalModel === 'bio_adaptive') {
          let shiftRatio = finalMode === 'ADVANCE' ? Math.pow(i / durationDays, 0.6) : (i / durationDays);
          currentShift = finalDiff * shiftRatio;
          sleepDur = finalMode === 'ADVANCE' ? (i === 1 ? 6 : 7 + i * 0.1) : (9.5 - i * 0.3);
          if (sleepDur > 8) sleepDur = 8; if (sleepDur < 6) sleepDur = 6;
          if (finalMode === 'DELAY') sleepDur = 9;
          typeDesc = 'desc_bio';
        }
        // B. Classic - Model B (Scientific)
        else if (finalModel === 'scientific') {
          let ratio = Math.pow(i / durationDays, 0.7);
          currentShift = finalDiff * ratio;
          typeDesc = 'desc_sci';
        }
        // C. Traditional - Fold
        else if (finalModel === 'smart_fold') {
          let completedRatio = i === durationDays ? 1.0 : (1 - Math.pow(0.5, i));
          currentShift = finalDiff * completedRatio;
          typeDesc = 'desc_fold';
        }
        // D. Traditional - Even
        else if (finalModel === 'smart_even') {
          currentShift = (finalDiff / durationDays) * i;
          typeDesc = 'desc_even';
        }
        // E. Science Pro Models
        else {
          if (finalModel === 'model_prc') {
            let remaining = finalDiff - currentShift;
            let phaseErr = (remaining / 12) * Math.PI;
            let A = 1.5;
            stepShift = A * Math.sin(phaseErr);
            if (Math.abs(stepShift) > Math.abs(remaining)) stepShift = remaining;
            if (i === durationDays) stepShift = remaining;
            currentShift += stepShift;
            typeDesc = 'desc_prc';
          }
          else if (finalModel === 'model_kronauer') {
            let remaining = finalDiff - currentShift;
            stepShift = remaining * 0.45 * (1 + 0.2 * Math.cos(remaining / 12 * Math.PI));
            if (Math.abs(stepShift) > Math.abs(remaining)) stepShift = remaining;
            if (i === durationDays) stepShift = remaining;
            currentShift += stepShift;
            typeDesc = 'desc_kronauer';
          }
          else if (finalModel === 'model_sthilaire') {
            let remaining = finalDiff - currentShift;
            let adaptation = (i > 1) ? 0.8 : 1.0;
            stepShift = remaining * 0.5 * adaptation;
            if (i === durationDays) stepShift = remaining;
            currentShift += stepShift;
            typeDesc = 'desc_sthilaire';
          }
          else if (finalModel === 'model_borbely') {
            let remaining = finalDiff - currentShift;
            stepShift = remaining / durationDays;
            currentShift += stepShift;
            if (finalMode === 'ADVANCE') sleepDur = 6.5 + (i * 0.3);
            else sleepDur = 9.0 - (i * 0.2);
            typeDesc = 'desc_borbely';
          }
        }

        // Apply Shift
        dayWake = wakeInTarget.plus({ hours: (24 * i) + currentShift });
        daySleep = dayWake.minus({ hours: sleepDur });

        globalPlan.push({
          i,
          totalDays: durationDays,
          sleepTime: daySleep,
          wakeTime: dayWake,
          type: typeDesc
        });
      }

      document.getElementById('offsetBadge').innerText = `SHIFT: ${finalDiff > 0 ? '+' : ''}${finalDiff.toFixed(1)}H`;
      populate('displayZoneSelect', tZone);
    }

    function renderTimeline() {
      const t = translations[currentLang];
      const container = document.getElementById('timeline');
      container.innerHTML = "";
      const displayZone = document.getElementById('displayZoneSelect').value;
      const badge = document.getElementById('directionBadge');
      if (badge.dataset.key) badge.innerText = t[badge.dataset.key];

      globalPlan.forEach((item, index) => {
        const dispSleep = item.sleepTime.setZone(displayZone);
        const dispWake = item.wakeTime.setZone(displayZone);
        let desc = t[item.type] || item.type;
        const delay = index * 0.1;
        container.innerHTML += `
            <div class="hard-card p-6 anim-stagger" style="animation-delay: ${delay}s">
                <div class="flex justify-between items-center mb-6 border-b border-slate-800 pb-2">
                    <span class="text-xs font-bold text-slate-400 bg-slate-950 border border-slate-800 px-2 py-1">${t.day_prefix} ${item.i}</span>
                    <span class="text-[10px] text-emerald-500 font-mono text-right max-w-[60%] leading-tight">${desc}</span>
                </div>
                <div class="grid grid-cols-2 gap-6">
                    <div class="sleep-border bg-slate-950 p-4 pl-5">
                        <p class="text-[10px] text-blue-500 font-bold mb-1 uppercase tracking-wider">${t.label_sleep}</p>
                        <p class="text-3xl font-bold text-white font-mono">${dispSleep.toFormat('HH:mm')}</p>
                        <p class="text-xs text-slate-500 mt-1">${dispSleep.toFormat('MM-dd (cccc)')}</p>
                    </div>
                    <div class="wake-border bg-slate-950 p-4 pl-5">
                        <p class="text-[10px] text-orange-500 font-bold mb-1 uppercase tracking-wider">${t.label_wake}</p>
                        <p class="text-3xl font-bold text-white font-mono">${dispWake.toFormat('HH:mm')}</p>
                        <p class="text-xs text-slate-500 mt-1">${dispWake.toFormat('MM-dd (cccc)')}</p>
                    </div>
                </div>
            </div>`;
      });
    }

    function exportToCalendar() {
      if (!globalPlan.length) return;
      let icsMsg = "BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//Jetlag//V11//EN\n";
      globalPlan.forEach(item => {
        const fmt = (dt) => dt.toUTC().toFormat("yyyyMMdd'T'HHmmss'Z'");
        icsMsg += `BEGIN:VEVENT\nSUMMARY:Sleep (Jetlag Protocol)\nDTSTART:${fmt(item.sleepTime)}\nDTEND:${fmt(item.wakeTime)}\nDESCRIPTION:Mode: ${item.type}\nEND:VEVENT\n`;
      });
      icsMsg += "END:VCALENDAR";
      const blob = new Blob([icsMsg], { type: 'text/calendar;charset=utf-8' });
      const link = document.createElement('a');
      link.href = window.URL.createObjectURL(blob);
      link.setAttribute('download', 'jetlag.ics');
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    populate('sleepZone', Intl.DateTimeFormat().resolvedOptions().timeZone);
    populate('wakeZone', Intl.DateTimeFormat().resolvedOptions().timeZone);
    populate('targetZone', "Asia/Shanghai");
    populate('displayZoneSelect', "Asia/Shanghai");
    initSplitInputs();
    detectPlatform();

    const browserLang = navigator.language || navigator.userLanguage;
    if (browserLang.startsWith('zh')) currentLang = 'zh'; else currentLang = 'en';
    applyLanguage();
  </script>
</body>

</html>